




<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学小铺 - 智能笔记平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.37.12/build/docxtemplater.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip-utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            note: {
              blue: '#dbeafe',
              green: '#dcfce7',
              yellow: '#fef3c7',
              red: '#fee2e2',
              purple: '#f3e8ff'
            },
            vocab: {
                postgradHigh: '#bbf7d0', 
              postgradMid: '#dcfce7',  
              cet4: '#dbeafe',
              cet6: '#ede9fe',
              tem8: '#fce7f3'
            },
            dark: {
              bg: '#1e293b',
              card: '#334155',
              text: '#f8fafc'
            }
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .btn-tool { @apply p-2 rounded-md hover:bg-gray-100 transition-colors; }
      .note-tag { @apply px-2 py-1 rounded-full text-xs font-medium cursor-pointer; }
      .vocab-tag { @apply px-1 rounded border-b-2 cursor-help; }
      .vocab-postgradHigh { @apply bg-vocab-postgradHigh border-primary; }
      .vocab-postgradMid { @apply bg-vocab-postgradMid border-blue-400; }
      .vocab-cet4 { @apply bg-vocab-cet4 border-blue-500; }
      .vocab-cet6 { @apply bg-vocab-cet6 border-purple-500; }
      .vocab-tem8 { @apply bg-vocab-tem8 border-pink-500; }
      .translate-result { @apply bg-green-50 p-3 rounded my-2 text-sm border border-green-100; }
      .folder-active { @apply bg-blue-50 border-l-4 border-primary; }
      .top-btn { @apply px-3 py-2 rounded-md font-medium flex items-center gap-2 transition-colors text-sm; }
    }

    /* 深色模式样式 */
    .dark-mode {
      --bg-color: #1e293b;
      --card-color: #334155;
      --text-color: #f8fafc;
      --border-color: #475569;
      --hover-color: #475569;
    }
    
    .dark-mode body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    .dark-mode .bg-white {
      background-color: var(--card-color);
    }
    
    .dark-mode .text-gray-800 {
      color: var(--text-color);
    }
    
    .dark-mode .text-gray-600,
    .dark-mode .text-gray-500 {
      color: #cbd5e1;
    }
    
    .dark-mode .border-gray-200,
    .dark-mode .border-gray-100 {
      border-color: var(--border-color);
    }
    
    .dark-mode .hover:bg-gray-50,
    .dark-mode .hover:bg-gray-100 {
      background-color: var(--hover-color);
    }
    
     .dark-mode .vocab-postgradHigh {
      background-color: #065f46;
      color: #bbf7d0;
    }
    
      .dark-mode .vocab-postgradMid {
      background-color: #10b981;
      color: #dcfce7;
    }
    
    .dark-mode .vocab-cet4 {
      background-color: #1e40af;
      color: #dbeafe;
    }
    
    .dark-mode .vocab-cet6 {
      background-color: #5b21b6;
      color: #ede9fe;
    }
    
    .dark-mode .vocab-tem8 {
      background-color: #be185d;
      color: #fce7f3;
    }
    
    .dark-mode .translate-result {
      background-color: #065f46;
      border-color: #059669;
      color: #dcfce7;
    }

    /* 编辑器样式 */
    #editor {
      line-height: 1.6;
      outline: none;
      min-height: 500px;
      font-size: 16px;
      transition: font-size 0.3s ease;
    }
    
    .font-size-sm #editor { font-size: 14px; }
    .font-size-md #editor { font-size: 16px; }
    .font-size-lg #editor { font-size: 18px; }
    .font-size-xl #editor { font-size: 20px; }
    #editor p { margin: 0 0 1em 0; }

    /* 翻译弹窗 */
    #translatePopup {
      position: absolute;
      z-index: 100;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      padding: 12px;
      width: 320px;
      display: none;
    }

    /* 时间线样式 */
    .timeline-item {
      position: relative;
      padding-left: 24px;
    }
    .timeline-item:before {
      content: '';
      position: absolute;
      left: 6px;
      top: 6px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3b82f6;
    }
    .timeline-item:after {
      content: '';
      position: absolute;
      left: 10px;
      top: 14px;
      width: 1px;
      height: calc(100% + 10px);
      background: #e5e7eb;
    }
    .timeline-item:last-child:after { display: none; }

    /* 重点卡片样式 */
    .focus-card {
      border-left: 4px solid #3b82f6;
    }
    .focus-card.note-blue { border-left-color: #3b82f6; }
    .focus-card.note-yellow { border-left-color: #f59e0b; }
    .focus-card.note-green { border-left-color: #10b981; }
    .focus-card.note-red { border-left-color: #ef4444; }

    /* 语音控制样式 */
    .voice-controls {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .voice-selector {
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      font-size: 12px;
    }

    /* 界面设置面板 */
    #settingsPanel {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
    }
    #settingsPanel.open { right: 0; }
    .settings-section { margin-bottom: 25px; }
    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }
    .font-size-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .font-size-option {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }
    .font-size-option.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    /* 主题切换开关 */
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #3b82f6; }
    input:checked + .slider:before { transform: translateX(26px); }
    .theme-options {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    /* 弹窗样式 */
    .modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal.open {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.2s;
    }
    .modal-close:hover { color: #ef4444; }

    /* 格式选择弹窗 */
    .format-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    .format-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .format-option:hover {
      border-color: #3b82f6;
      background-color: #f9fafb;
    }
    .format-option.active {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    .format-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .format-txt .format-icon { color: #10b981; }
    .format-docx .format-icon { color: #3b82f6; }
    .format-pdf .format-icon { color: #ef4444; }
    .format-html .format-icon { color: #f59e0b; }

    /* 欢迎弹窗（修复关闭问题） */
    .welcome-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45); 
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999; /* 提高层级确保在最上层 */
      opacity: 1; 
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .welcome-modal:not(.open) {
      opacity: 0;
      visibility: hidden;
      pointer-events: none; 
    }
    .welcome-card {
      background: white;
      width: 95%;
      max-width: 820px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      position: relative;
      z-index: 10000; /* 确保卡片内容在最上层 */
    }
    .welcome-modal .top-btn {
      cursor: pointer;
      z-index: 10001;
      position: relative;
    }

    .img-placeholder {
      width:120px;
      height:80px;
      border:1px dashed #cbd5e1;
      display:inline-block;
      vertical-align:middle;
      margin-left:12px;
      background-size:cover;
      background-position:center;
    }

    /* 提示组件 */
    .card-library-tip {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #1f2937;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .card-library-tip.show {
      opacity: 1;
      visibility: visible;
    }
    .card-library-tip-icon { color: #fbbf24; font-size: 18px; }
    .card-library-tip-btn {
      margin-left: 12px;
      padding: 4px 8px;
      background-color: #3b82f6;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .card-library-tip-btn:hover { background-color: #2563eb; }

    /* 通知提示 */
    #notification {
      position: fixed;
      bottom: 4px;
      right: 4px;
      background: white;
      shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 6px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 9999;
      transform: translateY(120%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    #notification.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between flex-wrap gap-2">
      <div class="flex items-center space-x-2">
        <i class="fa fa-book text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-gray-800">学小铺｜智能笔记平台</h1>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <button id="settingsBtn" class="top-btn bg-gray-100 text-gray-700" 
        onclick="document.getElementById('settingsPanel').classList.add('open'); document.body.style.overflow='hidden';">
  <i class="fa fa-cog"></i> 设置
</button>
        <button id="focusCardsBtn" class="top-btn bg-purple-600 text-white">
          <i class="fa fa-flag"></i> 重点卡片库
        </button>
        <button id="backToDocsBtn" class="top-btn bg-gray-200 text-gray-700 hidden">
          <i class="fa fa-arrow-left"></i> 返回文件列表
        </button>
        <button id="downloadDocBtn" class="top-btn bg-amber-600 text-white">
          <i class="fa fa-download"></i> 下载文档
        </button>
        <label for="uploadDocBtn" class="top-btn bg-teal-600 text-white cursor-pointer">
          <i class="fa fa-upload"></i> 上传文档
        </label>
        <input type="file" id="uploadDocBtn" accept=".txt,.docx,.pdf,.html" class="hidden">
        <button id="downloadCardsBtn" class="top-btn bg-indigo-600 text-white">
          <i class="fa fa-download"></i> 卡片库下载
        </button>
        <button id="newDocBtn" class="top-btn bg-primary text-white">
          <i class="fa fa-file-o"></i> 新建文档
        </button>
        <button id="saveDocBtn" class="top-btn bg-green-600 text-white hidden">
          <i class="fa fa-save"></i> 保存到本地
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-6">
    <!-- 1. 文件列表视图 -->
    <div id="docsListView" class="block">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
          <h2 class="text-xl font-bold text-gray-800">我的文档</h2>
          <div class="text-sm text-gray-500">
            共 <span id="docsCount">0</span> 个临时文档
          </div>
        </div>
        <div class="mb-4">
          <div class="relative">
            <input type="text" id="searchDocs" class="w-full border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="搜索文档...">
            <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
          </div>
        </div>
        <div id="docsList" class="max-h-[600px] overflow-y-auto border border-gray-200 rounded-md">
          <div class="p-8 text-center text-gray-500">
            <i class="fa fa-file-text-o text-4xl mb-4 text-gray-300"></i>
            <p>暂无文档，点击"新建文档"开始创建或"上传文档"导入现有文档</p>
            <p class="mt-2 text-xs text-gray-400">提示：所有文档仅保存在当前浏览器会话中，关闭页面后将删除</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. 文档编辑视图 -->
    <div id="docEditView" class="hidden">
      <div class="mb-6">
        <input type="text" id="docTitle" class="w-full text-2xl font-bold border-none outline-none bg-transparent placeholder-gray-400" placeholder="输入文档标题（如：考研英语笔记）">
      </div>
      <div class="bg-white border-b border-gray-200 p-3 mb-6 rounded-lg">
        <div class="flex flex-wrap gap-2">
          <!-- 文本格式工具 -->
          <div class="flex items-center space-x-1">
            <button class="btn-tool" data-command="bold" title="加粗"><i class="fa fa-bold"></i></button>
            <button class="btn-tool" data-command="italic" title="斜体"><i class="fa fa-italic"></i></button>
            <button class="btn-tool" data-command="underline" title="下划线"><i class="fa fa-underline"></i></button>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          
          <!-- 笔记标签工具 -->
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">笔记标签：</span>
            <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200" data-tag="重点">重点</button>
            <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200" data-tag="疑问">疑问</button>
            <button class="note-tag bg-note-green text-green-800 hover:bg-green-200" data-tag="例题">例题</button>
            <button class="note-tag bg-note-red text-red-800 hover:bg-red-200" data-tag="易错">易错</button>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          
          <!-- 重点卡片工具 -->
          <button class="btn-tool bg-purple-100 text-purple-700 hover:bg-purple-200" id="addFocusCardBtn" title="添加到重点卡片库">
            <i class="fa fa-flag mr-1"></i> 转为重点卡片
          </button>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          
          <!-- 词汇标注工具 -->
          <div class="flex items-center space-x-2">
            <button class="btn-tool bg-blue-100 text-blue-700 hover:bg-blue-200" id="togglePostGradWords" title="考研词汇标注">
              <i class="fa fa-bookmark mr-1"></i> 考研词汇
            </button>
            <button class="btn-tool bg-blue-100 text-blue-700 hover:bg-blue-200" id="toggleCet4Words" title="CET4词汇标注">
              <i class="fa fa-bookmark mr-1"></i> CET4
            </button>
            <button class="btn-tool bg-purple-100 text-purple-700 hover:bg-purple-200" id="toggleCet6Words" title="CET6词汇标注">
              <i class="fa fa-bookmark mr-1"></i> CET6
            </button>
            <button class="btn-tool bg-pink-100 text-pink-700 hover:bg-pink-200" id="toggleTem8Words" title="TEM8词汇标注">
              <i class="fa fa-bookmark mr-1"></i> TEM8
            </button>
            <span class="text-sm text-gray-600" id="vocabStatus">词汇标注：全部开启</span>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          
          <!-- 时间线工具 -->
          <button class="btn-tool bg-purple-100 text-purple-700 hover:bg-purple-200" id="addTimelineBtn" title="添加课堂时间点">
            <i class="fa fa-clock-o mr-1"></i> 时间点
          </button>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          
          <!-- 翻译工具 -->
          <div class="flex items-center space-x-2">
            <button class="btn-tool" id="translateToggleBtn" title="翻译开关">
              <i class="fa fa-language text-primary"></i>
            </button>
            <span class="text-sm text-gray-600" id="translateStatus">翻译：开启（单词/句子）</span>
            <button class="btn-tool bg-green-100 text-green-700 hover:bg-green-200 ml-2" id="translateSentenceBtn" title="翻译选中的句子">
              <i class="fa fa-translate mr-1"></i>一键翻译
            </button>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          
          <!-- 文字转语音工具 -->
          <div class="voice-controls">
            <select id="voiceSelect" class="voice-selector">
              <option value="">选择语音</option>
            </select>
            <button class="btn-tool bg-rose-100 text-rose-700 hover:bg-rose-200" id="textToSpeechBtn" title="朗读选中的文本">
              <i class="fa fa-volume-up mr-1"></i> 开始朗读
            </button>
            <button class="btn-tool bg-rose-100 text-rose-700 hover:bg-rose-200 hidden" id="stopSpeechBtn" title="停止朗读">
              <i class="fa fa-volume-off mr-1"></i> 停止朗读
            </button>
          </div>
        </div>
      </div>
      <div class="flex gap-6 flex-wrap">
        <div class="relative flex-1 min-w-[300px]">
          <div id="translatePopup" class="absolute z-10">
            <div class="font-bold text-lg mb-1 flex justify-between">
              <span id="popupSource"></span>
              <span class="text-xs px-2 py-0.5 bg-gray-100 rounded" id="popupType">单词翻译</span>
            </div>
            <div class="text-sm text-gray-600 mb-2" id="popupPhonetic"></div>
            <div id="popupExplains" class="text-sm"></div>
            <div class="text-xs text-gray-500 mt-2" id="popupVocabNote"></div>
          </div>
          <div id="editor" class="bg-white rounded-lg p-6 min-h-[500px] focus:outline-none" contenteditable="true">
            <p>在这里开始记录笔记...<br><br>功能说明：<br>1. 英文单词/句子会自动翻译（选中即可查看）<br>2. 考研/CET/TEM词汇会自动标注（不同颜色背景）<br>3. 可添加重点卡片用于复习，支持文件夹分类<br>4. 可添加课堂时间点记录关键内容<br>5. 选中文字后点击"开始朗读"可进行文字转语音<br><br>提示：文档仅保存在当前浏览器会话中，关闭页面后将删除，请及时下载保存</p>
            <p><br>示例：The <span class="vocab vocab-postgradHigh" title="考研高频词：n. 能力，才能">ability</span> to <span class="vocab vocab-postgradHigh" title="考研高频词：v. 放弃，抛弃">abandon</span> old ideas is crucial for success.</p>
          </div>
        </div>
        <div class="w-64 bg-white rounded-lg p-4 shadow-sm flex-shrink-0">
          <h3 class="font-bold text-gray-800 mb-3 flex items-center">
            <i class="fa fa-bar-chart text-blue-500 mr-2"></i> 词汇统计
          </h3>
          <div class="text-sm space-y-4 max-h-[250px] overflow-y-auto mb-6">
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>总考研词汇数</span>
              <span id="totalPostgradCount" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>考研高频词汇</span>
              <span id="postgradHighCount" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>考研中频词汇</span>
              <span id="postgradMidCount" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>CET4词汇</span>
              <span id="cet4Count" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>CET6词汇</span>
              <span id="cet6Count" class="font-medium text-purple-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>TEM8词汇</span>
              <span id="tem8Count" class="font-medium text-pink-600">0</span>
            </div>
          </div>
          <h3 class="font-bold text-gray-800 mb-3 flex items-center">
            <i class="fa fa-history text-purple-500 mr-2"></i> 课堂时间线
          </h3>
          <div id="timelineContainer" class="text-sm space-y-4 max-h-[250px] overflow-y-auto">
            <div class="text-gray-500 text-center text-sm py-4">
              点击"时间点"添加课堂关键节点
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. 重点卡片库视图 -->
    <div id="focusCardsView" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
          <h2 class="text-xl font-bold text-gray-800">
            <i class="fa fa-flag text-purple-500 mr-2"></i>重点复习卡片库
          </h2>
          <div class="flex gap-2">
            <button id="addFolderBtn" class="top-btn bg-indigo-600 text-white">
              <i class="fa fa-folder mr-1"></i>新建文件夹
            </button>
            <button id="backFromCardsBtn" class="top-btn bg-secondary text-white">
              <i class="fa fa-arrow-left mr-2"></i>返回
            </button>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-6">
          <!-- 左侧文件夹列表 -->
          <div class="w-64 flex-shrink-0">
            <div class="bg-gray-50 rounded-lg p-4 h-full">
              <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-folder-open text-indigo-500 mr-2"></i> 文件夹
              </h3>
              <div class="space-y-1 mb-4">
                <div class="folder-item p-2 rounded hover:bg-gray-100 cursor-pointer flex items-center" data-id="all">
                  <i class="fa fa-folder-open-o text-gray-500 mr-2"></i>
                  <span>所有卡片</span>
                </div>
              </div>
              <div id="foldersList" class="space-y-1 max-h-[400px] overflow-y-auto">
                <div class="text-gray-500 text-sm italic p-2">暂无自定义文件夹</div>
              </div>
              <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md text-sm text-yellow-800">
                <i class="fa fa-info-circle mr-1"></i> 提示：卡片库数据仅临时存储，关闭页面前请下载保存
              </div>
            </div>
          </div>
          
          <!-- 右侧卡片内容区 -->
          <div class="flex-1">
            <div class="flex flex-wrap gap-3 mb-6">
              <div class="relative flex-1 max-w-md">
                <input type="text" id="searchCards" class="w-full border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="搜索重点卡片...">
                <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">筛选：</span>
                <button class="note-tag bg-gray-100 text-gray-800 hover:bg-gray-200 ring-2 ring-primary" data-filter="all">全部</button>
                <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200" data-filter="重点">重点</button>
                <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200" data-filter="疑问">疑问</button>
                <button class="note-tag bg-note-green text-green-800 hover:bg-green-200" data-filter="例题">例题</button>
                <button class="note-tag bg-note-red text-red-800 hover:bg-red-200" data-filter="易错">易错</button>
              </div>
            </div>
            
            <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="col-span-full p-12 text-center text-gray-500">
                <i class="fa fa-flag-o text-5xl mb-4 text-gray-300"></i>
                <p class="text-lg">暂无重点卡片</p>
                <p class="mt-2">在笔记中选中内容，点击"转为重点卡片"添加到这里</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 界面设置面板 -->
  <div id="settingsPanel">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold text-gray-800">界面设置</h2>
      <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-700"
        onclick="document.getElementById('settingsPanel').classList.remove('open'); document.body.style.overflow='';">
  <i class="fa fa-times text-xl"></i>
</button>
    </div>
    
    <div class="settings-section">
      <h3>主题模式</h3>
      <div class="theme-options">
        <span>浅色模式</span>
        <label class="theme-switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <span>深色模式</span>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>字体大小</h3>
      <p class="text-sm text-gray-500 mb-2">设置编辑器字体大小</p>
      <div class="font-size-options">
        <div class="font-size-option" data-size="sm">A</div>
        <div class="font-size-option active" data-size="md">A</div>
        <div class="font-size-option" data-size="lg">A</div>
        <div class="font-size-option" data-size="xl">A</div>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>语音设置</h3>
      <p class="text-sm text-gray-500 mb-2">默认语音速度</p>
      <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" 
             class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
      <div class="flex justify-between text-xs text-gray-500 mt-1">
        <span>慢速</span>
        <span>正常</span>
        <span>快速</span>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>功能设置</h3>
      <div class="space-y-3">
        <div class="flex items-center">
          <input type="checkbox" id="autoSaveToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoSaveToggle" class="ml-2 text-sm text-gray-700">自动保存笔记内容（临时）</label>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="autoTranslateToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoTranslateToggle" class="ml-2 text-sm text-gray-700">自动翻译英文内容</label>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="autoVocabToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoVocabToggle" class="ml-2 text-sm text-gray-700">自动标注词汇</label>
        </div>
      </div>
    </div>
  </div>

  <!-- 时间点添加弹窗 -->
  <div id="timelineModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-xl font-bold text-gray-800">添加课堂时间点</h3>
        <button class="modal-close" id="timelineModalClose">×</button>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">时间（如：45:30）</label>
        <input type="text" id="timelineTime" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="例如：30:15（分钟:秒）">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">内容描述</label>
        <input type="text" id="timelineContent" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="记录此时的课堂重点...">
      </div>
      <div class="flex justify-end">
        <button id="cancelTimeline" class="top-btn bg-gray-200 text-gray-700 mr-2">取消</button>
        <button id="confirmTimeline" class="top-btn bg-primary text-white">确认</button>
      </div>
    </div>
  </div>

  <!-- 文件夹弹窗 -->
  <div id="folderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-xl font-bold text-gray-800">新建文件夹</h3>
        <button class="modal-close" id="folderModalClose">×</button>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">文件夹名称</label>
        <input type="text" id="folderName" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="例如：考研英语高频词、数学公式">
      </div>
      <div class="flex justify-end">
        <button id="cancelFolder" class="top-btn bg-gray-200 text-gray-700 mr-2">取消</button>
        <button id="confirmFolder" class="top-btn bg-indigo-600 text-white">创建</button>
      </div>
    </div>
  </div>

  <!-- 卡片移动弹窗 -->
  <div id="moveCardModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-xl font-bold text-gray-800">移动到文件夹</h3>
        <button class="modal-close" id="moveCardModalClose">×</button>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">选择文件夹</label>
        <div id="folderSelectList" class="space-y-2 max-h-[200px] overflow-y-auto">
          <!-- 文件夹选项将动态生成 -->
        </div>
      </div>
      <div class="flex justify-end">
        <button id="cancelMoveCard" class="top-btn bg-gray-200 text-gray-700 mr-2">取消</button>
        <button id="confirmMoveCard" class="top-btn bg-primary text-white">确认移动</button>
      </div>
    </div>
  </div>

  <!-- 重点卡片编辑弹窗 -->
  <div id="cardModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="text-xl font-bold text-gray-800">编辑重点卡片</h3>
        <button class="modal-close" id="cardModalClose">×</button>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">卡片标题</label>
        <input type="text" id="cardTitle" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="给重点内容起个标题...">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">所属文件夹</label>
        <select id="cardFolderSelect" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="">-- 未分类 --</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">卡片类型</label>
        <div class="flex gap-2">
          <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200 card-type-btn" data-type="重点">重点</button>
          <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200 card-type-btn" data-type="疑问">疑问</button>
          <button class="note-tag bg-note-green text-green-800 hover:bg-green-200 card-type-btn" data-type="例题">例题</button>
          <button class="note-tag bg-note-red text-red-800 hover:bg-red-200 card-type-btn" data-type="易错">易错</button>
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">重点内容</label>
        <div id="cardContent" class="w-full border border-gray-300 rounded-md p-4 min-h-[100px]" contenteditable="true"></div>
      </div>
      <div class="flex justify-end">
        <button id="cancelCard" class="top-btn bg-gray-200 text-gray-700 mr-2">取消</button>
        <button id="confirmCard" class="top-btn bg-primary text-white">保存卡片</button>
      </div>
    </div>
  </div>

  <!-- 文档格式选择弹窗 -->
  <div id="formatModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>选择下载格式</h3>
        <button class="modal-close" id="formatModalClose">×</button>
      </div>
      <div class="format-options">
        <div class="format-option format-txt" data-format="txt">
          <i class="fa fa-file-text-o format-icon"></i>
          <span class="format-name">TXT 文本</span>
        </div>
        <div class="format-option format-docx" data-format="docx">
          <i class="fa fa-file-word-o format-icon"></i>
          <span class="format-name">DOCX 文档</span>
        </div>
        <div class="format-option format-pdf" data-format="pdf">
          <i class="fa fa-file-pdf-o format-icon"></i>
          <span class="format-name">PDF 文档</span>
        </div>
        <div class="format-option format-html" data-format="html">
          <i class="fa fa-file-code-o format-icon"></i>
          <span class="format-name">HTML 网页</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="top-btn bg-primary text-white" id="formatModalConfirm">确认下载</button>
      </div>
    </div>
  </div>

<!-- 欢迎弹窗 -->
<div id="welcomeModal" class="welcome-modal open">
  <div class="welcome-card" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="flex items-start gap-4 flex-wrap">
      <div style="flex:1; min-width:300px;">
        <div class="flex justify-between items-start">
          <h2 id="welcomeTitle" class="text-xl font-bold mb-2">欢迎进入 学小铺｜智能笔记平台</h2>
          <button id="closeWelcome" aria-label="关闭弹窗" class="top-btn bg-gray-200 text-gray-700">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <p class="text-sm text-gray-600 mb-3">功能提示：</p>
        <div class="text-sm text-gray-700 space-y-1 mb-4">
          <p>1. 选中文字可添加"重点/疑问/例题/易错"标签</p>
          <p>2. 选中重点内容点击"转为重点卡片"，可加入复习库</p>
          <p>3. 考研/CET4/CET6/TEM8词汇自动标注（不同颜色背景）</p>
          <p>4. 支持文件夹分类管理重点卡片，可下载备份</p>
          <p>5. 选中文字后点击"开始朗读"可进行文字转语音</p>
          <p>6. 英文单词/句子支持自动翻译，选中即可查看结果</p>
        </div>
        <div>
          <button id="closeWelcome2" class="top-btn bg-indigo-600 text-white">知道了，关闭</button>
        </div>
      </div>
     <div style="width:45%; text-align:center; flex-shrink:0;">
  <img src="https://raw.githubusercontent.com/xuexiaopu/learningnote/main/payment.png" 
       alt="学小铺智能笔记平台" 
       style="width:100%; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
</div>
    </div>
  </div>
</div>
  <!-- 重点卡片库提示 -->
  <div class="card-library-tip" id="cardLibraryTip">
    <i class="fa fa-exclamation-triangle card-library-tip-icon"></i>
    <span class="card-library-tip-text">重点卡片库数据将在关闭页面后删除，建议及时下载保存</span>
    <button class="card-library-tip-btn" id="tipDownloadBtn">立即下载</button>
  </div>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-4 right-4 bg-white shadow-lg rounded-md px-4 py-3 flex items-center">
    <i id="notificationIcon" class="fa fa-check-circle text-green-500 mr-2"></i>
    <span id="notificationText" class="text-gray-800"></span>
  </div>

  <script>
    // 全局变量
    let currentDocId = null;
    let docs = {}; // 仅内存存储，不持久化
    let focusCards = []; 
    let folders = []; 
    let isTranslateEnabled = true;
    let vocabSettings = {
      postgrad: true,
      cet4: true,
      cet6: true,
      tem8: true
    };
    let currentCardId = null;
    let currentFolderId = 'all';
    let detectedVocabs = {
      postgradHigh: new Set(),
      postgradMid: new Set(),
      cet4: new Set(),
      cet6: new Set(),
      tem8: new Set()
    };
    let vocabLib = {
      postgrad: [],
      cet4: [],
      cet6: [],
      tem8: []
    };
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let voices = [];
    let speechRate = 1;
    let selectedDownloadFormat = 'txt';

    // DOM元素
    const docsListView = document.getElementById('docsListView');
    const docEditView = document.getElementById('docEditView');
    const focusCardsView = document.getElementById('focusCardsView');
    const docsList = document.getElementById('docsList');
    const docsCount = document.getElementById('docsCount');
    const searchDocs = document.getElementById('searchDocs');
    const backToDocsBtn = document.getElementById('backToDocsBtn');
    const newDocBtn = document.getElementById('newDocBtn');
    const saveDocBtn = document.getElementById('saveDocBtn');
    const docTitle = document.getElementById('docTitle');
    const editor = document.getElementById('editor');
    const addFocusCardBtn = document.getElementById('addFocusCardBtn');
    const focusCardsBtn = document.getElementById('focusCardsBtn');
    const backFromCardsBtn = document.getElementById('backFromCardsBtn');
    const cardsContainer = document.getElementById('cardsContainer');
    const searchCards = document.getElementById('searchCards');
    const translatePopup = document.getElementById('translatePopup');
    const translateToggleBtn = document.getElementById('translateToggleBtn');
    const translateStatus = document.getElementById('translateStatus');
    const translateSentenceBtn = document.getElementById('translateSentenceBtn');
    const timelineContainer = document.getElementById('timelineContainer');
    const downloadDocBtn = document.getElementById('downloadDocBtn');
    const uploadDocBtn = document.getElementById('uploadDocBtn');
    const downloadCardsBtn = document.getElementById('downloadCardsBtn');
    const foldersList = document.getElementById('foldersList');
    const addFolderBtn = document.getElementById('addFolderBtn');
    const folderName = document.getElementById('folderName');
    const textToSpeechBtn = document.getElementById('textToSpeechBtn');
    const stopSpeechBtn = document.getElementById('stopSpeechBtn');
    const voiceSelect = document.getElementById('voiceSelect');
    const speechRateSlider = document.getElementById('speechRate');

    // 弹窗元素
    const modals = {
      timeline: document.getElementById('timelineModal'),
      folder: document.getElementById('folderModal'),
      moveCard: document.getElementById('moveCardModal'),
      card: document.getElementById('cardModal'),
      format: document.getElementById('formatModal'),
      welcome: document.getElementById('welcomeModal')
    };
    const modalCloseBtns = {
      timeline: document.getElementById('timelineModalClose'),
      folder: document.getElementById('folderModalClose'),
      moveCard: document.getElementById('moveCardModalClose'),
      card: document.getElementById('cardModalClose'),
      format: document.getElementById('formatModalClose'),
      welcome: document.getElementById('closeWelcome')
    };

    // 词汇统计元素
    const vocabCounters = {
      totalPostgrad: document.getElementById('totalPostgradCount'),
      postgradHigh: document.getElementById('postgradHighCount'),
      postgradMid: document.getElementById('postgradMidCount'),
      cet4: document.getElementById('cet4Count'),
      cet6: document.getElementById('cet6Count'),
      tem8: document.getElementById('tem8Count')
    };

    // 提示元素
    const cardLibraryTip = document.getElementById('cardLibraryTip');
    const tipDownloadBtn = document.getElementById('tipDownloadBtn');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    const notificationIcon = document.getElementById('notificationIcon');

    // 文档列表项点击事件处理（事件委托，解决新建文档后无法打开问题）
    function handleDocsListClick(e) {
      const docItem = e.target.closest('.doc-item');
      const deleteBtn = e.target.closest('.delete-doc');
      const downloadBtn = e.target.closest('.download-single-doc');
      
      if (!docItem) return; // 未点击到文档项，直接返回
      const docId = docItem.dataset.id;

      // 点击"删除文档"按钮
      if (deleteBtn) {
        e.stopPropagation(); // 阻止事件冒泡（避免同时触发打开文档）
        if (confirm('确定要删除此临时文档吗？')) {
          delete docs[docId];
          renderDocsList();
          showNotification('临时文档已删除', 'info');
        }
        return;
      }

      // 点击"下载文档"按钮
      if (downloadBtn) {
        e.stopPropagation(); // 阻止事件冒泡
        currentDocId = docId;
        openDoc(docId);
        showDocEditor();
        openFormatModal();
        return;
      }

      // 点击文档项本身（打开文档）
      openDoc(docId);
      showDocEditor();
    }

    // 初始化
    function init() {
      // 立即绑定欢迎弹窗关闭事件（修复关不掉的问题）
      const closeWelcome1 = document.getElementById('closeWelcome');
      const closeWelcome2 = document.getElementById('closeWelcome2');
      const welcomeModal = document.getElementById('welcomeModal');
      
      if (closeWelcome1) {
        closeWelcome1.addEventListener('click', () => {
          welcomeModal.classList.remove('open');
          document.body.style.overflow = '';
        });
      }
      
      if (closeWelcome2) {
        closeWelcome2.addEventListener('click', () => {
          welcomeModal.classList.remove('open');
          document.body.style.overflow = '';
        });
      }
      
      // 点击背景关闭
      if (welcomeModal) {
        welcomeModal.addEventListener('click', (e) => {
          if (e.target === welcomeModal) {
            welcomeModal.classList.remove('open');
            document.body.style.overflow = '';
          }
        });
      }

      // 原有的初始化代码
      loadVocabLib();
      loadVoices();
      initSettings();
      renderDocsList();
      renderFolders();
      bindEvents();
      showNotification('欢迎使用学小铺智能笔记平台！所有数据仅临时存储，关闭页面后删除', 'info');
      
      // 显示重点卡片库提示
      setTimeout(() => {
        cardLibraryTip.classList.add('show');
      }, 3000);
      
      // 页面关闭提示
      window.addEventListener('beforeunload', (e) => {
        e.preventDefault();
        e.returnValue = '所有临时数据将在关闭页面后删除，确定要离开吗？';
        return e.returnValue;
      });
    }
    
    // 新增：初始化时绑定文档列表事件委托
    docsList.addEventListener('click', handleDocsListClick);

    // 加载词汇库
    function loadVocabLib() {
      // 考研词汇（高频/中频）
      vocabLib.postgrad = [
        { word: "financial", freq: "high", pos: "adj.", mean: "金融的；财政的" },
        { word: "define", freq: "high", pos: "v.", mean: "界定；解释" },
        { word: "tolerance", freq: "mid", pos: "n.", mean: "忍受；宽容" },
        { word: "board", freq: "high", pos: "n./v.", mean: "董事会；上（船）" },
        { word: "blank", freq: "mid", pos: "adj./n.", mean: "空白的；空白" },
        { word: "gap", freq: "high", pos: "n.", mean: "间隙；差距" },
        { word: "environment", freq: "high", pos: "n.", mean: "环境" },
        { word: "claim", freq: "high", pos: "v./n.", mean: "声称；要求" },
        { word: "merit", freq: "mid", pos: "n./v.", mean: "优点；值得" },
        { word: "liberty", freq: "mid", pos: "n.", mean: "自由" },
        { word: "philosophy", freq: "mid", pos: "n.", mean: "哲学" },
        { word: "confused", freq: "high", pos: "adj.", mean: "困惑的" },
        { word: "quality", freq: "high", pos: "n./adj.", mean: "质量；优质的" },
        { word: "integrate", freq: "mid", pos: "v.", mean: "（使）合并" },
        { word: "mere", freq: "high", pos: "adj.", mean: "仅仅的" },
        { word: "urge", freq: "high", pos: "v./n.", mean: "催促；冲动" },
        { word: "literature", freq: "high", pos: "n.", mean: "文学；著作" },
        { word: "digital", freq: "high", pos: "adj.", mean: "数码的" },
        { word: "address", freq: "high", pos: "v./n.", mean: "处理；地址" },
        { word: "improve", freq: "high", pos: "v.", mean: "提高" }
      ];

      // CET4词汇
      vocabLib.cet4 = [
        { word: "ability", pos: "n.", mean: "能力，才能" },
        { word: "able", pos: "adj.", mean: "能够的，有能力的" },
        { word: "abroad", pos: "adv.", mean: "在国外，到国外" },
        { word: "absence", pos: "n.", mean: "缺席，不在场" },
        { word: "absolute", pos: "adj.", mean: "绝对的，完全的" },
        { word: "accept", pos: "v.", mean: "接受，认可" },
        { word: "access", pos: "n./v.", mean: "通道，进入；使用" },
        { word: "accident", pos: "n.", mean: "事故，意外" },
        { word: "accompany", pos: "v.", mean: "陪伴，陪同" },
        { word: "achieve", pos: "v.", mean: "达到，获得" }
      ];

      // CET6词汇
      vocabLib.cet6 = [
        { word: "abandon", pos: "v.", mean: "放弃，抛弃" },
        { word: "abdomen", pos: "n.", mean: "腹部" },
        { word: "abnormal", pos: "adj.", mean: "反常的，异常的" },
        { word: "abolish", pos: "v.", mean: "废除，取消" },
        { word: "abound", pos: "v.", mean: "大量存在，充满" },
        { word: "abroad", pos: "adv.", mean: "广泛地，到处" },
        { word: "abrupt", pos: "adj.", mean: "突然的，意外的" },
        { word: "absence", pos: "n.", mean: "缺乏，不存在" },
        { word: "absolute", pos: "adj.", mean: "专制的，独裁的" },
        { word: "absorb", pos: "v.", mean: "理解，掌握" }
      ];

      // TEM8词汇
      vocabLib.tem8 = [
        { word: "abjure", pos: "v.", mean: "发誓放弃，宣誓弃绝" },
        { word: "ablution", pos: "n.", mean: "沐浴，净身" },
        { word: "abnegation", pos: "n.", mean: "放弃，克制" },
        { word: "abominate", pos: "v.", mean: "痛恨，憎恶" },
        { word: "aboriginal", pos: "adj./n.", mean: "土著的；土著居民" },
        { word: "abortive", pos: "adj.", mean: "失败的，夭折的" },
        { word: "abrade", pos: "v.", mean: "磨损，擦伤" },
        { word: "abrogate", pos: "v.", mean: "废除，取消" },
        { word: "abstemious", pos: "adj.", mean: "节制的，节俭的" },
        { word: "abstain", pos: "v.", mean: "戒除，弃权" }
      ];
    }

    // 加载语音选项
    function loadVoices() {
      speechSynthesis.onvoiceschanged = () => {
        voices = speechSynthesis.getVoices();
        populateVoiceList();
      };
      voices = speechSynthesis.getVoices();
      populateVoiceList();
    }

    // 填充语音选择下拉框
    function populateVoiceList() {
      voiceSelect.innerHTML = '<option value="">选择语音</option>';
      const voiceGroups = {};

      voices.forEach(voice => {
        const langGroup = voice.lang.includes('zh') ? '中文语音' : 
                         voice.lang.includes('en') ? '英文语音' : '其他语音';
        if (!voiceGroups[langGroup]) voiceGroups[langGroup] = [];
        voiceGroups[langGroup].push(voice);
      });

      Object.keys(voiceGroups).forEach(group => {
        const optionGroup = document.createElement('optgroup');
        optionGroup.label = group;
        voiceSelect.appendChild(optionGroup);

        voiceGroups[group].forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.voiceURI;
          option.textContent = `${voice.name} (${voice.lang})`;
          optionGroup.appendChild(option);
        });
      });
    }

    // 初始化设置
    function initSettings() {
      // 默认设置
      const settings = {
        darkMode: false,
        fontSize: 'md',
        speechRate: 1,
        autoSave: true,
        autoTranslate: true,
        autoVocab: true
      };

      // 应用主题
      if (settings.darkMode) {
        document.documentElement.classList.add('dark-mode');
        document.getElementById('themeToggle').checked = true;
      }

      // 应用字体大小
      document.documentElement.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl');
      document.documentElement.classList.add(`font-size-${settings.fontSize}`);
      document.querySelectorAll('.font-size-option').forEach(option => {
        option.classList.toggle('active', option.dataset.size === settings.fontSize);
      });

      // 应用语音速度
      speechRate = settings.speechRate;
      speechRateSlider.value = settings.speechRate;

      // 应用功能开关
      document.getElementById('autoSaveToggle').checked = settings.autoSave;
      document.getElementById('autoTranslateToggle').checked = settings.autoTranslate;
      document.getElementById('autoVocabToggle').checked = settings.autoVocab;

      isTranslateEnabled = settings.autoTranslate;
      translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      updateVocabStatusText();
    }

    // 更新词汇标注状态文本
    function updateVocabStatusText() {
      const enabledTypes = [];
      if (vocabSettings.postgrad) enabledTypes.push('考研词汇');
      if (vocabSettings.cet4) enabledTypes.push('CET4');
      if (vocabSettings.cet6) enabledTypes.push('CET6');
      if (vocabSettings.tem8) enabledTypes.push('TEM8');
      
      document.getElementById('vocabStatus').textContent = 
        `词汇标注：${enabledTypes.length > 0 ? enabledTypes.join('、') + '开启' : '全部关闭'}`;
    }

    // 视图切换
    function showDocsList() {
      docsListView.classList.remove('hidden');
      docEditView.classList.add('hidden');
      focusCardsView.classList.add('hidden');
      backToDocsBtn.classList.add('hidden');
      saveDocBtn.classList.add('hidden');
      currentDocId = null;
    }

    function showDocEditor() {
      docsListView.classList.add('hidden');
      docEditView.classList.remove('hidden');
      focusCardsView.classList.add('hidden');
      backToDocsBtn.classList.remove('hidden');
      saveDocBtn.classList.remove('hidden');
      highlightAllVocabs();
      updateVocabStats();
    }

    function showFocusCards() {
      docsListView.classList.add('hidden');
      docEditView.classList.add('hidden');
      focusCardsView.classList.remove('hidden');
      renderFolders();
      renderFocusCards();
    }

    // 渲染文件列表
    function renderDocsList() {
      const docIds = Object.keys(docs);
      docsCount.textContent = docIds.length;

      if (docIds.length === 0) {
        docsList.innerHTML = `
          <div class="p-8 text-center text-gray-500">
            <i class="fa fa-file-text-o text-4xl mb-4 text-gray-300"></i>
            <p>暂无文档，点击"新建文档"开始创建或"上传文档"导入现有文档</p>
            <p class="mt-2 text-xs text-gray-400">提示：所有文档仅保存在当前浏览器会话中，关闭页面后将删除</p>
          </div>
        `;
        return;
      }

      const sortedIds = docIds.sort((a, b) => 
        new Date(docs[b].updatedAt).getTime() - new Date(docs[a].updatedAt).getTime()
      );

      let html = '';
      sortedIds.forEach(id => {
        const doc = docs[id];
        const date = new Date(doc.updatedAt).toLocaleString();
        html += `
          <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer doc-item" data-id="${id}">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-medium text-gray-800">${doc.title || '无标题文档'}</h3>
                <p class="text-sm text-gray-500 mt-1">最后编辑：${date}</p>
                <p class="text-xs text-gray-400 mt-2 line-clamp-1">${stripHtml(doc.content || '')}</p>
              </div>
              <div class="flex gap-2">
                <button class="text-blue-500 hover:text-blue-700 download-single-doc" data-id="${id}" title="下载文档">
                  <i class="fa fa-download"></i>
                </button>
                <button class="text-red-500 hover:text-red-700 delete-doc" data-id="${id}" title="删除文档">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });

      docsList.innerHTML = html;
      // 新增：绑定事件委托（每次渲染列表后重新绑定，确保新建文档生效）
      docsList.removeEventListener('click', handleDocsListClick); // 先移除旧绑定，避免重复
      docsList.addEventListener('click', handleDocsListClick);  
    }

    // 渲染文件夹列表
    function renderFolders() {
      if (folders.length === 0) {
        foldersList.innerHTML = '<div class="text-gray-500 text-sm italic p-2">暂无自定义文件夹</div>';
        updateFolderSelectors();
        return;
      }

      let html = '';
      folders.forEach(folder => {
        const cardCount = focusCards.filter(card => card.folderId === folder.id).length;
        html += `
          <div class="folder-item p-2 rounded hover:bg-gray-100 cursor-pointer flex items-center justify-between ${currentFolderId === folder.id ? 'folder-active' : ''}" data-id="${folder.id}">
            <div class="flex items-center">
              <i class="fa fa-folder-o text-indigo-500 mr-2"></i>
              <span>${folder.name}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-gray-200 px-1.5 rounded">${cardCount}</span>
              <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                <button class="text-gray-400 hover:text-red-500 delete-folder" data-id="${folder.id}">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });

      foldersList.innerHTML = html;

      // 文件夹切换事件
      document.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', () => {
          currentFolderId = item.dataset.id;
          document.querySelectorAll('.folder-item').forEach(i => i.classList.remove('folder-active'));
          item.classList.add('folder-active');
          renderFocusCards();
        });
      });

      // 删除文件夹事件
      document.querySelectorAll('.delete-folder').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const folderId = btn.dataset.id;
          const folder = folders.find(f => f.id === folderId);
          if (confirm(`确定要删除文件夹"${folder.name}"吗？文件夹内的卡片将移至未分类`)) {
            // 迁移卡片
            focusCards.forEach(card => {
              if (card.folderId === folderId) card.folderId = '';
            });
            // 删除文件夹
            folders = folders.filter(f => f.id !== folderId);
            // 更新视图
            if (currentFolderId === folderId) {
              currentFolderId = 'all';
              document.querySelector('.folder-item[data-id="all"]').classList.add('folder-active');
            }
            renderFolders();
            renderFocusCards();
            showNotification('文件夹已删除', 'info');
          }
        });
      });

      updateFolderSelectors();
    }

    // 更新文件夹选择器（卡片编辑/移动弹窗）
    function updateFolderSelectors() {
      const cardFolderSelect = document.getElementById('cardFolderSelect');
      const folderSelectList = document.getElementById('folderSelectList');
      
      // 清空现有选项
      cardFolderSelect.innerHTML = '<option value="">-- 未分类 --</option>';
      folderSelectList.innerHTML = '';

      // 添加文件夹选项
      folders.forEach(folder => {
        // 卡片编辑弹窗的下拉选项
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = folder.name;
        cardFolderSelect.appendChild(option);

        // 卡片移动弹窗的选项
        const div = document.createElement('div');
        div.className = 'p-2 border rounded hover:bg-gray-50 cursor-pointer flex items-center';
        div.innerHTML = `<i class="fa fa-folder-o text-indigo-500 mr-2"></i><span>${folder.name}</span>`;
        div.dataset.id = folder.id;
        folderSelectList.appendChild(div);

        // 移动弹窗选项点击事件
        div.addEventListener('click', () => {
          document.querySelectorAll('#folderSelectList > div').forEach(d => {
            d.classList.remove('ring-2', 'ring-primary');
          });
          div.classList.add('ring-2', 'ring-primary');
        });
      });
    }

    // 创建文件夹
    function createFolder() {
      const name = folderName.value.trim();
      if (!name) {
        showNotification('请输入文件夹名称', 'info');
        return;
      }
      if (folders.some(f => f.name === name)) {
        showNotification('文件夹名称已存在', 'info');
        return;
      }

      // 添加新文件夹
      folders.push({
        id: generateUUID(),
        name: name,
        createdAt: new Date().toISOString()
      });

      // 关闭弹窗并更新视图
      closeModal('folder');
      folderName.value = '';
      renderFolders();
      showNotification(`文件夹"${name}"已创建`, 'success');
    }

    // 渲染重点卡片库
    function renderFocusCards(filter = 'all', keyword = '') {
      // 按文件夹筛选
      let filteredCards = currentFolderId === 'all' 
        ? [...focusCards] 
        : focusCards.filter(card => card.folderId === currentFolderId);

      // 按类型筛选
      if (filter !== 'all') {
        filteredCards = filteredCards.filter(card => card.type === filter);
      }

      // 按关键词筛选
      if (keyword) {
        const kw = keyword.toLowerCase();
        filteredCards = filteredCards.filter(card => 
          card.title.toLowerCase().includes(kw) || 
          stripHtml(card.content).toLowerCase().includes(kw)
        );
      }

      // 无卡片时的提示
      if (filteredCards.length === 0) {
        cardsContainer.innerHTML = `
          <div class="col-span-full p-12 text-center text-gray-500">
            <i class="fa fa-flag-o text-5xl mb-4 text-gray-300"></i>
            <p class="text-lg">暂无符合条件的卡片</p>
            <p class="mt-2">尝试更换筛选条件或在笔记中添加新卡片</p>
          </div>
        `;
        return;
      }

      // 按创建时间排序（最新在前）
      filteredCards.sort((a, b) => 
        new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
      );

      // 生成卡片HTML
      let html = '';
      filteredCards.forEach(card => {
        const folder = folders.find(f => f.id === card.folderId);
        const folderName = folder ? folder.name : '未分类';
        const typeClass = getTypeClass(card.type);
        const date = new Date(card.createdAt).toLocaleString();

        html += `
          <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden focus-card ${typeClass}">
            <div class="p-4">
              <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-gray-800">${card.title}</h3>
                <div class="flex space-x-1">
                  <button class="text-gray-400 hover:text-blue-500 edit-card" data-id="${card.id}" title="编辑卡片">
                    <i class="fa fa-pencil"></i>
                  </button>
                  <button class="text-gray-400 hover:text-indigo-500 move-card" data-id="${card.id}" title="移动到文件夹">
                    <i class="fa fa-folder-open-o"></i>
                  </button>
                  <button class="text-gray-400 hover:text-red-500 delete-card" data-id="${card.id}" title="删除卡片">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="text-sm text-gray-600 mb-3">
                ${card.content}
              </div>
              <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                <span class="px-2 py-0.5 bg-gray-100 rounded-full">${card.type}</span>
                <span class="px-2 py-0.5 bg-gray-100 rounded-full">${folderName}</span>
                <span>${date}</span>
              </div>
            </div>
          </div>
        `;
      });

      cardsContainer.innerHTML = html;

      // 绑定卡片操作事件
      document.querySelectorAll('.edit-card').forEach(btn => {
        btn.addEventListener('click', () => openCardEditor(btn.dataset.id));
      });

      document.querySelectorAll('.delete-card').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const card = focusCards.find(c => c.id === id);
          if (confirm(`确定要删除卡片"${card.title}"吗？`)) {
            focusCards = focusCards.filter(c => c.id !== id);
            renderFocusCards();
            showNotification('重点卡片已删除', 'info');
          }
        });
      });

      document.querySelectorAll('.move-card').forEach(btn => {
        btn.addEventListener('click', () => {
          currentCardId = btn.dataset.id;
          document.querySelectorAll('#folderSelectList > div').forEach(d => {
            d.classList.remove('ring-2', 'ring-primary');
          });
          openModal('moveCard');
        });
      });
    }

    // 获取卡片类型对应的样式类
    function getTypeClass(type) {
      switch(type) {
        case '重点': return 'note-blue';
        case '疑问': return 'note-yellow';
        case '例题': return 'note-green';
        case '易错': return 'note-red';
        default: return 'note-blue';
      }
    }

    // 打开卡片编辑器
    function openCardEditor(id = null) {
      currentCardId = id;
      const card = focusCards.find(c => c.id === id) || {
        title: '',
        type: '重点',
        content: '',
        folderId: '',
        createdAt: new Date().toISOString()
      };

      // 填充表单数据
      document.getElementById('cardTitle').value = card.title;
      document.getElementById('cardContent').innerHTML = card.content;
      document.getElementById('cardFolderSelect').value = card.folderId || '';

      // 选中卡片类型
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-primary');
        if (btn.dataset.type === card.type) {
          btn.classList.add('ring-2', 'ring-primary');
        }
      });

      openModal('card');
    }

    // 保存重点卡片
    function saveFocusCard() {
      const title = document.getElementById('cardTitle').value.trim();
      const content = document.getElementById('cardContent').innerHTML.trim();
      const typeBtn = document.querySelector('.card-type-btn.ring-2');
      const folderId = document.getElementById('cardFolderSelect').value;

      // 验证表单
      if (!title) {
        showNotification('请输入卡片标题', 'info');
        return;
      }
      if (!content) {
        showNotification('请输入卡片内容', 'info');
        return;
      }
      if (!typeBtn) {
        showNotification('请选择卡片类型', 'info');
        return;
      }

      const cardData = {
        title: title,
        type: typeBtn.dataset.type,
        content: content,
        folderId: folderId,
        updatedAt: new Date().toISOString()
      };

      if (currentCardId) {
        // 更新现有卡片
        const index = focusCards.findIndex(c => c.id === currentCardId);
        if (index !== -1) {
          focusCards[index] = { ...focusCards[index], ...cardData };
        }
        showNotification('重点卡片已更新', 'success');
      } else {
        // 创建新卡片
        focusCards.push({
          id: generateUUID(),
          ...cardData,
          createdAt: new Date().toISOString()
        });
        showNotification('重点卡片已添加', 'success');
      }

      // 关闭弹窗并更新视图
      closeModal('card');
      renderFocusCards();
      cardLibraryTip.classList.add('show');
      setTimeout(() => cardLibraryTip.classList.remove('show'), 5000);
    }

    // 移动卡片到文件夹
    function moveCardToFolder() {
      if (!currentCardId) return;
      const selectedFolder = document.querySelector('#folderSelectList > div.ring-2');
      
      if (!selectedFolder) {
        showNotification('请选择目标文件夹', 'info');
        return;
      }

      const folderId = selectedFolder.dataset.id;
      const index = focusCards.findIndex(c => c.id === currentCardId);
      
      if (index !== -1) {
        focusCards[index].folderId = folderId;
        focusCards[index].updatedAt = new Date().toISOString();
        closeModal('moveCard');
        renderFocusCards();
        showNotification('卡片已移动到目标文件夹', 'success');
      }
    }

    // 新建文档
    function createNewDoc() {
      const id = generateUUID();
      docs[id] = {
        id: id,
        title: '未命名文档',
        content: `<p>在这里开始记录笔记...<br><br>功能说明：<br>1. 英文单词/句子会自动翻译（选中即可查看）<br>2. 考研/CET/TEM词汇会自动标注（不同颜色背景）<br>3. 可添加重点卡片用于复习，支持文件夹分类<br>4. 可添加课堂时间点记录关键内容<br>5. 选中文字后点击"开始朗读"可进行文字转语音<br><br>提示：文档仅保存在当前浏览器会话中，关闭页面后将删除，请及时下载保存</p>`,
        timeline: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      openDoc(id);
      showDocEditor();
      showNotification('已创建新文档（仅临时存储）', 'success');
    }

    // 打开文档
    function openDoc(id) {
      currentDocId = id;
      const doc = docs[id];
      if (!doc) return;
      
      docTitle.value = doc.title || '无标题文档';
      editor.innerHTML = doc.content || '';
      renderTimeline(doc.timeline || []);
    }

    // 保存文档（临时存储）
    function saveDoc() {
      if (!currentDocId || !docs[currentDocId]) return;
      
      docs[currentDocId].title = docTitle.value || '无标题文档';
      docs[currentDocId].content = editor.innerHTML;
      docs[currentDocId].updatedAt = new Date().toISOString();
      
      renderDocsList();
      showNotification('文档已临时保存', 'success');
    }

    // 自动保存文档
    function autoSaveDoc() {
      if (document.getElementById('autoSaveToggle').checked && currentDocId && docs[currentDocId]) {
        saveDoc();
      }
    }

    // 添加课堂时间点
    function addTimeline() {
      if (!currentDocId || !docs[currentDocId]) return;
      document.getElementById('timelineTime').value = '';
      document.getElementById('timelineContent').value = '';
      openModal('timeline');
      document.getElementById('timelineTime').focus();
    }

    // 确认添加时间点
    function confirmTimeline() {
      const time = document.getElementById('timelineTime').value.trim();
      const content = document.getElementById('timelineContent').value.trim();
      
      if (!time) {
        showNotification('请输入时间（格式：mm:ss）', 'info');
        return;
      }
      if (!content) {
        showNotification('请输入时间点对应的内容', 'info');
        return;
      }

      // 验证时间格式
      const timeRegex = /^\d{1,2}:\d{2}$/;
      if (!timeRegex.test(time)) {
        showNotification('时间格式错误，请输入"分钟:秒"（如：30:15）', 'info');
        return;
      }

      // 添加时间点
      if (!docs[currentDocId].timeline) docs[currentDocId].timeline = [];
      docs[currentDocId].timeline.push({
        id: generateUUID(),
        time: time,
        content: content,
        createdAt: new Date().toISOString()
      });

      // 按时间排序
      docs[currentDocId].timeline.sort((a, b) => 
        timeToSeconds(a.time) - timeToSeconds(b.time)
      );

      // 关闭弹窗并更新视图
      closeModal('timeline');
      renderTimeline(docs[currentDocId].timeline);
      showNotification('课堂时间点已添加', 'success');
    }

    // 渲染时间线
    function renderTimeline(timeline) {
      if (!timeline || timeline.length === 0) {
        timelineContainer.innerHTML = `
          <div class="text-gray-500 text-center text-sm py-4">
            点击"时间点"添加课堂关键节点
          </div>
        `;
        return;
      }

      let html = '';
      timeline.forEach(item => {
        html += `
          <div class="timeline-item py-2">
            <div class="font-medium text-blue-600">${item.time}</div>
            <div class="text-sm text-gray-600 mt-1">${item.content}</div>
            <button class="text-red-400 hover:text-red-600 text-xs mt-1 delete-timeline" data-id="${item.id}">
              <i class="fa fa-trash-o"></i> 删除
            </button>
          </div>
        `;
      });

      timelineContainer.innerHTML = html;

      // 删除时间点事件
      document.querySelectorAll('.delete-timeline').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          docs[currentDocId].timeline = docs[currentDocId].timeline.filter(item => item.id !== id);
          renderTimeline(docs[currentDocId].timeline);
          showNotification('时间点已删除', 'info');
        });
      });
    }

    // 时间转换为秒数（用于排序）
    function timeToSeconds(timeStr) {
      const [minutes, seconds] = timeStr.split(':').map(Number);
      return minutes * 60 + seconds;
    }

    // 高亮所有类型的词汇
    function highlightAllVocabs() {
      // 先移除现有标注
      removeAllVocabHighlights();
      
      // 只处理编辑器中的文本节点（排除已标注的节点）
      const textNodes = getTextNodes(editor);
      textNodes.forEach(node => {
        const text = node.nodeValue;
        const words = text.match(/[a-zA-Z]+/g) || [];
        
        words.forEach(word => {
          const lowerWord = word.toLowerCase();
          let vocabInfo = null;
          let vocabType = '';

          // 检查各类词汇库
          if (vocabSettings.postgrad) {
            vocabInfo = vocabLib.postgrad.find(v => v.word.toLowerCase() === lowerWord);
            if (vocabInfo) {
              vocabType = vocabInfo.freq === 'high' ? 'postgradHigh' : 'postgradMid';
            }
          }
          
          if (!vocabInfo && vocabSettings.cet4) {
            vocabInfo = vocabLib.cet4.find(v => v.word.toLowerCase() === lowerWord);
            if (vocabInfo) vocabType = 'cet4';
          }
          
          if (!vocabInfo && vocabSettings.cet6) {
            vocabInfo = vocabLib.cet6.find(v => v.word.toLowerCase() === lowerWord);
            if (vocabInfo) vocabType = 'cet6';
          }
          
          if (!vocabInfo && vocabSettings.tem8) {
            vocabInfo = vocabLib.tem8.find(v => v.word.toLowerCase() === lowerWord);
            if (vocabInfo) vocabType = 'tem8';
          }

          // 标注词汇
          if (vocabInfo && vocabType) {
            // 记录已检测的词汇
            detectedVocabs[vocabType].add(lowerWord);
            
            // 创建标注元素
            const regex = new RegExp(`\\b${word}\\b`, 'g');
            if (regex.test(text)) {
              const span = document.createElement('span');
              span.className = `vocab vocab-${vocabType}`;
              span.title = getVocabTitle(vocabType, vocabInfo);
              span.textContent = word;

              // 替换文本节点中的词汇
              const fragment = document.createDocumentFragment();
              let lastIndex = 0;
              text.replace(regex, (match, index) => {
                fragment.appendChild(document.createTextNode(text.substring(lastIndex, index)));
                fragment.appendChild(span.cloneNode(true));
                lastIndex = index + match.length;
              });
              fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
              
              node.parentNode.replaceChild(fragment, node);
            }
          }
        });
      });
    }

    // 获取词汇标题（鼠标悬浮显示）
    function getVocabTitle(vocabType, vocabInfo) {
      const typeMap = {
        postgradHigh: '考研高频词（绿色标注）',  
        postgradMid: '考研中频词（淡绿色标注）',
        cet4: 'CET4词汇',
        cet6: 'CET6词汇',
        tem8: 'TEM8词汇'
      };
      return `${typeMap[vocabType]}：${vocabInfo.pos} ${vocabInfo.mean}`;
    }

    // 移除所有词汇标注
    function removeAllVocabHighlights() {
      // 清空检测记录
      Object.keys(detectedVocabs).forEach(key => detectedVocabs[key].clear());
      
      // 移除标注元素
      document.querySelectorAll('.vocab').forEach(span => {
        const textNode = document.createTextNode(span.textContent);
        span.parentNode.replaceChild(textNode, span);
      });
    }

    // 更新词汇统计
    function updateVocabStats() {
      // 考研词汇统计
      const postgradHighCount = detectedVocabs.postgradHigh.size;
      const postgradMidCount = detectedVocabs.postgradMid.size;
      const totalPostgrad = postgradHighCount + postgradMidCount;

      // 更新DOM
      vocabCounters.totalPostgrad.textContent = totalPostgrad;
      vocabCounters.postgradHigh.textContent = postgradHighCount;
      vocabCounters.postgradMid.textContent = postgradMidCount;
      vocabCounters.cet4.textContent = detectedVocabs.cet4.size;
      vocabCounters.cet6.textContent = detectedVocabs.cet6.size;
      vocabCounters.tem8.textContent = detectedVocabs.tem8.size;
    }

    // 切换词汇标注开关
    function toggleVocabType(type) {
      vocabSettings[type] = !vocabSettings[type];
      updateVocabStatusText();
      
      // 重新标注
      highlightAllVocabs();
      updateVocabStats();
      
      const status = vocabSettings[type] ? '开启' : '关闭';
      const typeNameMap = {
        postgrad: '考研词汇标注',
        cet4: 'CET4词汇标注',
        cet6: 'CET6词汇标注',
        tem8: 'TEM8词汇标注'
      };
      showNotification(`${typeNameMap[type]}已${status}`, 'info');
    }

    // 切换翻译功能
    function toggleTranslate() {
      isTranslateEnabled = !isTranslateEnabled;
      // 同步设置面板的"自动翻译"复选框状态
      const autoTranslateToggle = document.getElementById('autoTranslateToggle');
      if (autoTranslateToggle) {
        autoTranslateToggle.checked = isTranslateEnabled;
      }
      translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      
      if (!isTranslateEnabled) {
        translatePopup.style.display = 'none';
      }
      
      showNotification(`翻译功能已${isTranslateEnabled ? '开启' : '关闭'}`, 'info');
    }

   // 翻译选中的文本（单词/句子）- 使用公开免费接口（有道demo+百度sug）
async function translateSelectedText() {
  const selection = window.getSelection();
  const text = selection.toString().trim();
  
  if (!text) {
    showNotification('请先选中要翻译的英文内容', 'info');
    return;
  }
  
  // 区分单词（仅字母）和句子（含空格/标点）
  const isWord = /^[a-zA-Z]+$/.test(text);
  showNotification(`正在${isWord ? '查询单词' : '翻译句子'}...`, 'info');

  try {
    let translationResult = '';
    let vocabInfo = null;

    // 1. 单词翻译：优先用百度sug接口（单词释义更全），失败用有道demo
    if (isWord) {
      try {
        // 百度sug公开接口（无需密钥，单词专用）
        const baiduRes = await fetch(`https://fanyi.baidu.com/sug?kw=${encodeURIComponent(text)}`);
        const baiduData = await baiduRes.json();
        
        if (baiduData.data && baiduData.data.length > 0) {
          const baiduWordData = baiduData.data[0];
          // 整理单词信息（音标+词性+释义）
          vocabInfo = {
            word: text,
            phonetic: baiduWordData.p || `/${text.toLowerCase()}/`, // 音标（无则默认显示单词小写）
            explains: baiduWordData.v ? baiduWordData.v.split('; ') : [baiduWordData.d], // 多释义拆分
            pos: baiduWordData.pos || 'n.' // 词性（无则默认名词）
          };
          // 构建翻译结果（分行显示音标+释义）
          translationResult = `${vocabInfo.phonetic}\n`;
          translationResult += vocabInfo.explains.map(exp => `- ${exp}`).join('\n');
        } else {
          throw new Error('百度单词接口无结果');
        }
      } catch (baiduErr) {
        // 百度失败，用有道demo接口兜底
        const youdaoRes = await fetch(`https://aidemo.youdao.com/trans?q=${encodeURIComponent(text)}&from=Auto&to=zh-CHS`);
        const youdaoData = await youdaoRes.json();
        
        // 提取有道单词信息
        vocabInfo = {
          word: text,
          phonetic: youdaoData.basic?.phonetic || `/${text.toLowerCase()}/`,
          explains: youdaoData.basic?.explains || [youdaoData.translation[0]],
          pos: youdaoData.basic?.parts?.[0]?.partOfSpeech || 'n.'
        };
        // 构建结果
        translationResult = `${vocabInfo.phonetic}\n`;
        translationResult += vocabInfo.explains.map(exp => `- ${exp}`).join('\n');
      }
    } 
    // 2. 句子翻译：用有道demo接口（公开免费，句子翻译更稳定）
    else {
      const youdaoRes = await fetch(`https://aidemo.youdao.com/trans?q=${encodeURIComponent(text)}&from=Auto&to=zh-CHS`);
      const youdaoData = await youdaoRes.json();
      
      if (youdaoData.translation && youdaoData.translation.length > 0) {
        translationResult = youdaoData.translation[0];
      } else {
        throw new Error('句子翻译无结果，请检查网络');
      }
    }

    // 根据类型显示结果（单词→悬停弹窗，句子→插入文档）
    if (isWord) {
      showTranslatePopup(selection.getRangeAt(0), text, translationResult, vocabInfo);
    } else {
      insertTranslationToDoc(translationResult);
    }
    showNotification(`${isWord ? '单词查询' : '句子翻译'}完成`, 'success');
  } catch (error) {
    showNotification(`翻译失败：${error.message}`, 'error');
    console.error('翻译错误详情:', error);
  }
}
   // 显示翻译弹窗（优化排版+防错位+内容换行）
function showTranslatePopup(range, sourceText, translation, vocabInfo) {
  if (!isTranslateEnabled) return;
  
  // 1. 设置弹窗基础内容
  document.getElementById('popupSource').textContent = sourceText; // 原单词
  document.getElementById('popupType').textContent = vocabInfo ? '单词详解' : '句子翻译'; // 类型标签
  document.getElementById('popupPhonetic').textContent = vocabInfo ? vocabInfo.phonetic : ''; // 音标（仅单词显示）
  
  // 2. 处理翻译结果换行（避免内容挤在一起）
  const explainsHtml = translation.split('\n').map(line => {
    // 给每一行添加样式，优化可读性
    return `<p class="mb-1 leading-tight">${line}</p>`;
  }).join('');
  document.getElementById('popupExplains').innerHTML = explainsHtml; // 替换原纯文本显示为HTML换行显示
  
  // 3. 显示词汇类型（考研/CET4等，匹配原代码的词汇库）
  if (vocabInfo) {
    let vocabType = '';
    // 检查当前单词属于哪个词汇库（考研/CET4/CET6/TEM8）
    const lowerWord = sourceText.toLowerCase();
    if (vocabLib.postgrad.some(v => v.word.toLowerCase() === lowerWord)) {
      vocabType = '考研词汇';
    } else if (vocabLib.cet4.some(v => v.word.toLowerCase() === lowerWord)) {
      vocabType = 'CET4词汇';
    } else if (vocabLib.cet6.some(v => v.word.toLowerCase() === lowerWord)) {
      vocabType = 'CET6词汇';
    } else if (vocabLib.tem8.some(v => v.word.toLowerCase() === lowerWord)) {
      vocabType = 'TEM8词汇';
    }
    document.getElementById('popupVocabNote').textContent = vocabType ? `词汇类型：${vocabType}` : '';
  } else {
    document.getElementById('popupVocabNote').textContent = '';
  }
  
  // 4. 优化弹窗定位（避免超出编辑器范围，解决"弹窗看不见"问题）
  const rect = range.getBoundingClientRect(); // 选中内容的位置信息
  const editorRect = editor.getBoundingClientRect(); // 编辑器的位置信息
  const popupWidth = 320; // 弹窗固定宽度（原代码定义）
  const popupHeight = translatePopup.offsetHeight || 150; // 弹窗高度（动态获取或默认）
  
  // 水平定位：如果右侧超出编辑器，就左对齐；否则右对齐
  let left = rect.right - editorRect.left + editor.scrollLeft;
  if (left + popupWidth > editorRect.width) {
    left = rect.left - editorRect.left + editor.scrollLeft - popupWidth;
  }
  
  // 垂直定位：如果下方超出编辑器，就上对齐；否则下对齐
  let top = rect.bottom - editorRect.top + editor.scrollTop + 10; // 原位置（下方10px）
  if (top + popupHeight > editorRect.height) {
    top = rect.top - editorRect.top + editor.scrollTop - popupHeight - 10; // 调整为上方
  }
  
  // 应用定位并显示弹窗
  translatePopup.style.left = `${left}px`;
  translatePopup.style.top = `${top}px`;
  translatePopup.style.display = 'block';
  translatePopup.style.maxHeight = '300px'; // 限制最大高度，避免过长
  translatePopup.style.overflowY = 'auto'; // 内容过长时显示滚动条
  
  // 5. 点击其他区域关闭弹窗（原逻辑保留，优化兼容性）
  document.addEventListener('click', hideTranslatePopup, { once: true });
}
    // 隐藏翻译弹窗
    function hideTranslatePopup(e) {
      if (!translatePopup.contains(e.target)) {
        translatePopup.style.display = 'none';
      } else {
        // 点击弹窗内部时重新绑定关闭事件
        document.addEventListener('click', hideTranslatePopup, { once: true });
      }
    }

    // 插入句子翻译结果到文档
    function insertTranslationToDoc(translation) {
      const selection = window.getSelection();
      const range = selection.getRangeAt(0);
      
      // 创建翻译结果元素
      const resultDiv = document.createElement('div');
      resultDiv.className = 'translate-result';
      resultDiv.innerHTML = `<strong>翻译结果：</strong>${translation}`;

      // 插入到选中内容后方
      range.collapse(false);
      range.insertNode(resultDiv);
      range.insertNode(document.createElement('br'));
      range.collapse(false);
    }

    // 文字转语音
    function textToSpeech() {
      // 停止现有朗读
      if (speechSynthesis.speaking) {
        stopSpeech();
        return;
      }

      const selection = window.getSelection();
      const text = selection.toString().trim();
      
      if (!text) {
        showNotification('请先选中要朗读的文本', 'info');
        return;
      }

      // 创建语音实例
      currentUtterance = new SpeechSynthesisUtterance(text);
      
      // 选择语音（优先用户选择的语音）
      const selectedVoiceURI = voiceSelect.value;
      if (selectedVoiceURI) {
        const selectedVoice = voices.find(v => v.voiceURI === selectedVoiceURI);
        if (selectedVoice) currentUtterance.voice = selectedVoice;
      } else {
        // 自动匹配语言
        const isChinese = /[\u4e00-\u9fa5]/.test(text);
        currentUtterance.lang = isChinese ? 'zh-CN' : 'en-US';
        
        // 优先选择匹配语言的语音
        const preferredVoice = voices.find(v => 
          (isChinese && v.lang.includes('zh')) || 
          (!isChinese && v.lang.includes('en'))
        );
        if (preferredVoice) currentUtterance.voice = preferredVoice;
      }

      // 设置语音参数
      currentUtterance.rate = speechRate;
      currentUtterance.pitch = 1.1; // 音调略高，更自然
      currentUtterance.volume = 1;

      // 朗读结束回调
      currentUtterance.onend = () => {
        stopSpeechBtn.classList.add('hidden');
        textToSpeechBtn.classList.remove('hidden');
        showNotification('朗读已完成', 'info');
      };

      // 开始朗读
      speechSynthesis.speak(currentUtterance);
      stopSpeechBtn.classList.remove('hidden');
      textToSpeechBtn.classList.add('hidden');
      showNotification('开始朗读...', 'info');
    }

    // 停止朗读
    function stopSpeech() {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      currentUtterance = null;
      stopSpeechBtn.classList.add('hidden');
      textToSpeechBtn.classList.remove('hidden');
      showNotification('已停止朗读', 'info');
    }

    // 下载文档（支持多格式）
    function downloadDocument() {
      if (!currentDocId || !docs[currentDocId]) {
        showNotification('请先打开一个文档', 'info');
        return;
      }

      const doc = docs[currentDocId];
      const title = doc.title || '未命名文档';
      const content = doc.content || '';
      const plainText = stripHtml(content);

      // 根据选择的格式下载
      switch(selectedDownloadFormat) {
        case 'txt':
          downloadAsTxt(title, plainText);
          break;
        case 'docx':
          downloadAsDocx(title, plainText);
          break;
        case 'pdf':
          downloadAsPdf(title, plainText);
          break;
        case 'html':
          downloadAsHtml(title, content);
          break;
      }

      closeModal('format');
      showNotification(`文档已以${getFormatName(selectedDownloadFormat)}格式下载`, 'success');
    }

    // 下载为TXT
    function downloadAsTxt(title, content) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      saveAs(blob, `${title}.txt`);
    }

    // 下载为DOCX
    function downloadAsDocx(title, content) {
      try {
        // 使用docxtemplater生成DOCX
        const zip = new PizZip();
        zip.file('word/document.xml', `
          <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
            <w:body>
              <w:p>
                <w:r>
                  <w:t>${title}</w:t>
                </w:r>
              </w:p>
              <w:p>
                <w:r>
                  <w:t>${content.replace(/\n/g, '</w:t></w:r></w:p><w:p><w:r><w:t>')}</w:t>
                </w:r>
              </w:p>
            </w:body>
          </w:document>
        `);

        const doc = new window.docxtemplater();
        doc.loadZip(zip);
        doc.setOptions({ paragraphLoop: true, linebreaks: true });
        doc.render();

        const out = doc.getZip().generate({
          type: 'blob',
          mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        });

        saveAs(out, `${title}.docx`);
      } catch (error) {
        console.error('DOCX生成错误:', error);
        showNotification('DOCX格式下载失败，建议尝试其他格式', 'error');
        downloadAsTxt(title, content); // 降级为TXT下载
      }
    }

    // 下载为PDF（简化版，基于HTML）
    function downloadAsPdf(title, content) {
      const html = `
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <title>${title}</title>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; padding: 40px; max-width: 800px; margin: 0 auto; }
            h1 { color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 30px; }
            p { margin-bottom: 16px; color: #374151; }
          </style>
        </head>
        <body>
          <h1>${title}</h1>
          <p>${content.replace(/\n/g, '</p><p>')}</p>
        </body>
        </html>
      `;

      // 创建临时iframe用于PDF生成
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      
      iframe.contentDocument.open();
      iframe.contentDocument.write(html);
      iframe.contentDocument.close();
      
      // 触发打印（用户可手动选择PDF保存）
      setTimeout(() => {
        iframe.contentWindow.print();
        document.body.removeChild(iframe);
      }, 500);
    }

    // 下载为HTML
    function downloadAsHtml(title, content) {
      const html = `
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${title}</title>
          <style>
            body { font-family: Inter, system-ui, sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: 0 auto; background: #f9fafb; }
            .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            h1 { color: #3b82f6; margin-bottom: 30px; }
            .vocab { padding: 0 3px; border-radius: 3px; }
            .vocab-postgradHigh { background: #dbeafe; border-bottom: 2px solid #3b82f6; }
            .vocab-postgradMid { background: #eff6ff; border-bottom: 2px solid #93c5fd; }
            .vocab-cet4 { background: #dbeafe; border-bottom: 2px solid #3b82f6; }
            .vocab-cet6 { background: #ede9fe; border-bottom: 2px solid #a855f7; }
            .vocab-tem8 { background: #fce7f3; border-bottom: 2px solid #db2777; }
            .translate-result { background: #dcfce7; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #22c55e; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>${title}</h1>
            <div>${content}</div>
          </div>
        </body>
        </html>
      `;

      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      saveAs(blob, `${title}.html`);
    }

    // 下载重点卡片库
    function downloadFocusCards() {
      if (focusCards.length === 0) {
        showNotification('重点卡片库为空，无需下载', 'info');
        return;
      }

      // 准备下载数据（包含文件夹结构）
      const exportData = {
        exportTime: new Date().toISOString(),
        folders: folders,
        cards: focusCards.map(card => ({
          ...card,
          from: '学小铺智能笔记平台'
        }))
      };

      const jsonStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
      saveAs(blob, `学小铺重点卡片库_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`);

      showNotification('重点卡片库已下载', 'success');
      cardLibraryTip.classList.remove('show');
    }

    // 上传文档
    function uploadDocument(e) {
      const file = e.target.files[0];
      if (!file) return;

      const fileName = file.name.replace(/\.[^/.]+$/, "");
      const fileExt = file.name.split('.').pop().toLowerCase();
      const reader = new FileReader();

      // 根据文件类型处理
      switch(fileExt) {
        case 'txt':
          reader.onload = function(e) {
            const content = e.target.result;
            addUploadedDoc(fileName, `<p>${content.replace(/\n/g, '</p><p>')}</p>`);
          };
          reader.readAsText(file);
          break;
        
        case 'docx':
          reader.onload = function(e) {
            try {
              // 解析DOCX内容
              const zip = new PizZip(e.target.result);
              const xmlContent = zip.file('word/document.xml').asText();
              const text = xmlContent
                .replace(/<[^>]+>/g, ' ')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/\s+/g, ' ')
                .trim();
              
              addUploadedDoc(fileName, `<p>${text.replace(/\n/g, '</p><p>')}</p>`);
            } catch (error) {
              console.error('DOCX解析错误:', error);
              showNotification('DOCX文件解析失败，请尝试其他格式', 'error');
            }
          };
          reader.readAsArrayBuffer(file);
          break;
        
        case 'html':
          reader.onload = function(e) {
            addUploadedDoc(fileName, e.target.result);
          };
          reader.readAsText(file);
          break;
        
        default:
          showNotification(`不支持的文件格式：${fileExt}（仅支持TXT/DOCX/HTML）`, 'error');
      }

      // 重置文件输入
      e.target.value = '';
    }

    // 添加上传的文档到列表
    function addUploadedDoc(title, content) {
      const id = generateUUID();
      docs[id] = {
        id: id,
        title: title,
        content: content,
        timeline: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      renderDocsList();
      showNotification(`文档"${title}"已上传`, 'success');
    }

    // 打开格式选择弹窗
    function openFormatModal() {
      // 重置选中状态
      document.querySelectorAll('.format-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.format === selectedDownloadFormat) {
          option.classList.add('active');
        }
      });
      openModal('format');
    }

    // 选择下载格式
    function selectDownloadFormat(format) {
      selectedDownloadFormat = format;
      document.querySelectorAll('.format-option').forEach(option => {
        option.classList.toggle('active', option.dataset.format === format);
      });
    }

    // 打开弹窗
    function openModal(modalKey) {
      if (modals[modalKey]) {
        modals[modalKey].classList.add('open');
        // 阻止背景滚动
        document.body.style.overflow = 'hidden';
      }
    }

    // 关闭弹窗
   function closeModal(modalKey) {
  if (modals[modalKey]) {
    modals[modalKey].classList.remove('open');
    document.body.style.overflow = '';
  }
  // 新增：强制处理欢迎弹窗（防止modals对象引用失效）
  if (modalKey === 'welcome') {
    const welcomeModal = document.getElementById('welcomeModal');
    if (welcomeModal) {
      welcomeModal.classList.remove('open');
      document.body.style.overflow = '';
    }
  }
}

    // 显示通知
    function showNotification(text, type = 'info') {
      notificationText.textContent = text;
      
      // 设置通知图标
      notificationIcon.className = type === 'success'
        ? 'fa fa-check-circle text-green-500 mr-2'
        : type === 'error'
          ? 'fa fa-exclamation-circle text-red-500 mr-2'
          : 'fa fa-info-circle text-blue-500 mr-2';
      
      // 显示通知
      notification.classList.add('show');
      
      // 3秒后隐藏
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // 生成UUID
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    // 去除HTML标签
    function stripHtml(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || div.innerText || '';
    }

    // 获取文本节点（排除已标注的节点）
    function getTextNodes(element) {
      const textNodes = [];
      const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        node => {
          // 排除已标注的节点和空文本
          const parent = node.parentNode;
          if (parent.classList && parent.classList.contains('vocab')) return NodeFilter.FILTER_SKIP;
          if (node.nodeValue.trim() === '') return NodeFilter.FILTER_SKIP;
          return NodeFilter.FILTER_ACCEPT;
        },
        false
      );

      let node;
      while ((node = walker.nextNode())) {
        textNodes.push(node);
      }
      return textNodes;
    }

    // 获取格式名称
    function getFormatName(format) {
      const formatMap = {
        'txt': 'TXT文本',
        'docx': 'Word文档',
        'pdf': 'PDF文档',
        'html': 'HTML网页'
      };
      return formatMap[format] || format;
    }

    // 绑定所有事件
    function bindEvents() {
      // 视图切换事件
      backToDocsBtn.addEventListener('click', showDocsList);
      newDocBtn.addEventListener('click', createNewDoc);
      saveDocBtn.addEventListener('click', saveDoc);
      focusCardsBtn.addEventListener('click', showFocusCards);
      backFromCardsBtn.addEventListener('click', () => currentDocId ? showDocEditor() : showDocsList());

      // 文本格式工具事件
      document.querySelectorAll('[data-command]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.execCommand(btn.dataset.command, false, null);
          editor.focus();
        });
      });

      // 笔记标签事件
      document.querySelectorAll('.note-tag[data-tag]').forEach(btn => {
        btn.addEventListener('click', () => {
          const selection = window.getSelection();
          if (!selection.rangeCount) {
            showNotification('请先选中要标记的内容', 'info');
            return;
          }

          const tag = btn.dataset.tag;
          const range = selection.getRangeAt(0);
          if (range.collapsed) {
            showNotification('请选中非空内容', 'info');
            return;
          }

          // 创建标签元素
          const span = document.createElement('span');
          span.className = `note-highlight ${btn.className.split(' ').find(c => c.startsWith('bg-note-'))}`;
          span.textContent = range.extractContents();
          span.title = `点击取消"${tag}"标记`;

          // 插入标签元素
          range.insertNode(span);
          selection.removeAllRanges();

          // 取消标记事件
          span.addEventListener('click', (e) => {
            e.stopPropagation();
            const parent = span.parentNode;
            while (span.firstChild) {
              parent.insertBefore(span.firstChild, span);
            }
            parent.removeChild(span);
          });

          editor.focus();
        });
      });

      // 重点卡片相关事件
      addFocusCardBtn.addEventListener('click', () => {
        const selection = window.getSelection();
        const content = selection.toString().trim();
        if (!content) {
          showNotification('请先选中要添加为重点的内容', 'info');
          return;
        }

        // 自动生成标题
        const title = content.length > 20 
          ? content.substring(0, 20) + '...' 
          : content;

        // 打开卡片编辑器
        currentCardId = null;
        document.getElementById('cardTitle').value = title;
        document.getElementById('cardContent').innerHTML = getSelectionHtml();
        document.getElementById('cardFolderSelect').value = '';
        
        // 选中"重点"类型
        document.querySelectorAll('.card-type-btn').forEach(btn => {
          btn.classList.remove('ring-2', 'ring-primary');
          if (btn.dataset.type === '重点') {
            btn.classList.add('ring-2', 'ring-primary');
          }
        });

        openModal('card');
      });

      document.getElementById('confirmCard').addEventListener('click', saveFocusCard);
      document.getElementById('cancelCard').addEventListener('click', () => closeModal('card'));

      // 卡片类型选择事件
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.card-type-btn').forEach(b => {
            b.classList.remove('ring-2', 'ring-primary');
          });
          btn.classList.add('ring-2', 'ring-primary');
        });
      });

      // 文件夹相关事件
      addFolderBtn.addEventListener('click', () => openModal('folder'));
      document.getElementById('confirmFolder').addEventListener('click', createFolder);
      document.getElementById('cancelFolder').addEventListener('click', () => closeModal('folder'));

      // 卡片移动事件
      document.getElementById('confirmMoveCard').addEventListener('click', moveCardToFolder);
      document.getElementById('cancelMoveCard').addEventListener('click', () => closeModal('moveCard'));

      // 时间线相关事件
      addTimelineBtn.addEventListener('click', addTimeline);
      document.getElementById('confirmTimeline').addEventListener('click', confirmTimeline);
      document.getElementById('cancelTimeline').addEventListener('click', () => closeModal('timeline'));

      // 翻译相关事件
      translateToggleBtn.addEventListener('click', toggleTranslate);
      translateSentenceBtn.addEventListener('click', translateSelectedText);
   // 编辑器选中事件：仅单词触发悬停翻译，句子需手动点击"一键翻译"
editor.addEventListener('mouseup', async (e) => {
  if (!isTranslateEnabled) return; // 翻译关闭时不触发
  
  const selection = window.getSelection();
  const text = selection.toString().trim();
  
  // 只处理：①含英文 ②长度1-50字符（避免过长内容） ③单词（仅字母）
  if (text && /[a-zA-Z]/.test(text) && text.length <= 50 && /^[a-zA-Z]+$/.test(text)) {
    await translateSelectedText(); // 触发单词翻译（显示悬停弹窗）
  } else {
    translatePopup.style.display = 'none'; // 非单词时关闭弹窗
  }
});

      // 词汇标注开关事件
      document.getElementById('togglePostGradWords').addEventListener('click', () => toggleVocabType('postgrad'));
      document.getElementById('toggleCet4Words').addEventListener('click', () => toggleVocabType('cet4'));
      document.getElementById('toggleCet6Words').addEventListener('click', () => toggleVocabType('cet6'));
      document.getElementById('toggleTem8Words').addEventListener('click', () => toggleVocabType('tem8'));

      // 编辑器内容变化事件
      editor.addEventListener('input', debounce(() => {
        autoSaveDoc();
        highlightAllVocabs();
        updateVocabStats();
      }, 1000));

      // 文档标题变化事件
      docTitle.addEventListener('input', debounce(autoSaveDoc, 1000));

      // 搜索文档事件
      searchDocs.addEventListener('input', debounce(() => {
        const keyword = searchDocs.value.toLowerCase();
        document.querySelectorAll('.doc-item').forEach(item => {
          const title = item.querySelector('h3').textContent.toLowerCase();
          const content = item.querySelector('p.text-xs').textContent.toLowerCase();
          item.style.display = title.includes(keyword) || content.includes(keyword) ? '' : 'none';
        });
      }, 300));

      // 搜索卡片事件
      searchCards.addEventListener('input', debounce(() => {
        const filter = document.querySelector('.note-tag[data-filter].ring-2')?.dataset.filter || 'all';
        renderFocusCards(filter, searchCards.value);
      }, 300));

      // 卡片筛选事件
      document.querySelectorAll('.note-tag[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.note-tag[data-filter]').forEach(b => {
            b.classList.remove('ring-2', 'ring-primary');
          });
          btn.classList.add('ring-2', 'ring-primary');
          renderFocusCards(btn.dataset.filter, searchCards.value);
        });
      });

      // 语音相关事件
      textToSpeechBtn.addEventListener('click', textToSpeech);
      stopSpeechBtn.addEventListener('click', stopSpeech);
      speechRateSlider.addEventListener('input', () => {
        speechRate = parseFloat(speechRateSlider.value);
        if (currentUtterance) {
          currentUtterance.rate = speechRate;
        }
      });

      // 文档下载相关事件
      downloadDocBtn.addEventListener('click', () => {
        if (currentDocId && docs[currentDocId]) {
          openFormatModal();
        } else {
          showNotification('请先打开一个文档', 'info');
        }
      });

      // 格式选择事件
      document.querySelectorAll('.format-option').forEach(option => {
        option.addEventListener('click', () => selectDownloadFormat(option.dataset.format));
      });
      document.getElementById('formatModalConfirm').addEventListener('click', downloadDocument);

      // 卡片库下载事件
      downloadCardsBtn.addEventListener('click', downloadFocusCards);
      tipDownloadBtn.addEventListener('click', downloadFocusCards);

      // 文档上传事件
      uploadDocBtn.addEventListener('change', uploadDocument);

      // 弹窗关闭事件
      Object.keys(modalCloseBtns).forEach(key => {
        if (modalCloseBtns[key]) {
          modalCloseBtns[key].addEventListener('click', () => closeModal(key));
        }
      });

      // 点击弹窗背景关闭
      Object.values(modals).forEach(modal => {
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              const key = Object.keys(modals).find(k => modals[k] === modal);
              closeModal(key);
            }
          });
        }
      });

      // 欢迎弹窗图片替换
      document.getElementById('welcomeImagePlaceholder').addEventListener('click', () => {
        const url = prompt('请输入图片URL（可选）：');
        if (url) {
          const placeholder = document.getElementById('welcomeImagePlaceholder');
          placeholder.style.backgroundImage = `url(${url})`;
          placeholder.style.backgroundSize = 'cover';
          placeholder.textContent = '';
        }
      });

      // 界面设置事件
      document.getElementById('settingsBtn').addEventListener('click', () => {
        document.getElementById('settingsPanel').classList.add('open');
      });
      document.getElementById('closeSettingsBtn').addEventListener('click', () => {
        document.getElementById('settingsPanel').classList.remove('open');
      });

      // 主题切换事件
      document.getElementById('themeToggle').addEventListener('change', () => {
        document.documentElement.classList.toggle('dark-mode');
      });

      // 字体大小设置事件
      document.querySelectorAll('.font-size-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.font-size-option').forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          
          document.documentElement.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl');
          document.documentElement.classList.add(`font-size-${option.dataset.size}`);
        });
      });

      // 自动标注开关事件
      // 【新增事件：设置面板"自动翻译"开关→同步工具栏状态】
      document.getElementById('autoTranslateToggle').addEventListener('change', (e) => {
        // 1. 同步全局翻译状态
        isTranslateEnabled = e.target.checked;
        // 2. 同步工具栏的翻译状态文本
        translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
        // 3. 关闭翻译时隐藏弹窗
        if (!isTranslateEnabled) {
          translatePopup.style.display = 'none';
        }
      });
      
      document.getElementById('autoVocabToggle').addEventListener('change', () => {
        const isChecked = document.getElementById('autoVocabToggle').checked;
        if (isChecked) {
          highlightAllVocabs();
          updateVocabStats();
        } else {
          removeAllVocabHighlights();
          updateVocabStats();
        }
      });
    }

    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // 获取选中内容的HTML
    function getSelectionHtml() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return '';
      
      const range = selection.getRangeAt(0);
      const div = document.createElement('div');
      div.appendChild(range.cloneContents());
      return div.innerHTML;
    }

    // 启动应用
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
