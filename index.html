<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>考研笔记平台 - 个性化学习平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.37.12/build/docxtemplater.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip-utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/txt-to-pdf@1.0.1/dist/txt-to-pdf.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            note: {
              blue: '#dbeafe',
              green: '#dcfce7',
              yellow: '#fef3c7',
              red: '#fee2e2',
              purple: '#f3e8ff'
            },
            postgrad: {
              high: '#dbeafe',
              mid: '#eff6ff'
            },
            dark: {
              bg: '#1e293b',
              card: '#334155',
              text: '#f8fafc'
            }
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .btn-tool { @apply p-2 rounded-md hover:bg-gray-100 transition-colors; }
      .note-tag { @apply px-2 py-1 rounded-full text-xs font-medium cursor-pointer; }
      .postgrad-high { @apply bg-postgrad-high px-1 rounded border-b-2 border-primary cursor-help; }
      .postgrad-mid { @apply bg-postgrad-mid px-1 rounded border-b-2 border-blue-400 cursor-help; }
      .translate-result { @apply bg-green-50 p-3 rounded my-2 text-sm border border-green-100; }
      .folder-active { @apply bg-blue-50 border-l-4 border-primary; }
      
      /* 深色模式样式 */
      .dark-mode {
        --bg-color: #1e293b;
        --card-color: #334155;
        --text-color: #f8fafc;
        --border-color: #475569;
        --hover-color: #475569;
      }
      
      .dark-mode body {
        background-color: var(--bg-color);
        color: var(--text-color);
      }
      
      .dark-mode .bg-white {
        background-color: var(--card-color);
      }
      
      .dark-mode .text-gray-800 {
        color: var(--text-color);
      }
      
      .dark-mode .text-gray-600,
      .dark-mode .text-gray-500 {
        color: #cbd5e1;
      }
      
      .dark-mode .border-gray-200,
      .dark-mode .border-gray-100 {
        border-color: var(--border-color);
      }
      
      .dark-mode .hover:bg-gray-50,
      .dark-mode .hover:bg-gray-100 {
        background-color: var(--hover-color);
      }
      
      .dark-mode .postgrad-high {
        background-color: #1e3a8a;
        color: #dbeafe;
      }
      
      .dark-mode .postgrad-mid {
        background-color: #3b82f6;
        color: #eff6ff;
      }
      
      .dark-mode .translate-result {
        background-color: #065f46;
        border-color: #059669;
        color: #dcfce7;
      }
    }
    #editor {
      line-height: 1.6;
      outline: none;
      min-height: 500px;
      font-size: 16px;
      transition: font-size 0.3s ease;
    }
    
    .font-size-sm #editor {
      font-size: 14px;
    }
    
    .font-size-md #editor {
      font-size: 16px;
    }
    
    .font-size-lg #editor {
      font-size: 18px;
    }
    
    .font-size-xl #editor {
      font-size: 20px;
    }
    #editor p { margin: 0 0 1em 0; }
    #translatePopup {
      position: absolute;
      z-index: 100;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      padding: 12px;
      width: 320px;
      display: none;
    }
    .timeline-item {
      position: relative;
      padding-left: 24px;
    }
    .timeline-item:before {
      content: '';
      position: absolute;
      left: 6px;
      top: 6px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3b82f6;
    }
    .timeline-item:after {
      content: '';
      position: absolute;
      left: 10px;
      top: 14px;
      width: 1px;
      height: calc(100% + 10px);
      background: #e5e7eb;
    }
    .timeline-item:last-child:after { display: none; }
    .focus-card {
      border-left: 4px solid #3b82f6;
    }
    .focus-card.note-blue { border-left-color: #3b82f6; }
    .focus-card.note-yellow { border-left-color: #f59e0b; }
    .focus-card.note-green { border-left-color: #10b981; }
    .focus-card.note-red { border-left-color: #ef4444; }
    
    /* 语音控制样式 */
    .voice-controls {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .voice-selector {
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      font-size: 12px;
    }
    
    /* 界面设置面板 */
    #settingsPanel {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
    }
    
    #settingsPanel.open {
      right: 0;
    }
    
    .settings-section {
      margin-bottom: 25px;
    }
    
    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }
    
    .font-size-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .font-size-option {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .font-size-option.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #3b82f6;
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    .theme-options {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    /* 文档格式选择弹窗 */
    #formatModal {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    #formatModal.open {
      opacity: 1;
      visibility: visible;
    }
    
    .format-modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .format-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .format-modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .format-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .format-modal-close:hover {
      color: #ef4444;
    }
    
    .format-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .format-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .format-option:hover {
      border-color: #3b82f6;
      background-color: #f9fafb;
    }
    
    .format-option.active {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    
    .format-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .format-txt .format-icon { color: #10b981; }
    .format-docx .format-icon { color: #3b82f6; }
    .format-pdf .format-icon { color: #ef4444; }
    .format-html .format-icon { color: #f59e0b; }
    
    .format-name {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
    }
    
    .format-modal-footer {
      display: flex;
      justify-content: flex-end;
    }
    
    .format-modal-confirm {
      padding: 8px 16px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .format-modal-confirm:hover {
      background-color: #2563eb;
    }

    /* 重点卡片库提示样式 */
    .card-library-tip {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #1f2937;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .card-library-tip.show {
      opacity: 1;
      visibility: visible;
    }
    
    .card-library-tip-icon {
      color: #fbbf24;
      font-size: 18px;
    }
    
    .card-library-tip-text {
      font-size: 14px;
    }
    
    .card-library-tip-btn {
      margin-left: 12px;
      padding: 4px 8px;
      background-color: #3b82f6;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .card-library-tip-btn:hover {
      background-color: #2563eb;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen transition-all duration-300">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-book text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-gray-800">笔记平台</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="settingsBtn" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
          <i class="fa fa-cog mr-1"></i>设置
        </button>
        <button id="focusCardsBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
          <i class="fa fa-flag mr-2"></i>重点卡片库
        </button>
        <button id="backToDocsBtn" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-gray-600 transition-colors hidden">
          <i class="fa fa-arrow-left mr-2"></i>返回文件列表
        </button>
        <!-- 修改：导出数据改为下载文档 -->
        <button id="downloadDocBtn" class="px-3 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition-colors">
          <i class="fa fa-download mr-1"></i>下载文档
        </button>
        <!-- 修改：导入数据改为上传文档 -->
        <label for="uploadDocBtn" class="px-3 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors cursor-pointer">
          <i class="fa fa-upload mr-1"></i>上传文档
        </label>
        <input type="file" id="uploadDocBtn" accept=".txt,.docx,.pdf,.html" class="hidden">
        <!-- 新增：重点卡片库下载按钮 -->
        <button id="downloadCardsBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
          <i class="fa fa-download mr-1"></i>卡片库下载
        </button>
        <button id="newDocBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-colors">
          <i class="fa fa-file-o mr-2"></i>新建文档
        </button>
        <button id="saveDocBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors hidden">
          <i class="fa fa-save mr-2"></i>保存到本地
        </button>
      </div>
    </div>
  </header>
  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-6">
    <!-- 1. 文件列表视图 -->
    <div id="docsListView" class="block">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">我的文档</h2>
          <div class="text-sm text-gray-500">
            共 <span id="docsCount">0</span> 个临时文档
          </div>
        </div>
        <div class="mb-4">
          <div class="relative">
            <input type="text" id="searchDocs" class="w-full border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="搜索文档...">
            <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
          </div>
        </div>
        <div id="docsList" class="max-h-[600px] overflow-y-auto border border-gray-200 rounded-md">
          <div class="p-8 text-center text-gray-500">
            <i class="fa fa-file-text-o text-4xl mb-4 text-gray-300"></i>
            <p>暂无文档，点击"新建文档"开始创建或"上传文档"导入现有文档</p>
            <p class="mt-2 text-xs text-gray-400">提示：所有文档仅保存在当前浏览器会话中，关闭页面后将删除</p>
          </div>
        </div>
      </div>
    </div>
    <!-- 2. 文档编辑视图 -->
    <div id="docEditView" class="hidden">
      <div class="mb-6">
        <input type="text" id="docTitle" class="w-full text-2xl font-bold border-none outline-none bg-transparent placeholder-gray-400" placeholder="输入文档标题（如：考研英语笔记）">
      </div>
      <div class="bg-white border-b border-gray-200 p-3 mb-6 rounded-lg">
        <div class="flex flex-wrap gap-2">
          <!-- 文本格式工具 -->
          <div class="flex items-center space-x-1">
            <button class="btn-tool" data-command="bold" title="加粗"><i class="fa fa-bold"></i></button>
            <button class="btn-tool" data-command="italic" title="斜体"><i class="fa fa-italic"></i></button>
            <button class="btn-tool" data-command="underline" title="下划线"><i class="fa fa-underline"></i></button>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          <!-- 笔记标签工具 -->
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">笔记标签：</span>
            <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200" data-tag="重点">重点</button>
            <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200" data-tag="疑问">疑问</button>
            <button class="note-tag bg-note-green text-green-800 hover:bg-green-200" data-tag="例题">例题</button>
            <button class="note-tag bg-note-red text-red-800 hover:bg-red-200" data-tag="易错">易错</button>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          <!-- 重点卡片工具 -->
          <button class="btn-tool bg-purple-100 text-purple-700 hover:bg-purple-200" id="addFocusCardBtn" title="添加到重点卡片库">
            <i class="fa fa-flag mr-1"></i> 转为重点卡片
          </button>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          <!-- 考研词汇工具 -->
          <div class="flex items-center space-x-2">
            <button class="btn-tool bg-blue-100 text-blue-700 hover:bg-blue-200" id="togglePostGradWords" title="考研词汇标注">
              <i class="fa fa-bookmark mr-1"></i> 考研词汇
            </button>
            <span class="text-sm text-gray-600" id="postgradStatus">自动标注：开启</span>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          <!-- 时间线工具 -->
          <button class="btn-tool bg-purple-100 text-purple-700 hover:bg-purple-200" id="addTimelineBtn" title="添加课堂时间点">
            <i class="fa fa-clock-o mr-1"></i> 时间点
          </button>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          <!-- 翻译工具 -->
          <div class="flex items-center space-x-2">
            <button class="btn-tool" id="translateToggleBtn" title="翻译开关">
              <i class="fa fa-language text-primary"></i>
            </button>
            <span class="text-sm text-gray-600" id="translateStatus">翻译：开启（单词/句子）</span>
            <button class="btn-tool bg-green-100 text-green-700 hover:bg-green-200 ml-2" id="translateSentenceBtn" title="翻译选中的句子">
              <i class="fa fa-translate mr-1"></i>一键翻译
            </button>
          </div>
          <div class="h-6 border-r border-gray-300 mx-1"></div>
          <!-- 文字转语音工具 -->
          <div class="voice-controls">
            <select id="voiceSelect" class="voice-selector">
              <option value="">选择语音</option>
              <!-- 语音选项将动态生成 -->
            </select>
            <button class="btn-tool bg-rose-100 text-rose-700 hover:bg-rose-200" id="textToSpeechBtn" title="朗读选中的文本">
              <i class="fa fa-volume-up mr-1"></i> 开始朗读
            </button>
            <button class="btn-tool bg-rose-100 text-rose-700 hover:bg-rose-200 hidden" id="stopSpeechBtn" title="停止朗读">
              <i class="fa fa-volume-off mr-1"></i> 停止朗读
            </button>
          </div>
        </div>
      </div>
      <div class="flex gap-6">
        <div class="relative flex-1">
          <div id="translatePopup" class="absolute z-10">
            <div class="font-bold text-lg mb-1 flex justify-between">
              <span id="popupSource"></span>
              <span class="text-xs px-2 py-0.5 bg-gray-100 rounded" id="popupType">单词翻译</span>
            </div>
            <div class="text-sm text-gray-600 mb-2" id="popupPhonetic"></div>
            <div id="popupExplains" class="text-sm"></div>
            <div class="text-xs text-gray-500 mt-2" id="popupPostgradNote"></div>
          </div>
          <div id="editor" class="bg-white rounded-lg p-6 min-h-[500px] focus:outline-none" contenteditable="true">
            <p>在这里开始记录考研笔记...<br><br>功能说明：<br>1. 英文单词/句子会自动翻译（选中即可查看）<br>2. 考研高频词汇会自动标注（蓝色背景）<br>3. 可添加重点卡片用于复习，支持文件夹分类<br>4. 可添加课堂时间点记录关键内容<br>5. 选中文字后点击"开始朗读"可进行文字转语音<br><br>提示：文档仅保存在当前浏览器会话中，关闭页面后将删除，请及时下载保存</p>
            <p><br>示例：The <span class="postgrad-high" title="高频词：n. 能力，才能">ability</span> to <span class="postgrad-high" title="高频词：v. 放弃，抛弃">abandon</span> old ideas is crucial for success.</p>
          </div>
        </div>
        <div class="w-64 bg-white rounded-lg p-4 shadow-sm">
          <h3 class="font-bold text-gray-800 mb-3 flex items-center">
            <i class="fa fa-bar-chart text-blue-500 mr-2"></i> 词汇统计
          </h3>
          <div class="text-sm space-y-4 max-h-[250px] overflow-y-auto mb-6">
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>总考研词汇数</span>
              <span id="totalPostgradCount" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>高频词汇</span>
              <span id="highFreqCount" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>中频词汇</span>
              <span id="midFreqCount" class="font-medium text-blue-600">0</span>
            </div>
          </div>
          <h3 class="font-bold text-gray-800 mb-3 flex items-center">
            <i class="fa fa-history text-purple-500 mr-2"></i> 课堂时间线
          </h3>
          <div id="timelineContainer" class="text-sm space-y-4 max-h-[250px] overflow-y-auto">
            <div class="text-gray-500 text-center text-sm py-4">
              点击"时间点"添加课堂关键节点
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 3. 重点卡片库视图（含文件夹分类） -->
    <div id="focusCardsView" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">
            <i class="fa fa-flag text-purple-500 mr-2"></i>重点复习卡片库
          </h2>
          <div class="flex gap-2">
            <button id="addFolderBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
              <i class="fa fa-folder mr-1"></i>新建文件夹
            </button>
            <button id="backFromCardsBtn" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-gray-600 transition-colors">
              <i class="fa fa-arrow-left mr-2"></i>返回
            </button>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-6">
          <!-- 左侧文件夹列表 -->
          <div class="w-64 flex-shrink-0">
            <div class="bg-gray-50 rounded-lg p-4 h-full">
              <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-folder-open text-indigo-500 mr-2"></i> 文件夹
              </h3>
              <div class="space-y-1 mb-4">
                <div class="folder-item p-2 rounded hover:bg-gray-100 cursor-pointer flex items-center" data-id="all">
                  <i class="fa fa-folder-open-o text-gray-500 mr-2"></i>
                  <span>所有卡片</span>
                </div>
              </div>
              <div id="foldersList" class="space-y-1 max-h-[400px] overflow-y-auto">
                <div class="text-gray-500 text-sm italic p-2">暂无自定义文件夹</div>
              </div>
              <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md text-sm text-yellow-800">
                <i class="fa fa-info-circle mr-1"></i> 提示：卡片库数据仅临时存储，关闭页面前请下载保存
              </div>
            </div>
          </div>
          
          <!-- 右侧卡片内容区 -->
          <div class="flex-1">
            <div class="flex flex-wrap gap-3 mb-6">
              <div class="relative flex-1 max-w-md">
                <input type="text" id="searchCards" class="w-full border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="搜索重点卡片...">
                <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">筛选：</span>
                <button class="note-tag bg-gray-100 text-gray-800 hover:bg-gray-200 ring-2 ring-primary" data-filter="all">全部</button>
                <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200" data-filter="重点">重点</button>
                <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200" data-filter="疑问">疑问</button>
                <button class="note-tag bg-note-green text-green-800 hover:bg-green-200" data-filter="例题">例题</button>
                <button class="note-tag bg-note-red text-red-800 hover:bg-red-200" data-filter="易错">易错</button>
              </div>
            </div>
            
            <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="col-span-full p-12 text-center text-gray-500">
                <i class="fa fa-flag-o text-5xl mb-4 text-gray-300"></i>
                <p class="text-lg">暂无重点卡片</p>
                <p class="mt-2">在笔记中选中内容，点击"转为重点卡片"添加到这里</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- 界面设置面板 -->
  <div id="settingsPanel">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold text-gray-800">界面设置</h2>
      <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-700">
        <i class="fa fa-times text-xl"></i>
      </button>
    </div>
    
    <div class="settings-section">
      <h3>主题模式</h3>
      <div class="theme-options">
        <span>浅色模式</span>
        <label class="theme-switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <span>深色模式</span>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>字体大小</h3>
      <p class="text-sm text-gray-500 mb-2">设置编辑器字体大小</p>
      <div class="font-size-options">
        <div class="font-size-option" data-size="sm">A</div>
        <div class="font-size-option active" data-size="md">A</div>
        <div class="font-size-option" data-size="lg">A</div>
        <div class="font-size-option" data-size="xl">A</div>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>语音设置</h3>
      <p class="text-sm text-gray-500 mb-2">默认语音速度</p>
      <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" 
             class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
      <div class="flex justify-between text-xs text-gray-500 mt-1">
        <span>慢速</span>
        <span>正常</span>
        <span>快速</span>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>功能设置</h3>
      <div class="space-y-3">
        <div class="flex items-center">
          <input type="checkbox" id="autoSaveToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoSaveToggle" class="ml-2 text-sm text-gray-700">自动保存笔记内容（临时）</label>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="autoTranslateToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoTranslateToggle" class="ml-2 text-sm text-gray-700">自动翻译英文内容</label>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="autoHighlightToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoHighlightToggle" class="ml-2 text-sm text-gray-700">自动标注考研词汇</label>
        </div>
      </div>
    </div>
  </div>
  <!-- 时间点添加弹窗 -->
  <div id="timelineModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">添加课堂时间点</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">时间（如：45:30）</label>
        <input type="text" id="timelineTime" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="例如：30:15（分钟:秒）">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">内容描述</label>
        <input type="text" id="timelineContent" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="记录此时的课堂重点...">
      </div>
      <div class="flex justify-end">
        <button id="cancelTimeline" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmTimeline" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600">确认</button>
      </div>
    </div>
  </div>
  <!-- 文件夹弹窗 -->
  <div id="folderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">新建文件夹</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">文件夹名称</label>
        <input type="text" id="folderName" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="例如：考研英语高频词、数学公式">
      </div>
      <div class="flex justify-end">
        <button id="cancelFolder" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmFolder" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">创建</button>
      </div>
    </div>
  </div>
  <!-- 卡片移动弹窗 -->
  <div id="moveCardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">移动到文件夹</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">选择文件夹</label>
        <div id="folderSelectList" class="space-y-2 max-h-[200px] overflow-y-auto">
          <!-- 文件夹选项将动态生成 -->
        </div>
      </div>
      <div class="flex justify-end">
        <button id="cancelMoveCard" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmMoveCard" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600">确认移动</button>
      </div>
    </div>
  </div>
  <!-- 重点卡片编辑弹窗 -->
  <div id="cardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">编辑重点卡片</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">卡片标题</label>
        <input type="text" id="cardTitle" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="给重点内容起个标题...">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">所属文件夹</label>
        <select id="cardFolderSelect" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="">-- 未分类 --</option>
          <!-- 文件夹选项将动态生成 -->
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">卡片类型</label>
        <div class="flex gap-2">
          <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200 card-type-btn" data-type="重点">重点</button>
          <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200 card-type-btn" data-type="疑问">疑问</button>
          <button class="note-tag bg-note-green text-green-800 hover:bg-green-200 card-type-btn" data-type="例题">例题</button>
          <button class="note-tag bg-note-red text-red-800 hover:bg-red-200 card-type-btn" data-type="易错">易错</button>
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">重点内容</label>
        <div id="cardContent" class="w-full border border-gray-300 rounded-md p-4 min-h-[100px]" contenteditable="true"></div>
      </div>
      <div class="flex justify-end">
        <button id="cancelCard" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmCard" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600">保存卡片</button>
      </div>
    </div>
  </div>
  <!-- 文档格式选择弹窗 -->
  <div id="formatModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="format-modal-content">
      <div class="format-modal-header">
        <h3>选择下载格式</h3>
        <button class="format-modal-close" id="formatModalClose">×</button>
      </div>
      <div class="format-options">
        <div class="format-option format-txt" data-format="txt">
          <i class="fa fa-file-text-o format-icon"></i>
          <span class="format-name">TXT 文本</span>
        </div>
        <div class="format-option format-docx" data-format="docx">
          <i class="fa fa-file-word-o format-icon"></i>
          <span class="format-name">DOCX 文档</span>
        </div>
        <div class="format-option format-pdf" data-format="pdf">
          <i class="fa fa-file-pdf-o format-icon"></i>
          <span class="format-name">PDF 文档</span>
        </div>
        <div class="format-option format-html" data-format="html">
          <i class="fa fa-file-code-o format-icon"></i>
          <span class="format-name">HTML 网页</span>
        </div>
      </div>
      <div class="format-modal-footer">
        <button class="format-modal-confirm" id="formatModalConfirm">确认下载</button>
      </div>
    </div>
  </div>
  <!-- 重点卡片库提示 -->
  <div class="card-library-tip" id="cardLibraryTip">
    <i class="fa fa-exclamation-triangle card-library-tip-icon"></i>
    <span class="card-library-tip-text">重点卡片库数据将在关闭页面后删除，建议及时下载保存</span>
    <button class="card-library-tip-btn" id="tipDownloadBtn">立即下载</button>
  </div>
  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-4 right-4 bg-white shadow-lg rounded-md px-4 py-3 transform translate-y-full opacity-0 transition-all duration-300 flex items-center">
    <i id="notificationIcon" class="fa fa-check-circle text-green-500 mr-2"></i>
    <span id="notificationText" class="text-gray-800"></span>
  </div>
  <script>
    // 全局变量
    let currentDocId = null;
    let docs = {}; // 修改：不使用localStorage，仅内存存储
    let focusCards = []; // 修改：不使用localStorage，仅内存存储
    let folders = []; // 修改：不使用localStorage，仅内存存储
    let isTranslateEnabled = true;
    let isPostGradHighlightEnabled = true;
    let currentCardId = null;
    let currentFolderId = 'all';
    let detectedWords = new Set();
    let postGradWords = [];
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let voices = [];
    let speechRate = 1;
    let selectedDownloadFormat = 'txt'; // 默认下载格式
    
    // DOM元素
    const docsListView = document.getElementById('docsListView');
    const docEditView = document.getElementById('docEditView');
    const focusCardsView = document.getElementById('focusCardsView');
    const docsList = document.getElementById('docsList');
    const docsCount = document.getElementById('docsCount');
    const searchDocs = document.getElementById('searchDocs');
    const backToDocsBtn = document.getElementById('backToDocsBtn');
    const newDocBtn = document.getElementById('newDocBtn');
    const saveDocBtn = document.getElementById('saveDocBtn');
    const docTitle = document.getElementById('docTitle');
    const editor = document.getElementById('editor');
    const addFocusCardBtn = document.getElementById('addFocusCardBtn');
    const focusCardsBtn = document.getElementById('focusCardsBtn');
    const backFromCardsBtn = document.getElementById('backFromCardsBtn');
    const cardsContainer = document.getElementById('cardsContainer');
    const searchCards = document.getElementById('searchCards');
    const timelineModal = document.getElementById('timelineModal');
    const cardModal = document.getElementById('cardModal');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    const notificationIcon = document.getElementById('notificationIcon');
    const translatePopup = document.getElementById('translatePopup');
    const translateToggleBtn = document.getElementById('translateToggleBtn');
    const translateStatus = document.getElementById('translateStatus');
    const togglePostGradWords = document.getElementById('togglePostGradWords');
    const postgradStatus = document.getElementById('postgradStatus');
    const translateSentenceBtn = document.getElementById('translateSentenceBtn');
    const totalPostgradCount = document.getElementById('totalPostgradCount');
    const highFreqCount = document.getElementById('highFreqCount');
    const midFreqCount = document.getElementById('midFreqCount');
    const timelineContainer = document.getElementById('timelineContainer');
    const downloadDocBtn = document.getElementById('downloadDocBtn'); // 修改：导出改为下载
    const uploadDocBtn = document.getElementById('uploadDocBtn'); // 修改：导入改为上传
    const downloadCardsBtn = document.getElementById('downloadCardsBtn'); // 新增：卡片库下载
    const foldersList = document.getElementById('foldersList');
    const addFolderBtn = document.getElementById('addFolderBtn');
    const folderModal = document.getElementById('folderModal');
    const folderName = document.getElementById('folderName');
    const cancelFolder = document.getElementById('cancelFolder');
    const confirmFolder = document.getElementById('confirmFolder');
    const moveCardModal = document.getElementById('moveCardModal');
    const folderSelectList = document.getElementById('folderSelectList');
    const cancelMoveCard = document.getElementById('cancelMoveCard');
    const confirmMoveCard = document.getElementById('confirmMoveCard');
    const cardFolderSelect = document.getElementById('cardFolderSelect');
    const addTimelineBtn = document.getElementById('addTimelineBtn');
    const textToSpeechBtn = document.getElementById('textToSpeechBtn');
    const stopSpeechBtn = document.getElementById('stopSpeechBtn');
    const voiceSelect = document.getElementById('voiceSelect');
    const speechRateSlider = document.getElementById('speechRate');
    
    // 新增：文档格式选择弹窗元素
    const formatModal = document.getElementById('formatModal');
    const formatModalClose = document.getElementById('formatModalClose');
    const formatModalConfirm = document.getElementById('formatModalConfirm');
    const formatOptions = document.querySelectorAll('.format-option');
    
    // 新增：重点卡片库提示元素
    const cardLibraryTip = document.getElementById('cardLibraryTip');
    const tipDownloadBtn = document.getElementById('tipDownloadBtn');
    
    // 界面设置元素
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const themeToggle = document.getElementById('themeToggle');
    const fontSizeOptions = document.querySelectorAll('.font-size-option');
    const autoSaveToggle = document.getElementById('autoSaveToggle');
    const autoTranslateToggle = document.getElementById('autoTranslateToggle');
    const autoHighlightToggle = document.getElementById('autoHighlightToggle');
    
    // 初始化
    function init() {
      loadUserSettings();
      loadPostGradWords();
      loadVoices();
      renderDocsList();
      renderFolders();
      bindEvents();
      showNotification('欢迎使用复习笔记平台！所有数据仅临时存储，关闭页面后删除', 'info');
      
      // 显示重点卡片库提示
      setTimeout(() => {
        cardLibraryTip.classList.add('show');
      }, 3000);
      
      // 页面关闭前提示
      window.addEventListener('beforeunload', function(e) {
        // 取消事件
        e.preventDefault();
        // Chrome需要设置returnValue
        e.returnValue = '';
        // 提示信息
        return '所有临时数据将在关闭页面后删除，确定要离开吗？';
      });
    }
    
    // 加载用户设置（修改：仅内存存储，不持久化）
    function loadUserSettings() {
      // 修改：不从localStorage加载，使用默认设置
      const settings = {
        darkMode: false,
        fontSize: 'md',
        speechRate: 1,
        autoSave: true,
        autoTranslate: true,
        autoHighlight: true
      };
      
      // 应用深色模式
      if (settings.darkMode) {
        document.documentElement.classList.add('dark-mode');
        themeToggle.checked = true;
      }
      
      // 应用字体大小
      document.documentElement.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl');
      document.documentElement.classList.add(`font-size-${settings.fontSize}`);
      fontSizeOptions.forEach(option => {
        if (option.dataset.size === settings.fontSize) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
      
      // 应用语音速度
      speechRate = settings.speechRate;
      speechRateSlider.value = settings.speechRate;
      
      // 应用功能设置
      autoSaveToggle.checked = settings.autoSave;
      autoTranslateToggle.checked = settings.autoTranslate;
      autoHighlightToggle.checked = settings.autoHighlight;
      
      isTranslateEnabled = settings.autoTranslate;
      isPostGradHighlightEnabled = settings.autoHighlight;
      
      translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
    }
    
    // 保存用户设置（修改：仅内存存储，不持久化）
    function saveUserSettings() {
      const settings = {
        darkMode: themeToggle.checked,
        fontSize: document.querySelector('.font-size-option.active').dataset.size,
        speechRate: parseFloat(speechRateSlider.value),
        autoSave: autoSaveToggle.checked,
        autoTranslate: autoTranslateToggle.checked,
        autoHighlight: autoHighlightToggle.checked
      };
      
      // 修改：不保存到localStorage，仅内存生效
      
      // 更新全局变量
      speechRate = settings.speechRate;
      isTranslateEnabled = settings.autoTranslate;
      isPostGradHighlightEnabled = settings.autoHighlight;
      
      translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
      
      if (isPostGradHighlightEnabled) {
        highlightPostgradWords();
        updateWordStats();
      } else {
        removePostgradHighlights();
      }
    }
    
    // 加载考研词汇库
    function loadPostGradWords() {
      postGradWords = [
        { word: "financial", freq: "高频", pos: "adj.", mean: "金融的；财政的" },
        { word: "define", freq: "高频", pos: "v.", mean: "界定；解释" },
        { word: "tolerance", freq: "中频", pos: "n.", mean: "忍受；宽容" },
        { word: "board", freq: "高频", pos: "n./v.", mean: "董事会；上（船）" },
        { word: "blank", freq: "中频", pos: "adj./n.", mean: "空白的；空白" },
        { word: "gap", freq: "高频", pos: "n.", mean: "间隙；差距" },
        { word: "environment", freq: "高频", pos: "n.", mean: "环境" },
        { word: "claim", freq: "高频", pos: "v./n.", mean: "声称；要求" },
        { word: "merit", freq: "中频", pos: "n./v.", mean: "优点；值得" },
        { word: "liberty", freq: "中频", pos: "n.", mean: "自由" },
        { word: "philosophy", freq: "中频", pos: "n.", mean: "哲学" },
        { word: "confused", freq: "高频", pos: "adj.", mean: "困惑的" },
        { word: "quality", freq: "高频", pos: "n./adj.", mean: "质量；优质的" },
        { word: "integrate", freq: "中频", pos: "v.", mean: "（使）合并" },
        { word: "mere", freq: "高频", pos: "adj.", mean: "仅仅的" },
        { word: "urge", freq: "高频", pos: "v./n.", mean: "催促；冲动" },
        { word: "literature", freq: "高频", pos: "n.", mean: "文学；著作" },
        { word: "digital", freq: "高频", pos: "adj.", mean: "数码的" },
        { word: "address", freq: "高频", pos: "v./n.", mean: "处理；地址" },
        { word: "improve", freq: "高频", pos: "v.", mean: "提高" },
      ];
    }
    
    // 加载语音选项
    function loadVoices() {
      // 语音加载完成时的回调
      speechSynthesis.onvoiceschanged = () => {
        voices = speechSynthesis.getVoices();
        populateVoiceList();
      };
      
      // 初始化获取一次语音列表
      voices = speechSynthesis.getVoices();
      populateVoiceList();
    }
    
    // 填充语音选择下拉框
    function populateVoiceList() {
      voiceSelect.innerHTML = '<option value="">选择语音</option>';
      
      // 按语言分组
      const voiceGroups = {};
      
      voices.forEach(voice => {
        const langGroup = voice.lang.includes('zh') ? '中文语音' : 
                         voice.lang.includes('en') ? '英文语音' : '其他语音';
        
        if (!voiceGroups[langGroup]) {
          voiceGroups[langGroup] = [];
        }
        
        voiceGroups[langGroup].push(voice);
      });
      
      // 添加到下拉框
      Object.keys(voiceGroups).forEach(group => {
        // 添加分组标题
        const optionGroup = document.createElement('optgroup');
        optionGroup.label = group;
        voiceSelect.appendChild(optionGroup);
        
        // 添加该组下的所有语音
        voiceGroups[group].forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.voiceURI;
          option.textContent = `${voice.name} (${voice.lang})`;
          optionGroup.appendChild(option);
        });
      });
    }
    
    // 视图切换
    function showDocsList() {
      docsListView.classList.remove('hidden');
      docEditView.classList.add('hidden');
      focusCardsView.classList.add('hidden');
      backToDocsBtn.classList.add('hidden');
      saveDocBtn.classList.add('hidden');
      currentDocId = null;
    }
    
    function showDocEditor() {
      docsListView.classList.add('hidden');
      docEditView.classList.remove('hidden');
      focusCardsView.classList.add('hidden');
      backToDocsBtn.classList.remove('hidden');
      saveDocBtn.classList.remove('hidden');
      if (isPostGradHighlightEnabled) {
        highlightPostgradWords();
        updateWordStats();
      }
    }
    
    function showFocusCards() {
      docsListView.classList.add('hidden');
      docEditView.classList.add('hidden');
      focusCardsView.classList.remove('hidden');
      renderFolders();
      renderFocusCards();
    }
    
    // 渲染文件列表
    function renderDocsList() {
      const docIds = Object.keys(docs);
      docsCount.textContent = docIds.length;
      if (docIds.length === 0) {
        docsList.innerHTML = `
          <div class="p-8 text-center text-gray-500">
            <i class="fa fa-file-text-o text-4xl mb-4 text-gray-300"></i>
            <p>暂无文档，点击"新建文档"开始创建或"上传文档"导入现有文档</p>
            <p class="mt-2 text-xs text-gray-400">提示：所有文档仅保存在当前浏览器会话中，关闭页面后将删除</p>
          </div>
        `;
        return;
      }
      const sortedIds = docIds.sort((a, b) => 
        new Date(docs[b].updatedAt).getTime() - new Date(docs[a].updatedAt).getTime()
      );
      let html = '';
      sortedIds.forEach(id => {
        const doc = docs[id];
        const date = new Date(doc.updatedAt).toLocaleString();
        html += `
          <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer doc-item" data-id="${id}">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-medium text-gray-800">${doc.title || '无标题文档'}</h3>
                <p class="text-sm text-gray-500 mt-1">最后编辑：${date}</p>
                <p class="text-xs text-gray-400 mt-2 line-clamp-1">${stripHtml(doc.content || '')}</p>
              </div>
              <div class="flex gap-2">
                <button class="text-blue-500 hover:text-blue-700 download-single-doc" data-id="${id}" title="下载文档">
                  <i class="fa fa-download"></i>
                </button>
                <button class="text-red-500 hover:text-red-700 delete-doc" data-id="${id}" title="删除文档">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
      docsList.innerHTML = html;
      document.querySelectorAll('.doc-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.closest('.delete-doc') && !e.target.closest('.download-single-doc')) {
            const id = item.dataset.id;
            openDoc(id);
          }
        });
      });
      document.querySelectorAll('.delete-doc').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          if (confirm('确定要删除此临时文档吗？')) {
            delete docs[id];
            // 修改：不保存到localStorage
            renderDocsList();
            showNotification('临时文档已删除', 'info');
          }
        });
      });
      // 新增：单个文档下载事件
      document.querySelectorAll('.download-single-doc').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const doc = docs[id];
          if (doc) {
            currentDocId = id;
            openDoc(id);
            showDocEditor();
            // 打开格式选择弹窗
            openFormatModal();
          }
        });
      });
    }
    
    // 渲染文件夹列表
    function renderFolders() {
      if (folders.length === 0) {
        foldersList.innerHTML = '<div class="text-gray-500 text-sm italic p-2">暂无自定义文件夹</div>';
        updateFolderSelectors();
        return;
      }
      let html = '';
      folders.forEach(folder => {
        const cardCount = focusCards.filter(card => card.folderId === folder.id).length;
        html += `
          <div class="folder-item p-2 rounded hover:bg-gray-100 cursor-pointer flex items-center justify-between ${currentFolderId === folder.id ? 'folder-active' : ''}" data-id="${folder.id}">
            <div class="flex items-center">
              <i class="fa fa-folder-o text-indigo-500 mr-2"></i>
              <span>${folder.name}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-gray-200 px-1.5 rounded">${cardCount}</span>
              <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                <button class="text-gray-400 hover:text-red-500 delete-folder" data-id="${folder.id}">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
      foldersList.innerHTML = html;
      document.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', () => {
          currentFolderId = item.dataset.id;
          document.querySelectorAll('.folder-item').forEach(i => i.classList.remove('folder-active'));
          item.classList.add('folder-active');
          renderFocusCards();
        });
      });
      document.querySelectorAll('.delete-folder').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const folderId = btn.dataset.id;
          const folder = folders.find(f => f.id === folderId);
          if (confirm(`确定要删除文件夹"${folder.name}"吗？文件夹内的卡片将移至未分类`)) {
            focusCards.forEach(card => {
              if (card.folderId === folderId) {
                card.folderId = '';
              }
            });
            folders = folders.filter(f => f.id !== folderId);
            // 修改：不保存到localStorage
            if (currentFolderId === folderId) {
              currentFolderId = 'all';
              document.querySelector('.folder-item[data-id="all"]').classList.add('folder-active');
            }
            renderFolders();
            renderFocusCards();
            showNotification('文件夹已删除', 'info');
          }
        });
      });
      updateFolderSelectors();
    }
    
    // 更新文件夹选择器
    function updateFolderSelectors() {
      cardFolderSelect.innerHTML = '<option value="">-- 未分类 --</option>';
      folderSelectList.innerHTML = '';
      folders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = folder.name;
        cardFolderSelect.appendChild(option);
        const div = document.createElement('div');
        div.className = 'p-2 border rounded hover:bg-gray-50 cursor-pointer flex items-center';
        div.innerHTML = `
          <i class="fa fa-folder-o text-indigo-500 mr-2"></i>
          <span>${folder.name}</span>
        `;
        div.dataset.id = folder.id;
        folderSelectList.appendChild(div);
        div.addEventListener('click', () => {
          document.querySelectorAll('#folderSelectList > div').forEach(d => {
            d.classList.remove('ring-2', 'ring-primary');
          });
          div.classList.add('ring-2', 'ring-primary');
        });
      });
    }
    
    // 创建文件夹
    function createFolder() {
      const name = folderName.value.trim();
      if (!name) {
        showNotification('请输入文件夹名称', 'info');
        return;
      }
      if (folders.some(f => f.name === name)) {
        showNotification('文件夹名称已存在', 'info');
        return;
      }
      folders.push({
        id: generateUUID(),
        name: name,
        createdAt: new Date().toISOString()
      });
      // 修改：不保存到localStorage
      folderModal.classList.add('hidden');
      folderName.value = '';
      renderFolders();
      showNotification(`文件夹"${name}"已创建`, 'success');
    }
    
    // 渲染重点卡片库
    function renderFocusCards(filter = 'all', keyword = '') {
      let filteredByFolder = focusCards;
      if (currentFolderId !== 'all') {
        filteredByFolder = focusCards.filter(card => card.folderId === currentFolderId);
      }
      let filteredCards = filteredByFolder;
      if (filter !== 'all') {
        filteredCards = filteredCards.filter(card => card.type === filter);
      }
      if (keyword) {
        const kw = keyword.toLowerCase();
        filteredCards = filteredCards.filter(card => 
          card.title.toLowerCase().includes(kw) || 
          stripHtml(card.content).toLowerCase().includes(kw)
        );
      }
      if (filteredCards.length === 0) {
        cardsContainer.innerHTML = `
          <div class="col-span-full p-12 text-center text-gray-
500">
            <i class="fa fa-flag-o text-5xl mb-4 text-gray-300"></i>
            <p class="text-lg">暂无符合条件的卡片</p>
            <p class="mt-2">尝试更换筛选条件或添加新的重点卡片</p>
          </div>
        `;
        return;
      }
      let html = '';
      filteredCards.forEach(card => {
        const folder = folders.find(f => f.id === card.folderId);
        const folderName = folder ? folder.name : '未分类';
        const date = new Date(card.createdAt).toLocaleString();
        html += `
          <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden focus-card note-${getTypeClass(card.type)}">
            <div class="p-4">
              <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-gray-800">${card.title}</h3>
                <div class="flex space-x-1">
                  <button class="text-gray-400 hover:text-blue-500 edit-card" data-id="${card.id}" title="编辑卡片">
                    <i class="fa fa-pencil"></i>
                  </button>
                  <button class="text-gray-400 hover:text-indigo-500 move-card" data-id="${card.id}" title="移动到文件夹">
                    <i class="fa fa-folder-open-o"></i>
                  </button>
                  <button class="text-gray-400 hover:text-red-500 delete-card" data-id="${card.id}" title="删除卡片">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="text-sm text-gray-600 mb-3">
                ${card.content}
              </div>
              <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                <span class="px-2 py-0.5 bg-gray-100 rounded-full">${card.type}</span>
                <span class="px-2 py-0.5 bg-gray-100 rounded-full">${folderName}</span>
                <span>${date}</span>
              </div>
            </div>
          </div>
        `;
      });
      cardsContainer.innerHTML = html;
      // 绑定卡片操作事件
      document.querySelectorAll('.edit-card').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          openCardEditor(id);
        });
      });
      document.querySelectorAll('.delete-card').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const card = focusCards.find(c => c.id === id);
          if (confirm(`确定要删除卡片"${card.title}"吗？`)) {
            focusCards = focusCards.filter(c => c.id !== id);
            // 修改：不保存到localStorage
            renderFocusCards();
            showNotification('重点片已删除', 'info');
          }
        });
      });
      document.querySelectorAll('.move-card').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          currentCardId = id;
          document.querySelectorAll('#folderSelectList > div').forEach(d => {
            d.classList.remove('ring-2', 'ring-primary');
          });
          moveCardModal.classList.remove('hidden');
        });
      });
    }
    
    // 获取卡片类型对应的样式类
    function getTypeClass(type) {
      switch(type) {
        case '重点': return 'blue';
        case '疑问': return 'yellow';
        case '例题': return 'green';
        case '易错': return 'red';
        default: return 'blue';
      }
    }
    
    // 打开卡片编辑器
    function openCardEditor(id) {
      currentCardId = id;
      const card = focusCards.find(c => c.id === id) || {
        id: generateUUID(),
        title: '',
        type: '重点',
        content: '',
        folderId: '',
        createdAt: new Date().toISOString()
      };
      document.getElementById('cardTitle').value = card.title;
      document.getElementById('cardContent').innerHTML = card.content;
      document.getElementById('cardFolderSelect').value = card.folderId || '';
      
      // 重置类型按钮状态
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-primary');
        if (btn.dataset.type === card.type) {
          btn.classList.add('ring-2', 'ring-primary');
        }
      });
      
      cardModal.classList.remove('hidden');
    }
    
    // 保存卡片
    function saveCard() {
      const title = document.getElementById('cardTitle').value.trim();
      const content = document.getElementById('cardContent').innerHTML.trim();
      if (!title) {
        showNotification('请输入卡片标题', 'info');
        return;
      }
      if (!content) {
        showNotification('请输入卡片内容', 'info');
        return;
      }
      const typeBtn = document.querySelector('.card-type-btn.ring-2');
      if (!typeBtn) {
        showNotification('请选择卡片类型', 'info');
        return;
      }
      const type = typeBtn.dataset.type;
      const folderId = document.getElementById('cardFolderSelect').value;
      
      const index = focusCards.findIndex(c => c.id === currentCardId);
      if (index > -1) {
        // 更新现有卡片
        focusCards[index].title = title;
        focusCards[index].content = content;
        focusCards[index].type = type;
        focusCards[index].folderId = folderId;
        focusCards[index].updatedAt = new Date().toISOString();
        showNotification('卡片已更新', 'success');
      } else {
        // 创建新卡片
        focusCards.push({
          id: generateUUID(),
          title: title,
          content: content,
          type: type,
          folderId: folderId,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        showNotification('卡片已添加到重点卡片库', 'success');
      }
      // 修改：不保存到localStorage
      cardModal.classList.add('hidden');
      renderFocusCards();
      
      // 显示卡片库提示
      cardLibraryTip.classList.add('show');
      setTimeout(() => {
        cardLibraryTip.classList.remove('show');
      }, 5000);
    }
    
    // 移动卡片到文件夹
    function moveCardToFolder() {
      if (!currentCardId) return;
      const selectedFolder = document.querySelector('#folderSelectList > div.ring-2');
      if (!selectedFolder) {
        showNotification('请选择目标文件夹', 'info');
        return;
      }
      const folderId = selectedFolder.dataset.id;
      const index = focusCards.findIndex(c => c.id === currentCardId);
      if (index > -1) {
        focusCards[index].folderId = folderId;
        focusCards[index].updatedAt = new Date().toISOString();
        // 修改：不保存到localStorage
        moveCardModal.classList.add('hidden');
        renderFocusCards();
        showNotification('卡片已移动', 'success');
      }
    }
    
    // 新建文档
    function createNewDoc() {
      const id = generateUUID();
      docs[id] = {
        id: id,
        title: '未命名文档',
        content: '<p>在这里开始记录笔记...</p>',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        timeline: []
      };
      // 修改：不保存到localStorage
      openDoc(id);
      showDocEditor();
      showNotification('已创建新文档（仅临时存储）', 'success');
      
      // 强制保存到用户设备
      setTimeout(() => {
        saveDocBtn.click();
      }, 1000);
    }
    
    // 打开文档
    function openDoc(id) {
      currentDocId = id;
      const doc = docs[id];
      if (!doc) return;
      docTitle.value = doc.title || '无标题文档';
      editor.innerHTML = doc.content || '';
      renderTimeline(doc.timeline);
      updateWordStats();
    }
    
    // 保存文档（临时存储）
    function saveDoc() {
      if (!currentDocId || !docs[currentDocId]) return;
      docs[currentDocId].title = docTitle.value || '无标题文档';
      docs[currentDocId].content = editor.innerHTML;
      docs[currentDocId].updatedAt = new Date().toISOString();
      // 修改：不保存到localStorage
      renderDocsList();
      showNotification('文档已临时保存', 'success');
    }
    
    // 自动保存文档
    function autoSaveDoc() {
      if (autoSaveToggle.checked && currentDocId && docs[currentDocId]) {
        docs[currentDocId].title = docTitle.value || '无标题文档';
        docs[currentDocId].content = editor.innerHTML;
        docs[currentDocId].updatedAt = new Date().toISOString();
        // 修改：不保存到localStorage
      }
    }
    
    // 添加时间线
    function addTimeline() {
      if (!currentDocId || !docs[currentDocId]) return;
      timelineModal.classList.remove('hidden');
      document.getElementById('timelineTime').focus();
    }
    
    // 确认添加时间线
    function confirmTimeline() {
      const time = document.getElementById('timelineTime').value.trim();
      const content = document.getElementById('timelineContent').value.trim();
      if (!time) {
        showNotification('请输入时间', 'info');
        return;
      }
      if (!content) {
        showNotification('请输入内容描述', 'info');
        return;
      }
      if (!docs[currentDocId].timeline) {
        docs[currentDocId].timeline = [];
      }
      docs[currentDocId].timeline.push({
        id: generateUUID(),
        time: time,
        content: content,
        createdAt: new Date().toISOString()
      });
      // 按时间排序
      docs[currentDocId].timeline.sort((a, b) => {
        return timeToSeconds(a.time) - timeToSeconds(b.time);
      });
      // 修改：不保存到localStorage
      renderTimeline(docs[currentDocId].timeline);
      timelineModal.classList.add('hidden');
      document.getElementById('timelineTime').value = '';
      document.getElementById('timelineContent').value = '';
      showNotification('时间点已添加', 'success');
    }
    
    // 渲染时间线
    function renderTimeline(timeline) {
      if (!timeline || timeline.length === 0) {
        timelineContainer.innerHTML = `
          <div class="text-gray-500 text-center text-sm py-4">
            点击"时间点"添加课堂关键节点
          </div>
        `;
        return;
      }
      let html = '';
      timeline.forEach(item => {
        html += `
          <div class="timeline-item py-2">
            <div class="font-medium text-blue-600">${item.time}</div>
            <div class="text-sm text-gray-600 mt-1">${item.content}</div>
            <button class="text-red-400 hover:text-red-600 text-xs mt-1 delete-timeline" data-id="${item.id}">
              <i class="fa fa-trash-o"></i> 删除
            </button>
          </div>
        `;
      });
      timelineContainer.innerHTML = html;
      document.querySelectorAll('.delete-timeline').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          docs[currentDocId].timeline = docs[currentDocId].timeline.filter(item => item.id !== id);
          // 修改：不保存到localStorage
          renderTimeline(docs[currentDocId].timeline);
          showNotification('时间点已删除', 'info');
        });
      });
    }
    
    // 时间转换为秒数（用于排序）
    function timeToSeconds(timeStr) {
      const parts = timeStr.split(':').map(Number);
      if (parts.length === 2) {
        return parts[0] * 60 + parts[1];
      }
      return 0;
    }
    
    // 高亮考研词汇
    function highlightPostgradWords() {
      if (!isPostGradHighlightEnabled) return;
      const textNodes = getTextNodes(editor);
      textNodes.forEach(node => {
        const text = node.nodeValue;
        const words = text.match(/[a-zA-Z]+/g);
        if (!words) return;
        words.forEach(word => {
          if (detectedWords.has(word.toLowerCase())) return;
          const postGradWord = postGradWords.find(w => w.word.toLowerCase() === word.toLowerCase());
          if (postGradWord) {
            detectedWords.add(word.toLowerCase());
            const regex = new RegExp(`\\b${word}\\b`, 'g');
            if (regex.test(text)) {
              const span = document.createElement('span');
              span.className = postGradWord.freq === '高频' ? 'postgrad-high' : 'postgrad-mid';
              span.title = `${postGradWord.freq}词：${postGradWord.pos} ${postGradWord.mean}`;
              span.textContent = word;
              const fragment = document.createDocumentFragment();
              let lastIndex = 0;
              text.replace(regex, (match, index) => {
                fragment.appendChild(document.createTextNode(text.substring(lastIndex, index)));
                fragment.appendChild(span.cloneNode(true));
                lastIndex = index + match.length;
              });
              fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
              node.parentNode.replaceChild(fragment, node);
            }
          }
        });
      });
    }
    
    // 移除考研词汇高亮
    function removePostgradHighlights() {
      const highlighted = editor.querySelectorAll('.postgrad-high, .postgrad-mid');
      highlighted.forEach(span => {
        const textNode = document.createTextNode(span.textContent);
        span.parentNode.replaceChild(textNode, span);
      });
      detectedWords.clear();
    }
    
    // 更新词汇统计
    function updateWordStats() {
      const text = editor.innerText;
      let total = 0;
      let high = 0;
      let mid = 0;
      postGradWords.forEach(word => {
        const regex = new RegExp(`\\b${word.word}\\b`, 'gi');
        const matches = text.match(regex);
        if (matches && matches.length > 0) {
          total++;
          if (word.freq === '高频') {
            high++;
          } else {
            mid++;
          }
        }
      });
      totalPostgradCount.textContent = total;
      highFreqCount.textContent = high;
      midFreqCount.textContent = mid;
    }
    
    // 获取所有文本节点
    function getTextNodes(element) {
      const textNodes = [];
      const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );
      let node;
      while (node = walker.nextNode()) {
        if (node.parentNode.tagName !== 'SCRIPT' && node.parentNode.tagName !== 'STYLE') {
          textNodes.push(node);
        }
      }
      return textNodes;
    }
    
    // 切换翻译功能
    function toggleTranslate() {
      isTranslateEnabled = !isTranslateEnabled;
      translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      autoTranslateToggle.checked = isTranslateEnabled;
      saveUserSettings();
      showNotification(`翻译已${isTranslateEnabled ? '开启' : '关闭'}`, 'info');
    }
    
    // 切换考研词汇高亮
    function togglePostgradHighlight() {
      isPostGradHighlightEnabled = !isPostGradHighlightEnabled;
      postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
      autoHighlightToggle.checked = isPostGradHighlightEnabled;
      saveUserSettings();
      if (isPostGradHighlightEnabled) {
        highlightPostgradWords();
        updateWordStats();
        showNotification('考研词汇自动标注已开启', 'info');
      } else {
        removePostgradHighlights();
        showNotification('考研词汇自动标注已关闭', 'info');
      }
    }
    
    // 翻译选中的句子
    function translateSelected() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const text = selection.toString().trim();
      if (!text) {
        showNotification('请先选中要翻译的内容', 'info');
        return;
      }
      // 简单模拟翻译（实际项目中应调用翻译API）
      let translation = "这是模拟翻译结果。在实际应用中，这里会显示真实的翻译内容。";
      
      // 为演示效果，对示例文本做特殊处理
      if (text.includes("ability")) translation = "放弃旧观念的能力是成功的关键。";
      if (text.includes("environment")) translation = "保护环境是我们的责任。";
      
      // 创建翻译结果元素并插入
      const range = selection.getRangeAt(0);
      const resultDiv = document.createElement('div');
      resultDiv.className = 'translate-result';
      resultDiv.innerHTML = `<strong>翻译：</strong>${translation}`;
      
      // 插入到选中内容后面
      range.collapse(false);
      range.insertNode(resultDiv);
      
      // 插入一个换行
      range.insertNode(document.createElement('br'));
      range.collapse(false);
      
      showNotification('翻译完成', 'success');
    }
    
    // 显示翻译弹窗
    function showTranslatePopup(e) {
      if (!isTranslateEnabled) return;
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const text = selection.toString().trim();
      if (!text) {
        translatePopup.style.display = 'none';
        return;
      }
      
      // 判断是单词还是句子
      const isWord = text.match(/^[a-zA-Z]+$/) !== null;
      let wordInfo = null;
      let translation = "这是模拟翻译结果";
      
      if (isWord) {
        wordInfo = postGradWords.find(w => w.word.toLowerCase() === text.toLowerCase());
        if (wordInfo) {
          translation = `${wordInfo.pos} ${wordInfo.mean}`;
        }
      }
      
      // 设置弹窗内容
      document.getElementById('popupSource').textContent = text;
      document.getElementById('popupType').textContent = isWord ? '单词翻译' : '句子翻译';
      document.getElementById('popupExplains').textContent = translation;
      
      if (wordInfo) {
        document.getElementById('popupPhonetic').textContent = `/${text.toLowerCase()}/`;
        document.getElementById('popupPostgradNote').textContent = `考研${wordInfo.freq}词汇`;
      } else {
        document.getElementById('popupPhonetic').textContent = '';
        document.getElementById('popupPostgradNote').textContent = '';
      }
      
      // 定位弹窗
      const rect = selection.getRangeAt(0).getBoundingClientRect();
      translatePopup.style.left = `${rect.right + window.scrollX + 10}px`;
      translatePopup.style.top = `${rect.top + window.scrollY}px`;
      translatePopup.style.display = 'block';
      
      // 点击其他地方关闭弹窗
      document.addEventListener('click', hideTranslatePopup, { once: true });
    }
    
    // 隐藏翻译弹窗
    function hideTranslatePopup(e) {
      if (!translatePopup.contains(e.target)) {
        translatePopup.style.display = 'none';
      } else {
        // 如果点击了弹窗内部，重新绑定事件
        document.addEventListener('click', hideTranslatePopup, { once: true });
      }
    }
    
    // 文本转语音
    function textToSpeech() {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        stopSpeechBtn.classList.add('hidden');
        textToSpeechBtn.classList.remove('hidden');
        return;
      }
      
      const selection = window.getSelection();
      const text = selection.toString().trim();
      if (!text) {
        showNotification('请先选中要朗读的内容', 'info');
        return;
      }
      
      // 获取选中的语音
      const voiceURI = voiceSelect.value;
      const voice = voices.find(v => v.voiceURI === voiceURI);
      
      // 创建语音实例
      currentUtterance = new SpeechSynthesisUtterance(text);
      if (voice) {
        currentUtterance.voice = voice;
      }
      currentUtterance.rate = speechRate;
      
      // 语音结束时的回调
      currentUtterance.onend = () => {
        stopSpeechBtn.classList.add('hidden');
        textToSpeechBtn.classList.remove('hidden');
      };
      
      // 开始朗读
      speechSynthesis.speak(currentUtterance);
      stopSpeechBtn.classList.remove('hidden');
      textToSpeechBtn.classList.add('hidden');
    }
    
    // 停止语音
    function stopSpeech() {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      stopSpeechBtn.classList.add('hidden');
      textToSpeechBtn.classList.remove('hidden');
    }
    
    // 添加选中内容到重点卡片
    function addSelectedToFocusCards() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const html = selection.getRangeAt(0).cloneContents();
      const div = document.createElement('div');
      div.appendChild(html);
      const content = div.innerHTML.trim();
      if (!content) {
        showNotification('请先选中要添加的内容', 'info');
        return;
      }
      
      // 提取文本作为标题
      let title = stripHtml(content).substring(0, 20);
      if (stripHtml(content).length > 20) {
        title += '...';
      }
      
      // 打开卡片编辑器
      currentCardId = null;
      document.getElementById('cardTitle').value = title;
      document.getElementById('cardContent').innerHTML = content;
      document.getElementById('cardFolderSelect').value = '';
      
      // 重置类型按钮状态
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-primary');
        if (btn.dataset.type === '重点') {
          btn.classList.add('ring-2', 'ring-primary');
        }
      });
      
      cardModal.classList.remove('hidden');
    }
    
    // 打开格式选择弹窗
    function openFormatModal() {
      formatModal.classList.add('open');
      // 重置选中状态
      formatOptions.forEach(option => {
        option.classList.remove('active');
        if (option.dataset.format === selectedDownloadFormat) {
          option.classList.add('active');
        }
      });
    }
    
    // 关闭格式选择弹窗
    function closeFormatModal() {
      formatModal.classList.remove('open');
    }
    
    // 选择下载格式
    function selectDownloadFormat(format) {
      selectedDownloadFormat = format;
      formatOptions.forEach(option => {
        option.classList.remove('active');
        if (option.dataset.format === format) {
          option.classList.add('active');
        }
      });
    }
    
    // 下载文档
    function downloadDocument() {
      if (!currentDocId || !docs[currentDocId]) return;
      const doc = docs[currentDocId];
      const title = doc.title || '未命名文档';
      const content = doc.content || '';
      
      switch(selectedDownloadFormat) {
        case 'txt':
          downloadAsTxt(title, content);
          break;
        case 'docx':
          downloadAsDocx(title, content);
          break;
        case 'pdf':
          downloadAsPdf(title, content);
          break;
        case 'html':
          downloadAsHtml(title, content);
          break;
      }
      
      closeFormatModal();
      showNotification(`文档已以${getFormatName(selectedDownloadFormat)}格式下载`, 'success');
    }
    
    // 下载为TXT
    function downloadAsTxt(title, content) {
      const text = stripHtml(content);
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      saveAs(blob, `${title}.txt`);
    }
    
    // 下载为DOCX
    function downloadAsDocx(title, content) {
      // 使用docx模板生成文档
      const template = '{"content": "<w:p><w:r><w:t>{{content}}</w:t></w:r></w:p>"}';
      const zip = new PizZip(template);
      const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
      
      // 处理内容，移除HTML标签
      const text = stripHtml(content);
      
      doc.setData({
        content: text
      });
      
      try {
        doc.render();
      } catch (error) {
        console.error('DOCX生成错误:', error);
        showNotification('DOCX格式下载失败', 'error');
        return;
      }
      
      const out = doc.getZip().generate({
        type: 'blob',
        mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      });
      
      saveAs(out, `${title}.docx`);
    }
    
    // 下载为PDF
    function downloadAsPdf(title, content) {
      // 简单的PDF生成示例
      const text = stripHtml(content);
      const blob = new Blob([`
        <html>
          <head>
            <title>${title}</title>
            <meta charset="utf-8">
          </head>
          <body>
            <h1>${title}</h1>
            <p>${text.replace(/\n/g, '<br>')}</p>
          </body>
        </html>
      `], { type: 'text/html' });
      
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${title}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    
    // 下载为HTML
    function downloadAsHtml(title, content) {
      const html = `
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <title>${title}</title>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
            h1 { color: #333; }
            .postgrad-high { background-color: #dbeafe; padding: 0 3px; border-bottom: 2px solid #3b82f6; }
            .postgrad-mid { background-color: #eff6ff; padding: 0 3px; border-bottom: 2px solid #93c5fd; }
          </style>
        </head>
        <body>
          <h1>${title}</h1>
          <div>${content}</div>
        </body>
        </html>
      `;
      
      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      saveAs(blob, `${title}.html`);
    }
    
    // 下载重点卡片库
    function downloadFocusCards() {
      if (focusCards.length === 0) {
        showNotification('重点卡片库为空，无需下载', 'info');
        return;
      }
      
      // 准备要下载的数据（包含卡片和文件夹）
      const data = {
        folders: folders,
        cards: focusCards,
        exportTime: new Date().toISOString()
      };
      
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      saveAs(blob, `重点卡片库_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`);
      
      showNotification('重点卡片库已下载', 'success');
      cardLibraryTip.classList.remove('show');
    }
    
    // 上传文档
    function uploadDocument(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const fileName = file.name.replace(/\.[^/.]+$/, "");
      const fileExt = file.name.split('.').pop().toLowerCase();
      
      const reader = new FileReader();
      
      switch(fileExt) {
        case 'txt':
          reader.onload = function(e) {
            const content = e.target.result;
            const id = generateUUID();
            docs[id] = {
              id: id,
              title: fileName,
              content: `<p>${content.replace(/\n/g, '</p><p>')}</p>`,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              timeline: []
            };
            // 修改：不保存到localStorage
            renderDocsList();
            showNotification(`TXT文档"${fileName}"已上传`, 'success');
          };
          reader.readAsText(file);
          break;
          
        case 'docx':
          reader.onload = function(e) {
            try {
              const content = extractDocxContent(e.target.result);
              const id = generateUUID();
              docs[id] = {
                id: id,
                title: fileName,
                content: `<p>${content.replace(/\n/g, '</p><p>')}</p>`,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                timeline: []
              };
              // 修改：不保存到localStorage
              renderDocsList();
              showNotification(`Word文档"${fileName}"已上传`, 'success');
            } catch (error) {
              console.error('DOCX解析错误:', error);
              showNotification('Word文档解析失败', 'error');
            }
          };
          reader.readAsArrayBuffer(file);
          break;
          
        case 'html':
          reader.onload = function(e) {
            const content = e.target.result;
            const id = generateUUID();
            docs[id] = {
              id: id,
              title: fileName,
              content: content,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              timeline: []
            };
            // 修改：不保存到localStorage
            renderDocsList();
            showNotification(`HTML文档"${fileName}"已上传`, 'success');
          };
          reader.readAsText(file);
          break;
          
        default:
          showNotification(`不支持的文件格式: ${fileExt}`, 'error');
      }
      
      // 重置文件输入，允许重复上传同一文件
      uploadDocBtn.value = '';
    }
    
    // 从DOCX提取内容
    function extractDocxContent(arrayBuffer) {
      const zip = new PizZip(arrayBuffer);
      const xmlContent = zip.file('word/document.xml').asText();
      
      // 简单解析XML获取文本内容
      let text = xmlContent
        .replace(/<[^>]+>/g, ' ')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/\s+/g, ' ')
        .trim();
      
      return text;
    }
    
    // 上传重点卡片库
    function uploadFocusCards(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.name.endsWith('.json')) {
        showNotification('请上传JSON格式的卡片库文件', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.folders && Array.isArray(data.folders) && 
              data.cards && Array.isArray(data.cards)) {
              
            // 合并文件夹（避免重复）
            data.folders.forEach(folder => {
              if (!folders.some(f => f.name === folder.name)) {
                folders.push({
                  ...folder,
                  id: generateUUID() // 生成新ID避免冲突
                });
              }
            });
            
            // 合并卡片
            data.cards.forEach(card => {
              // 查找文件夹新ID
              let newFolderId = '';
              if (card.folderId) {
                const originalFolder = data.folders.find(f => f.id === card.folderId);
                if (originalFolder) {
                  const newFolder = folders.find(f => f.name === originalFolder.name);
                  if (newFolder) {
                    newFolderId = newFolder.id;
                  }
                }
              }
              
              focusCards.push({
                ...card,
                id: generateUUID(), // 生成新ID避免冲突
                folderId: newFolderId,
                updatedAt: new Date().toISOString()
              });
            });
            
            // 修改：不保存到localStorage
            renderFolders();
            renderFocusCards();
            showNotification('重点卡片库已导入', 'success');
          } else {
            showNotification('无效的卡片库文件格式', 'error');
          }
        } catch (error) {
          console.error('卡片库解析错误:', error);
          showNotification('卡片库文件解析失败', 'error');
        }
      };
      reader.readAsText(file);
      
      // 重置文件输入
      e.target.value = '';
    }
    
    // 获取格式名称
    function getFormatName(format) {
      const names = {
        'txt': 'TXT文本',
        'docx': 'Word文档',
        'pdf': 'PDF文档',
        'html': 'HTML网页'
      };
      return names[format] || format;
    }
    
    // 显示通知
    function showNotification(message, type = 'info') {
      notificationText.textContent = message;
      
      // 设置图标
      notificationIcon.className = '';
      switch(type) {
        case 'success':
          notificationIcon.className = 'fa fa-check-circle text-green-500 mr-2';
          break;
        case 'error':
          notificationIcon.className = 'fa fa-exclamation-circle text-red-500 mr-2';
          break;
        case 'warning':
          notificationIcon.className = 'fa fa-exclamation-triangle text-yellow-500 mr-2';
          break;
        default:
          notificationIcon.className = 'fa fa-info-circle text-blue-500 mr-2';
      }
      
      // 显示通知
      notification.classList.remove('translate-y-full', 'opacity-0');
      notification.classList.add('translate-y-0', 'opacity-1');
      
      // 3秒后隐藏
      setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-1');
        notification.classList.add('translate-y-full', 'opacity-0');
      }, 3000);
    }
    
    // 生成UUID
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    // 去除HTML标签
    function stripHtml(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || div.innerText || '';
    }
    
    // 绑定事件
    function bindEvents() {
      // 视图切换事件
      backToDocsBtn.addEventListener('click', showDocsList);
      newDocBtn.addEventListener('click', createNewDoc);
      saveDocBtn.addEventListener('click', saveDoc);
      focusCardsBtn.addEventListener('click', showFocusCards);
      backFromCardsBtn.addEventListener('click', showDocsList);
      
      // 文本格式工具事件
      document.querySelectorAll('[data-command]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.execCommand(btn.dataset.command, false, null);
          editor.focus();
        });
      });
      
      // 笔记标签事件
      document.querySelectorAll('.note-tag[data-tag]').forEach(btn => {
        btn.addEventListener('click', () => {
          const selection = window.getSelection();
          if (!selection.rangeCount) return;
          const tag = btn.dataset.tag;
          const span = document.createElement('span');
          span.className = `note-tag ${btn.className.split(' ').find(c => c.startsWith('bg-note-'))}`;
          span.textContent = `[${tag}]`;
          
          const range = selection.getRangeAt(0);
          range.collapse(false);
          range.insertNode(span);
          range.insertNode(document.createTextNode(' '));
          range.collapse(false);
          
          editor.focus();
        });
      });
      
      // 重点卡片相关事件
      addFocusCardBtn.addEventListener('click', addSelectedToFocusCards);
      document.getElementById('cancelCard').addEventListener('click', () => {
        cardModal.classList.add('hidden');
      });
      document.getElementById('confirmCard').addEventListener('click', saveCard);
      
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.card-type-btn').forEach(b => {
            b.classList.remove('ring-2', 'ring-primary');
          });
          btn.classList.add('ring-2', 'ring-primary');
        });
      });
      
      // 搜索卡片事件
      searchCards.addEventListener('input', () => {
        const filter = document.querySelector('.note-tag.ring-2')?.dataset.filter || 'all';
        renderFocusCards(filter, searchCards.value);
      });
      
      // 卡片筛选事件
      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-filter]').forEach(b => {
            b.classList.remove('ring-2', 'ring-primary');
          });
          btn.classList.add('ring-2', 'ring-primary');
          renderFocusCards(btn.dataset.filter, searchCards.value);
        });
      });
      
      // 文件夹相关事件
      addFolderBtn.addEventListener('click', () => {
        folderModal.classList.remove('hidden');
        folderName.focus();
      });
      cancelFolder.addEventListener('click', () => {
        folderModal.classList.add('hidden');
      });
      confirmFolder.addEventListener('click', createFolder);
      
      // 移动卡片相关事件
      cancelMoveCard.addEventListener('click', () => {
        moveCardModal.classList.add('hidden');
      });
      confirmMoveCard.addEventListener('click', moveCardToFolder);
      
      // 时间线相关事件
      addTimelineBtn.addEventListener('click', addTimeline);
      document.getElementById('cancelTimeline').addEventListener('click', () => {
        timelineModal.classList.add('hidden');
      });
      document.getElementById('confirmTimeline').addEventListener('click', confirmTimeline);
      
      // 翻译相关事件
      translateToggleBtn.addEventListener('click', toggleTranslate);
      editor.addEventListener('mouseup', showTranslatePopup);
      translateSentenceBtn.addEventListener('click', translateSelected);
      
      // 考研词汇相关事件
      togglePostGradWords.addEventListener('click', togglePostgradHighlight);
      
      // 编辑器内容变化事件
      editor.addEventListener('input', () => {
        highlightPostgradWords();
        updateWordStats();
        autoSaveDoc();
      });
      
      // 文档标题变化事件
      docTitle.addEventListener('input', autoSaveDoc);
      
      // 搜索文档事件
      searchDocs.addEventListener('input', () => {
        const keyword = searchDocs.value.toLowerCase();
        const docItems = document.querySelectorAll('.doc-item');
        docItems.forEach(item => {
          const title = item.querySelector('h3').textContent.toLowerCase();
          const content = item.querySelector('p.text-xs').textContent.toLowerCase();
          if (title.includes(keyword) || content.includes(keyword)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      });
      
      // 语音相关事件
      textToSpeechBtn.addEventListener('click', textToSpeech);
      stopSpeechBtn.addEventListener('click', stopSpeech);
      speechRateSlider.addEventListener('input', () => {
        speechRate = parseFloat(speechRateSlider.value);
        if (currentUtterance) {
          currentUtterance.rate = speechRate;
        }
        saveUserSettings();
      });
      
      // 文档下载相关事件
      downloadDocBtn.addEventListener('click', () => {
        if (!currentDocId || !docs[currentDocId]) {
          showNotification('请先打开一个文档', 'info');
          return;
        }
        openFormatModal();
      });
      
      // 格式选择弹窗事件
      formatModalClose.addEventListener('click', closeFormatModal);
      formatModalConfirm.addEventListener('click', downloadDocument);
      formatOptions.forEach(option => {
        option.addEventListener('click', () => {
          selectDownloadFormat(option.dataset.format);
        });
      });
      
      // 卡片库下载事件
      downloadCardsBtn.addEventListener('click', downloadFocusCards);
      tipDownloadBtn.addEventListener('click', downloadFocusCards);
      
      // 文档上传事件
      uploadDocBtn.addEventListener('change', uploadDocument);
      
      // 卡片库上传（通过隐藏的input）
      const uploadCardsInput = document.createElement('input');
      uploadCardsInput.type = 'file';
      uploadCardsInput.accept = '.json';
      uploadCardsInput.className = 'hidden';
      uploadCardsInput.addEventListener('change', uploadFocusCards);
      document.body.appendChild(uploadCardsInput);
      
      // 界面设置事件
      settingsBtn.addEventListener('click', () => {
        settingsPanel.classList.add('open');
      });
      closeSettingsBtn.addEventListener('click', () => {
        settingsPanel.classList.remove('open');
      });
      
      // 主题切换事件
      themeToggle.addEventListener('change', () => {
        document.documentElement.classList.toggle('dark-mode');
        saveUserSettings();
      });
      
      // 字体大小设置事件
      fontSizeOptions.forEach(option => {
        option.addEventListener('click', () => {
          fontSizeOptions.forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          document.documentElement.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl');
          document.documentElement.classList.add(`font-size-${option.dataset.size}`);
          saveUserSettings();
        });
      });
      
      // 功能设置变化事件
      autoSaveToggle.addEventListener('change', saveUserSettings);
      autoTranslateToggle.addEventListener('change', () => {
        isTranslateEnabled = autoTranslateToggle.checked;
        translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      });
      autoHighlightToggle.addEventListener('change', () => {
        isPostGradHighlightEnabled = autoHighlightToggle.checked;
        postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
        if (isPostGradHighlightEnabled) {
          highlightPostgradWords();
          updateWordStats();
        } else {
          removePostgradHighlights();
        }
      });
      
      // 页面保护：禁用右键菜单
      document.addEventListener('contextmenu', e => e.preventDefault());
      
      // 页面保护：禁用F12和右键
      document.addEventListener('keydown', e => {
        // 禁用F12
        if (e.key === 'F12') {
          e.preventDefault();
        }
        // 禁用Ctrl+Shift+I
        if (e.ctrlKey && e.shiftKey && e.key === 'I') {
          e.preventDefault();
        }
      });
      
      // 页面保护：禁止编辑模式
      document.body.contentEditable = 'false';
      document.designMode = 'off';
    }
    
    // 初始化应用
    init();
  </script>
</body>
</html>
