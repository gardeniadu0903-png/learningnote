

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>考研笔记平台 - 个性化学习平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            note: {
              blue: '#dbeafe',
              green: '#dcfce7',
              yellow: '#fef3c7',
              red: '#fee2e2',
              purple: '#f3e8ff'
            },
            postgrad: {
              high: '#dbeafe',
              mid: '#eff6ff'
            },
            dark: {
              bg: '#1e293b',
              card: '#334155',
              text: '#f8fafc'
            }
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .btn-tool { @apply p-2 rounded-md hover:bg-gray-100 transition-colors; }
      .note-tag { @apply px-2 py-1 rounded-full text-xs font-medium cursor-pointer; }
      .postgrad-high { @apply bg-postgrad-high px-1 rounded border-b-2 border-primary cursor-help; }
      .postgrad-mid { @apply bg-postgrad-mid px-1 rounded border-b-2 border-blue-400 cursor-help; }
      .translate-result { @apply bg-green-50 p-3 rounded my-2 text-sm border border-green-100; }
      .folder-active { @apply bg-blue-50 border-l-4 border-primary; }
      
      /* 深色模式样式 */
      .dark-mode {
        --bg-color: #1e293b;
        --card-color: #334155;
        --text-color: #f8fafc;
        --border-color: #475569;
        --hover-color: #475569;
      }
      
      .dark-mode body {
        background-color: var(--bg-color);
        color: var(--text-color);
      }
      
      .dark-mode .bg-white {
        background-color: var(--card-color);
      }
      
      .dark-mode .text-gray-800 {
        color: var(--text-color);
      }
      
      .dark-mode .text-gray-600,
      .dark-mode .text-gray-500 {
        color: #cbd5e1;
      }
      
      .dark-mode .border-gray-200,
      .dark-mode .border-gray-100 {
        border-color: var(--border-color);
      }
      
      .dark-mode .hover:bg-gray-50,
      .dark-mode .hover:bg-gray-100 {
        background-color: var(--hover-color);
      }
      
      .dark-mode .postgrad-high {
        background-color: #1e3a8a;
        color: #dbeafe;
      }
      
      .dark-mode .postgrad-mid {
        background-color: #3b82f6;
        color: #eff6ff;
      }
      
      .dark-mode .translate-result {
        background-color: #065f46;
        border-color: #059669;
        color: #dcfce7;
      }
    }

    #editor {
      line-height: 1.6;
      outline: none;
      min-height: 500px;
      font-size: 16px;
      transition: font-size 0.3s ease;
    }
    
    .font-size-sm #editor {
      font-size: 14px;
    }
    
    .font-size-md #editor {
      font-size: 16px;
    }
    
    .font-size-lg #editor {
      font-size: 18px;
    }
    
    .font-size-xl #editor {
      font-size: 20px;
    }

    #editor p { margin: 0 0 1em 0; }
    #translatePopup {
      position: absolute;
      z-index: 100;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      padding: 12px;
      width: 320px;
      display: none;
    }
    .timeline-item {
      position: relative;
      padding-left: 24px;
    }
    .timeline-item:before {
      content: '';
      position: absolute;
      left: 6px;
      top: 6px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3b82f6;
    }
    .timeline-item:after {
      content: '';
      position: absolute;
      left: 10px;
      top: 14px;
      width: 1px;
      height: calc(100% + 10px);
      background: #e5e7eb;
    }
    .timeline-item:last-child:after { display: none; }
    .focus-card {
      border-left: 4px solid #3b82f6;
    }
    .focus-card.note-blue { border-left-color: #3b82f6; }
    .focus-card.note-yellow { border-left-color: #f59e0b; }
    .focus-card.note-green { border-left-color: #10b981; }
    .focus-card.note-red { border-left-color: #ef4444; }
    
    /* 语音控制样式 */
    .voice-controls {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .voice-selector {
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      font-size: 12px;
    }
    
    /* 界面设置面板 */
    #settingsPanel {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
    }
    
    #settingsPanel.open {
      right: 0;
    }
    
    .settings-section {
      margin-bottom: 25px;
    }
    
    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }
    
    .font-size-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .font-size-option {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .font-size-option.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #3b82f6;
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    .theme-options {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen transition-all duration-300">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-book text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-gray-800">笔记平台</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="settingsBtn" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
          <i class="fa fa-cog mr-1"></i>设置
        </button>
        <button id="focusCardsBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
          <i class="fa fa-flag mr-2"></i>重点卡片库
        </button>
        <button id="backToDocsBtn" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-gray-600 transition-colors hidden">
          <i class="fa fa-arrow-left mr-2"></i>返回文件列表
        </button>
        <button id="exportDataBtn" class="px-3 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition-colors">
          <i class="fa fa-download mr-1"></i>导出数据
        </button>
        <label for="importDataBtn" class="px-3 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors cursor-pointer">
          <i class="fa fa-upload mr-1"></i>导入数据
        </label>
        <input type="file" id="importDataBtn" accept=".json" class="hidden">
        <button id="newDocBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-colors">
          <i class="fa fa-file-o mr-2"></i>新建文档
        </button>
        <button id="saveDocBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors hidden">
          <i class="fa fa-save mr-2"></i>保存
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-6">
    <!-- 1. 文件列表视图 -->
    <div id="docsListView" class="block">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">我的文档</h2>
          <div class="text-sm text-gray-500">
            共 <span id="docsCount">0</span> 个文档
          </div>
        </div>
        <div class="mb-4">
          <div class="relative">
            <input type="text" id="searchDocs" class="w-full border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="搜索文档...">
            <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
          </div>
        </div>
        <div id="docsList" class="max-h-[600px] overflow-y-auto border border-gray-200 rounded-md">
          <div class="p-8 text-center text-gray-500">
            <i class="fa fa-file-text-o text-4xl mb-4 text-gray-300"></i>
            <p>暂无文档，点击"新建文档"开始创建</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. 文档编辑视图 -->
    <div id="docEditView" class="hidden">
      <div class="mb-6">
        <input type="text" id="docTitle" class="w-full text-2xl font-bold border-none outline-none bg-transparent placeholder-gray-400" placeholder="输入文档标题（如：考研英语笔记）">
      </div>

      <div class="bg-white border-b border-gray-200 p-3 mb-6 rounded-lg">
        <div class="flex flex-wrap gap-2">
          <!-- 文本格式工具 -->
          <div class="flex items-center space-x-1">
            <button class="btn-tool" data-command="bold" title="加粗"><i class="fa fa-bold"></i></button>
            <button class="btn-tool" data-command="italic" title="斜体"><i class="fa fa-italic"></i></button>
            <button class="btn-tool" data-command="underline" title="下划线"><i class="fa fa-underline"></i></button>
          </div>

          <div class="h-6 border-r border-gray-300 mx-1"></div>

          <!-- 笔记标签工具 -->
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">笔记标签：</span>
            <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200" data-tag="重点">重点</button>
            <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200" data-tag="疑问">疑问</button>
            <button class="note-tag bg-note-green text-green-800 hover:bg-green-200" data-tag="例题">例题</button>
            <button class="note-tag bg-note-red text-red-800 hover:bg-red-200" data-tag="易错">易错</button>
          </div>

          <div class="h-6 border-r border-gray-300 mx-1"></div>

          <!-- 重点卡片工具 -->
          <button class="btn-tool bg-purple-100 text-purple-700 hover:bg-purple-200" id="addFocusCardBtn" title="添加到重点卡片库">
            <i class="fa fa-flag mr-1"></i> 转为重点卡片
          </button>

          <div class="h-6 border-r border-gray-300 mx-1"></div>

          <!-- 考研词汇工具 -->
          <div class="flex items-center space-x-2">
            <button class="btn-tool bg-blue-100 text-blue-700 hover:bg-blue-200" id="togglePostGradWords" title="考研词汇标注">
              <i class="fa fa-bookmark mr-1"></i> 考研词汇
            </button>
            <span class="text-sm text-gray-600" id="postgradStatus">自动标注：开启</span>
          </div>

          <div class="h-6 border-r border-gray-300 mx-1"></div>

          <!-- 时间线工具 -->
          <button class="btn-tool bg-purple-100 text-purple-700 hover:bg-purple-200" id="addTimelineBtn" title="添加课堂时间点">
            <i class="fa fa-clock-o mr-1"></i> 时间点
          </button>

          <div class="h-6 border-r border-gray-300 mx-1"></div>

          <!-- 翻译工具 -->
          <div class="flex items-center space-x-2">
            <button class="btn-tool" id="translateToggleBtn" title="翻译开关">
              <i class="fa fa-language text-primary"></i>
            </button>
            <span class="text-sm text-gray-600" id="translateStatus">翻译：开启（单词/句子）</span>
            <button class="btn-tool bg-green-100 text-green-700 hover:bg-green-200 ml-2" id="translateSentenceBtn" title="翻译选中的句子">
              <i class="fa fa-translate mr-1"></i>一键翻译
            </button>
          </div>

          <div class="h-6 border-r border-gray-300 mx-1"></div>

          <!-- 文字转语音工具 -->
          <div class="voice-controls">
            <select id="voiceSelect" class="voice-selector">
              <option value="">选择语音</option>
              <!-- 语音选项将动态生成 -->
            </select>
            <button class="btn-tool bg-rose-100 text-rose-700 hover:bg-rose-200" id="textToSpeechBtn" title="朗读选中的文本">
              <i class="fa fa-volume-up mr-1"></i> 开始朗读
            </button>
            <button class="btn-tool bg-rose-100 text-rose-700 hover:bg-rose-200 hidden" id="stopSpeechBtn" title="停止朗读">
              <i class="fa fa-volume-off mr-1"></i> 停止朗读
            </button>
          </div>
        </div>
      </div>

      <div class="flex gap-6">
        <div class="relative flex-1">
          <div id="translatePopup" class="absolute z-10">
            <div class="font-bold text-lg mb-1 flex justify-between">
              <span id="popupSource"></span>
              <span class="text-xs px-2 py-0.5 bg-gray-100 rounded" id="popupType">单词翻译</span>
            </div>
            <div class="text-sm text-gray-600 mb-2" id="popupPhonetic"></div>
            <div id="popupExplains" class="text-sm"></div>
            <div class="text-xs text-gray-500 mt-2" id="popupPostgradNote"></div>
          </div>
          <div id="editor" class="bg-white rounded-lg p-6 min-h-[500px] focus:outline-none" contenteditable="true">
            <p>在这里开始记录考研笔记...<br><br>功能说明：<br>1. 英文单词/句子会自动翻译（选中即可查看）<br>2. 考研高频词汇会自动标注（蓝色背景）<br>3. 可添加重点卡片用于复习，支持文件夹分类<br>4. 可添加课堂时间点记录关键内容<br>5. 选中文字后点击"开始朗读"可进行文字转语音</p>
            <p><br>示例：The <span class="postgrad-high" title="高频词：n. 能力，才能">ability</span> to <span class="postgrad-high" title="高频词：v. 放弃，抛弃">abandon</span> old ideas is crucial for success.</p>
          </div>
        </div>

        <div class="w-64 bg-white rounded-lg p-4 shadow-sm">
          <h3 class="font-bold text-gray-800 mb-3 flex items-center">
            <i class="fa fa-bar-chart text-blue-500 mr-2"></i> 词汇统计
          </h3>
          <div class="text-sm space-y-4 max-h-[250px] overflow-y-auto mb-6">
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>总考研词汇数</span>
              <span id="totalPostgradCount" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>高频词汇</span>
              <span id="highFreqCount" class="font-medium text-blue-600">0</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b border-gray-100">
              <span>中频词汇</span>
              <span id="midFreqCount" class="font-medium text-blue-600">0</span>
            </div>
          </div>

          <h3 class="font-bold text-gray-800 mb-3 flex items-center">
            <i class="fa fa-history text-purple-500 mr-2"></i> 课堂时间线
          </h3>
          <div id="timelineContainer" class="text-sm space-y-4 max-h-[250px] overflow-y-auto">
            <div class="text-gray-500 text-center text-sm py-4">
              点击"时间点"添加课堂关键节点
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. 重点卡片库视图（含文件夹分类） -->
    <div id="focusCardsView" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">
            <i class="fa fa-flag text-purple-500 mr-2"></i>重点复习卡片库
          </h2>
          <div class="flex gap-2">
            <button id="addFolderBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
              <i class="fa fa-folder mr-1"></i>新建文件夹
            </button>
            <button id="backFromCardsBtn" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-gray-600 transition-colors">
              <i class="fa fa-arrow-left mr-2"></i>返回
            </button>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-6">
          <!-- 左侧文件夹列表 -->
          <div class="w-64 flex-shrink-0">
            <div class="bg-gray-50 rounded-lg p-4 h-full">
              <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-folder-open text-indigo-500 mr-2"></i> 文件夹
              </h3>
              <div class="space-y-1 mb-4">
                <div class="folder-item p-2 rounded hover:bg-gray-100 cursor-pointer flex items-center" data-id="all">
                  <i class="fa fa-folder-open-o text-gray-500 mr-2"></i>
                  <span>所有卡片</span>
                </div>
              </div>
              <div id="foldersList" class="space-y-1 max-h-[400px] overflow-y-auto">
                <div class="text-gray-500 text-sm italic p-2">暂无自定义文件夹</div>
              </div>
            </div>
          </div>
          
          <!-- 右侧卡片内容区 -->
          <div class="flex-1">
            <div class="flex flex-wrap gap-3 mb-6">
              <div class="relative flex-1 max-w-md">
                <input type="text" id="searchCards" class="w-full border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="搜索重点卡片...">
                <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">筛选：</span>
                <button class="note-tag bg-gray-100 text-gray-800 hover:bg-gray-200 ring-2 ring-primary" data-filter="all">全部</button>
                <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200" data-filter="重点">重点</button>
                <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200" data-filter="疑问">疑问</button>
                <button class="note-tag bg-note-green text-green-800 hover:bg-green-200" data-filter="例题">例题</button>
                <button class="note-tag bg-note-red text-red-800 hover:bg-red-200" data-filter="易错">易错</button>
              </div>
            </div>
            
            <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="col-span-full p-12 text-center text-gray-500">
                <i class="fa fa-flag-o text-5xl mb-4 text-gray-300"></i>
                <p class="text-lg">暂无重点卡片</p>
                <p class="mt-2">在笔记中选中内容，点击"转为重点卡片"添加到这里</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 界面设置面板 -->
  <div id="settingsPanel">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold text-gray-800">界面设置</h2>
      <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-700">
        <i class="fa fa-times text-xl"></i>
      </button>
    </div>
    
    <div class="settings-section">
      <h3>主题模式</h3>
      <div class="theme-options">
        <span>浅色模式</span>
        <label class="theme-switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <span>深色模式</span>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>字体大小</h3>
      <p class="text-sm text-gray-500 mb-2">设置编辑器字体大小</p>
      <div class="font-size-options">
        <div class="font-size-option" data-size="sm">A</div>
        <div class="font-size-option active" data-size="md">A</div>
        <div class="font-size-option" data-size="lg">A</div>
        <div class="font-size-option" data-size="xl">A</div>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>语音设置</h3>
      <p class="text-sm text-gray-500 mb-2">默认语音速度</p>
      <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" 
             class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
      <div class="flex justify-between text-xs text-gray-500 mt-1">
        <span>慢速</span>
        <span>正常</span>
        <span>快速</span>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>功能设置</h3>
      <div class="space-y-3">
        <div class="flex items-center">
          <input type="checkbox" id="autoSaveToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoSaveToggle" class="ml-2 text-sm text-gray-700">自动保存笔记内容</label>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="autoTranslateToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoTranslateToggle" class="ml-2 text-sm text-gray-700">自动翻译英文内容</label>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="autoHighlightToggle" checked 
                 class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
          <label for="autoHighlightToggle" class="ml-2 text-sm text-gray-700">自动标注考研词汇</label>
        </div>
      </div>
    </div>
  </div>

  <!-- 时间点添加弹窗 -->
  <div id="timelineModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">添加课堂时间点</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">时间（如：45:30）</label>
        <input type="text" id="timelineTime" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="例如：30:15（分钟:秒）">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">内容描述</label>
        <input type="text" id="timelineContent" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="记录此时的课堂重点...">
      </div>
      <div class="flex justify-end">
        <button id="cancelTimeline" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmTimeline" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600">确认</button>
      </div>
    </div>
  </div>

  <!-- 文件夹弹窗 -->
  <div id="folderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">新建文件夹</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">文件夹名称</label>
        <input type="text" id="folderName" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="例如：考研英语高频词、数学公式">
      </div>
      <div class="flex justify-end">
        <button id="cancelFolder" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmFolder" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">创建</button>
      </div>
    </div>
  </div>

  <!-- 卡片移动弹窗 -->
  <div id="moveCardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">移动到文件夹</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">选择文件夹</label>
        <div id="folderSelectList" class="space-y-2 max-h-[200px] overflow-y-auto">
          <!-- 文件夹选项将动态生成 -->
        </div>
      </div>
      <div class="flex justify-end">
        <button id="cancelMoveCard" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmMoveCard" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600">确认移动</button>
      </div>
    </div>
  </div>

  <!-- 重点卡片编辑弹窗 -->
  <div id="cardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">编辑重点卡片</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">卡片标题</label>
        <input type="text" id="cardTitle" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="给重点内容起个标题...">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">所属文件夹</label>
        <select id="cardFolderSelect" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="">-- 未分类 --</option>
          <!-- 文件夹选项将动态生成 -->
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">卡片类型</label>
        <div class="flex gap-2">
          <button class="note-tag bg-note-blue text-blue-800 hover:bg-blue-200 card-type-btn" data-type="重点">重点</button>
          <button class="note-tag bg-note-yellow text-amber-800 hover:bg-amber-200 card-type-btn" data-type="疑问">疑问</button>
          <button class="note-tag bg-note-green text-green-800 hover:bg-green-200 card-type-btn" data-type="例题">例题</button>
          <button class="note-tag bg-note-red text-red-800 hover:bg-red-200 card-type-btn" data-type="易错">易错</button>
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">重点内容</label>
        <div id="cardContent" class="w-full border border-gray-300 rounded-md p-4 min-h-[100px]" contenteditable="true"></div>
      </div>
      <div class="flex justify-end">
        <button id="cancelCard" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mr-2">取消</button>
        <button id="confirmCard" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600">保存卡片</button>
      </div>
    </div>
  </div>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-4 right-4 bg-white shadow-lg rounded-md px-4 py-3 transform translate-y-full opacity-0 transition-all duration-300 flex items-center">
    <i id="notificationIcon" class="fa fa-check-circle text-green-500 mr-2"></i>
    <span id="notificationText" class="text-gray-800"></span>
  </div>

  <script>
    // 全局变量
    let currentDocId = null;
    let docs = JSON.parse(localStorage.getItem('docs')) || {};
    let focusCards = JSON.parse(localStorage.getItem('focusCards')) || [];
    let folders = JSON.parse(localStorage.getItem('cardFolders')) || [];
    let isTranslateEnabled = true;
    let isPostGradHighlightEnabled = true;
    let currentCardId = null;
    let currentFolderId = 'all';
    let detectedWords = new Set();
    let postGradWords = [];
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let voices = [];
    let speechRate = 1;

    // DOM元素
    const docsListView = document.getElementById('docsListView');
    const docEditView = document.getElementById('docEditView');
    const focusCardsView = document.getElementById('focusCardsView');
    const docsList = document.getElementById('docsList');
    const docsCount = document.getElementById('docsCount');
    const searchDocs = document.getElementById('searchDocs');
    const backToDocsBtn = document.getElementById('backToDocsBtn');
    const newDocBtn = document.getElementById('newDocBtn');
    const saveDocBtn = document.getElementById('saveDocBtn');
    const docTitle = document.getElementById('docTitle');
    const editor = document.getElementById('editor');
    const addFocusCardBtn = document.getElementById('addFocusCardBtn');
    const focusCardsBtn = document.getElementById('focusCardsBtn');
    const backFromCardsBtn = document.getElementById('backFromCardsBtn');
    const cardsContainer = document.getElementById('cardsContainer');
    const searchCards = document.getElementById('searchCards');
    const timelineModal = document.getElementById('timelineModal');
    const cardModal = document.getElementById('cardModal');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    const notificationIcon = document.getElementById('notificationIcon');
    const translatePopup = document.getElementById('translatePopup');
    const translateToggleBtn = document.getElementById('translateToggleBtn');
    const translateStatus = document.getElementById('translateStatus');
    const togglePostGradWords = document.getElementById('togglePostGradWords');
    const postgradStatus = document.getElementById('postgradStatus');
    const translateSentenceBtn = document.getElementById('translateSentenceBtn');
    const totalPostgradCount = document.getElementById('totalPostgradCount');
    const highFreqCount = document.getElementById('highFreqCount');
    const midFreqCount = document.getElementById('midFreqCount');
    const timelineContainer = document.getElementById('timelineContainer');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const foldersList = document.getElementById('foldersList');
    const addFolderBtn = document.getElementById('addFolderBtn');
    const folderModal = document.getElementById('folderModal');
    const folderName = document.getElementById('folderName');
    const cancelFolder = document.getElementById('cancelFolder');
    const confirmFolder = document.getElementById('confirmFolder');
    const moveCardModal = document.getElementById('moveCardModal');
    const folderSelectList = document.getElementById('folderSelectList');
    const cancelMoveCard = document.getElementById('cancelMoveCard');
    const confirmMoveCard = document.getElementById('confirmMoveCard');
    const cardFolderSelect = document.getElementById('cardFolderSelect');
    const addTimelineBtn = document.getElementById('addTimelineBtn');
    const textToSpeechBtn = document.getElementById('textToSpeechBtn');
    const stopSpeechBtn = document.getElementById('stopSpeechBtn');
    const voiceSelect = document.getElementById('voiceSelect');
    const speechRateSlider = document.getElementById('speechRate');
    
    // 界面设置元素
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const themeToggle = document.getElementById('themeToggle');
    const fontSizeOptions = document.querySelectorAll('.font-size-option');
    const autoSaveToggle = document.getElementById('autoSaveToggle');
    const autoTranslateToggle = document.getElementById('autoTranslateToggle');
    const autoHighlightToggle = document.getElementById('autoHighlightToggle');

    // 初始化
    function init() {
      loadUserSettings();
      loadPostGradWords();
      loadVoices();
      renderDocsList();
      renderFolders();
      bindEvents();
      showNotification('欢迎使用复习笔记平台！', 'info');
    }

    // 加载用户设置
    function loadUserSettings() {
      const settings = JSON.parse(localStorage.getItem('appSettings')) || {
        darkMode: false,
        fontSize: 'md',
        speechRate: 1,
        autoSave: true,
        autoTranslate: true,
        autoHighlight: true
      };
      
      // 应用深色模式
      if (settings.darkMode) {
        document.documentElement.classList.add('dark-mode');
        themeToggle.checked = true;
      }
      
      // 应用字体大小
      document.documentElement.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl');
      document.documentElement.classList.add(`font-size-${settings.fontSize}`);
      fontSizeOptions.forEach(option => {
        if (option.dataset.size === settings.fontSize) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
      
      // 应用语音速度
      speechRate = settings.speechRate;
      speechRateSlider.value = settings.speechRate;
      
      // 应用功能设置
      autoSaveToggle.checked = settings.autoSave;
      autoTranslateToggle.checked = settings.autoTranslate;
      autoHighlightToggle.checked = settings.autoHighlight;
      
      isTranslateEnabled = settings.autoTranslate;
      isPostGradHighlightEnabled = settings.autoHighlight;
      
      translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
    }
    
    // 保存用户设置
    function saveUserSettings() {
      const settings = {
        darkMode: themeToggle.checked,
        fontSize: document.querySelector('.font-size-option.active').dataset.size,
        speechRate: parseFloat(speechRateSlider.value),
        autoSave: autoSaveToggle.checked,
        autoTranslate: autoTranslateToggle.checked,
        autoHighlight: autoHighlightToggle.checked
      };
      
      localStorage.setItem('appSettings', JSON.stringify(settings));
      
      // 更新全局变量
      speechRate = settings.speechRate;
      isTranslateEnabled = settings.autoTranslate;
      isPostGradHighlightEnabled = settings.autoHighlight;
      
      translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
      postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
      
      if (isPostGradHighlightEnabled) {
        highlightPostgradWords();
        updateWordStats();
      } else {
        removePostgradHighlights();
      }
    }

    // 加载考研词汇库
    function loadPostGradWords() {
      postGradWords = [
        { word: "financial", freq: "高频", pos: "adj.", mean: "金融的；财政的" },
        { word: "define", freq: "高频", pos: "v.", mean: "界定；解释" },
        { word: "tolerance", freq: "中频", pos: "n.", mean: "忍受；宽容" },
        { word: "board", freq: "高频", pos: "n./v.", mean: "董事会；上（船）" },
        { word: "blank", freq: "中频", pos: "adj./n.", mean: "空白的；空白" },
        { word: "gap", freq: "高频", pos: "n.", mean: "间隙；差距" },
        { word: "environment", freq: "高频", pos: "n.", mean: "环境" },
        { word: "claim", freq: "高频", pos: "v./n.", mean: "声称；要求" },
        { word: "merit", freq: "中频", pos: "n./v.", mean: "优点；值得" },
        { word: "liberty", freq: "中频", pos: "n.", mean: "自由" },
        { word: "philosophy", freq: "中频", pos: "n.", mean: "哲学" },
        { word: "confused", freq: "高频", pos: "adj.", mean: "困惑的" },
        { word: "quality", freq: "高频", pos: "n./adj.", mean: "质量；优质的" },
        { word: "integrate", freq: "中频", pos: "v.", mean: "（使）合并" },
        { word: "mere", freq: "高频", pos: "adj.", mean: "仅仅的" },
        { word: "urge", freq: "高频", pos: "v./n.", mean: "催促；冲动" },
        { word: "literature", freq: "高频", pos: "n.", mean: "文学；著作" },
        { word: "digital", freq: "高频", pos: "adj.", mean: "数码的" },
        { word: "address", freq: "高频", pos: "v./n.", mean: "处理；地址" },
        { word: "improve", freq: "高频", pos: "v.", mean: "提高" },
      ];
    }

    // 加载语音选项
    function loadVoices() {
      // 语音加载完成时的回调
      speechSynthesis.onvoiceschanged = () => {
        voices = speechSynthesis.getVoices();
        populateVoiceList();
      };
      
      // 初始化获取一次语音列表
      voices = speechSynthesis.getVoices();
      populateVoiceList();
    }
    
    // 填充语音选择下拉框
    function populateVoiceList() {
      voiceSelect.innerHTML = '<option value="">选择语音</option>';
      
      // 按语言分组
      const voiceGroups = {};
      
      voices.forEach(voice => {
        const langGroup = voice.lang.includes('zh') ? '中文语音' : 
                         voice.lang.includes('en') ? '英文语音' : '其他语音';
        
        if (!voiceGroups[langGroup]) {
          voiceGroups[langGroup] = [];
        }
        
        voiceGroups[langGroup].push(voice);
      });
      
      // 添加到下拉框
      Object.keys(voiceGroups).forEach(group => {
        // 添加分组标题
        const optionGroup = document.createElement('optgroup');
        optionGroup.label = group;
        voiceSelect.appendChild(optionGroup);
        
        // 添加该组下的所有语音
        voiceGroups[group].forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.voiceURI;
          option.textContent = `${voice.name} (${voice.lang})`;
          optionGroup.appendChild(option);
        });
      });
    }

    // 视图切换
    function showDocsList() {
      docsListView.classList.remove('hidden');
      docEditView.classList.add('hidden');
      focusCardsView.classList.add('hidden');
      backToDocsBtn.classList.add('hidden');
      saveDocBtn.classList.add('hidden');
      currentDocId = null;
    }

    function showDocEditor() {
      docsListView.classList.add('hidden');
      docEditView.classList.remove('hidden');
      focusCardsView.classList.add('hidden');
      backToDocsBtn.classList.remove('hidden');
      saveDocBtn.classList.remove('hidden');
      if (isPostGradHighlightEnabled) {
        highlightPostgradWords();
        updateWordStats();
      }
    }

    function showFocusCards() {
      docsListView.classList.add('hidden');
      docEditView.classList.add('hidden');
      focusCardsView.classList.remove('hidden');
      renderFolders();
      renderFocusCards();
    }

    // 渲染文件列表
    function renderDocsList() {
      const docIds = Object.keys(docs);
      docsCount.textContent = docIds.length;

      if (docIds.length === 0) {
        docsList.innerHTML = `
          <div class="p-8 text-center text-gray-500">
            <i class="fa fa-file-text-o text-4xl mb-4 text-gray-300"></i>
            <p>暂无文档，点击"新建文档"开始创建</p>
          </div>
        `;
        return;
      }

      const sortedIds = docIds.sort((a, b) => 
        new Date(docs[b].updatedAt).getTime() - new Date(docs[a].updatedAt).getTime()
      );

      let html = '';
      sortedIds.forEach(id => {
        const doc = docs[id];
        const date = new Date(doc.updatedAt).toLocaleString();
        html += `
          <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer doc-item" data-id="${id}">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-medium text-gray-800">${doc.title || '无标题文档'}</h3>
                <p class="text-sm text-gray-500 mt-1">最后编辑：${date}</p>
                <p class="text-xs text-gray-400 mt-2 line-clamp-1">${stripHtml(doc.content || '')}</p>
              </div>
              <button class="text-red-500 hover:text-red-700 delete-doc" data-id="${id}">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });

      docsList.innerHTML = html;

      document.querySelectorAll('.doc-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.closest('.delete-doc')) {
            const id = item.dataset.id;
            openDoc(id);
          }
        });
      });

      document.querySelectorAll('.delete-doc').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          if (confirm('确定要删除此文档吗？')) {
            delete docs[id];
            saveDocs();
            renderDocsList();
            showNotification('文档已删除', 'info');
          }
        });
      });
    }

    // 渲染文件夹列表
    function renderFolders() {
      if (folders.length === 0) {
        foldersList.innerHTML = '<div class="text-gray-500 text-sm italic p-2">暂无自定义文件夹</div>';
        updateFolderSelectors();
        return;
      }

      let html = '';
      folders.forEach(folder => {
        const cardCount = focusCards.filter(card => card.folderId === folder.id).length;
        html += `
          <div class="folder-item p-2 rounded hover:bg-gray-100 cursor-pointer flex items-center justify-between ${currentFolderId === folder.id ? 'folder-active' : ''}" data-id="${folder.id}">
            <div class="flex items-center">
              <i class="fa fa-folder-o text-indigo-500 mr-2"></i>
              <span>${folder.name}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-gray-200 px-1.5 rounded">${cardCount}</span>
              <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                <button class="text-gray-400 hover:text-red-500 delete-folder" data-id="${folder.id}">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });

      foldersList.innerHTML = html;

      document.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', () => {
          currentFolderId = item.dataset.id;
          document.querySelectorAll('.folder-item').forEach(i => i.classList.remove('folder-active'));
          item.classList.add('folder-active');
          renderFocusCards();
        });
      });

      document.querySelectorAll('.delete-folder').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const folderId = btn.dataset.id;
          const folder = folders.find(f => f.id === folderId);
          if (confirm(`确定要删除文件夹"${folder.name}"吗？文件夹内的卡片将移至未分类`)) {
            focusCards.forEach(card => {
              if (card.folderId === folderId) {
                card.folderId = '';
              }
            });
            folders = folders.filter(f => f.id !== folderId);
            saveFolders();
            saveFocusCards();
            if (currentFolderId === folderId) {
              currentFolderId = 'all';
              document.querySelector('.folder-item[data-id="all"]').classList.add('folder-active');
            }
            renderFolders();
            renderFocusCards();
            showNotification('文件夹已删除', 'info');
          }
        });
      });

      updateFolderSelectors();
    }

    // 更新文件夹选择器
    function updateFolderSelectors() {
      cardFolderSelect.innerHTML = '<option value="">-- 未分类 --</option>';
      folderSelectList.innerHTML = '';

      folders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = folder.name;
        cardFolderSelect.appendChild(option);

        const div = document.createElement('div');
        div.className = 'p-2 border rounded hover:bg-gray-50 cursor-pointer flex items-center';
        div.innerHTML = `
          <i class="fa fa-folder-o text-indigo-500 mr-2"></i>
          <span>${folder.name}</span>
        `;
        div.dataset.id = folder.id;
        folderSelectList.appendChild(div);

        div.addEventListener('click', () => {
          document.querySelectorAll('#folderSelectList > div').forEach(d => {
            d.classList.remove('ring-2', 'ring-primary');
          });
          div.classList.add('ring-2', 'ring-primary');
        });
      });
    }

    // 创建文件夹
    function createFolder() {
      const name = folderName.value.trim();
      if (!name) {
        showNotification('请输入文件夹名称', 'info');
        return;
      }

      if (folders.some(f => f.name === name)) {
        showNotification('文件夹名称已存在', 'info');
        return;
      }

      folders.push({
        id: generateUUID(),
        name: name,
        createdAt: new Date().toISOString()
      });

      saveFolders();
      folderModal.classList.add('hidden');
      folderName.value = '';
      renderFolders();
      showNotification(`文件夹"${name}"已创建`, 'success');
    }

    // 保存文件夹数据
    function saveFolders() {
      localStorage.setItem('cardFolders', JSON.stringify(folders));
    }

    // 渲染重点卡片库
    function renderFocusCards(filter = 'all', keyword = '') {
      let filteredByFolder = focusCards;
      if (currentFolderId !== 'all') {
        filteredByFolder = focusCards.filter(card => card.folderId === currentFolderId);
      }

      let filteredCards = filteredByFolder;
      if (filter !== 'all') {
        filteredCards = filteredCards.filter(card => card.type === filter);
      }

      if (keyword) {
        const kw = keyword.toLowerCase();
        filteredCards = filteredCards.filter(card => 
          card.title.toLowerCase().includes(kw) || 
          stripHtml(card.content).toLowerCase().includes(kw)
        );
      }

      if (filteredCards.length === 0) {
        cardsContainer.innerHTML = `
          <div class="col-span-full p-12 text-center text-gray-500">
            <i class="fa fa-flag-o text-5xl mb-4 text-gray-300"></i>
            <p class="text-lg">当前${currentFolderId === 'all' ? '没有' : '文件夹中没有'}匹配的卡片</p>
            <p class="mt-2">在笔记中选中内容，点击"转为重点卡片"添加到这里</p>
          </div>
        `;
        return;
      }

      filteredCards.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

      let html = '';
      filteredCards.forEach(card => {
        const folder = folders.find(f => f.id === card.folderId);
        const folderName = folder ? folder.name : '未分类';
        
        html += `
          <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100 focus-card ${card.typeClass} hover:shadow-md transition-all" data-id="${card.id}">
            <div class="flex justify-between items-start mb-2">
              <span class="note-tag ${card.typeClass} text-xs">${card.type}</span>
              <div class="flex gap-1">
                <button class="text-gray-400 hover:text-blue-500 move-card" data-id="${card.id}" title="移动到其他文件夹">
                  <i class="fa fa-folder-open-o"></i>
                </button>
                <button class="text-gray-400 hover:text-primary edit-card" data-id="${card.id}" title="编辑">
                  <i class="fa fa-pencil"></i>
                </button>
                <button class="text-gray-400 hover:text-red-500 delete-card" data-id="${card.id}" title="删除">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">${folderName}</div>
            <h3 class="font-medium text-gray-800 mb-2">${card.title}</h3>
            <div class="text-sm text-gray-600 mb-3 line-clamp-3">${stripHtml(card.content)}</div>
            <div class="text-xs text-gray-400">
              ${new Date(card.createdAt).toLocaleString()}
              ${card.fromDoc ? ` · 来自：${card.fromDoc}` : ''}
            </div>
          </div>
        `;
      });

      cardsContainer.innerHTML = html;

      document.querySelectorAll('.focus-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!e.target.closest('.edit-card') && !e.target.closest('.delete-card') && !e.target.closest('.move-card')) {
            const id = card.dataset.id;
            openCardEditor(id);
          }
        });
      });

      document.querySelectorAll('.edit-card').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          openCardEditor(id);
        });
      });

      document.querySelectorAll('.delete-card').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          if (confirm('确定要删除此重点卡片吗？')) {
            focusCards = focusCards.filter(card => card.id !== id);
            saveFocusCards();
            renderFocusCards();
            showNotification('重点卡片已删除', 'info');
          }
        });
      });

      document.querySelectorAll('.move-card').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          currentCardId = btn.dataset.id;
          document.querySelectorAll('#folderSelectList > div').forEach(d => {
            d.classList.remove('ring-2', 'ring-primary');
          });
          moveCardModal.classList.remove('hidden');
        });
      });
    }

    // 新建文档
    function createNewDoc() {
      const id = generateUUID();
      const now = new Date().toISOString();
      docs[id] = {
        title: '新复习笔记',
        content: '<p>在这里开始记录复习笔记...<br><br>提示：<br>1. 选中文字可添加"重点/疑问"等标签<br>2. 选中重点内容点击"转为重点卡片"，可加入复习库<br>3. 考研词汇会自动标注（蓝色背景）<br>4. 支持文件夹分类管理重点卡片<br>5. 选中文字后点击"开始朗读"可进行文字转语音</p>',
        timeline: [],
        createdAt: now,
        updatedAt: now
      };
      saveDocs();
      openDoc(id);
    }

    // 打开文档
    function openDoc(id) {
      const doc = docs[id];
      if (!doc) return;

      currentDocId = id;
      docTitle.value = doc.title || '';
      editor.innerHTML = doc.content || '';
      renderTimeline(doc.timeline || []);
      showDocEditor();
      editor.focus();
    }

    // 保存文档
    function saveDoc() {
      if (!currentDocId) return;

      const doc = docs[currentDocId];
      doc.title = docTitle.value || '无标题文档';
      doc.content = editor.innerHTML;
      doc.updatedAt = new Date().toISOString();
      saveDocs();
      showNotification('笔记已保存', 'success');
    }

    // 保存重点卡片
    function saveFocusCards() {
      localStorage.setItem('focusCards', JSON.stringify(focusCards));
    }

    // 保存文档到本地
    function saveDocs() {
      localStorage.setItem('docs', JSON.stringify(docs));
    }

    // 生成唯一ID
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    // 显示通知
    function showNotification(text, type = 'info') {
      notificationText.textContent = text;
      notificationIcon.className = type === 'success' 
        ? 'fa fa-check-circle text-green-500 mr-2' 
        : 'fa fa-info-circle text-blue-500 mr-2';
      notification.classList.remove('translate-y-full', 'opacity-0');
      setTimeout(() => {
        notification.classList.add('translate-y-full', 'opacity-0');
      }, 3000);
    }

    // 添加笔记标签
    function addNoteTag(tagType) {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      if (range.collapsed) {
        showNotification('请先选中要标记的内容', 'info');
        return;
      }

      const tagStyles = {
        '重点': 'bg-note-blue text-blue-800',
        '疑问': 'bg-note-yellow text-amber-800',
        '例题': 'bg-note-green text-green-800',
        '易错': 'bg-note-red text-red-800'
      };

      const span = document.createElement('span');
      span.className = `note-highlight ${tagStyles[tagType]} ${tagType}`;
      span.title = `点击取消${tagType}标记`;
      span.appendChild(range.extractContents());
      range.insertNode(span);

      span.addEventListener('click', (e) => {
        e.stopPropagation();
        const parent = span.parentNode;
        while (span.firstChild) {
          parent.insertBefore(span.firstChild, span);
        }
        parent.removeChild(span);
      });

      selection.removeAllRanges();
      editor.focus();
    }

    // 创建重点卡片
    function createFocusCardFromSelection() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      if (range.collapsed) {
        showNotification('请先选中要添加为重点的内容', 'info');
        return;
      }

      const contentHtml = getSelectionHtml();
      const contentText = selection.toString().trim();
      const autoTitle = contentText.length > 20 
        ? contentText.substring(0, 20) + '...' 
        : contentText || '未命名重点';

      currentCardId = null;
      document.getElementById('cardTitle').value = autoTitle;
      document.getElementById('cardContent').innerHTML = contentHtml;
      document.getElementById('cardFolderSelect').value = '';
      
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-primary');
      });
      document.querySelector('.card-type-btn[data-type="重点"]').classList.add('ring-2', 'ring-primary');
      
      cardModal.classList.remove('hidden');
    }

    // 获取选中内容的HTML
    function getSelectionHtml() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return '';

      const range = selection.getRangeAt(0);
      const div = document.createElement('div');
      div.appendChild(range.cloneContents());
      return div.innerHTML;
    }

    // 打开卡片编辑器
    function openCardEditor(cardId = null) {
      if (cardId) {
        const card = focusCards.find(c => c.id === cardId);
        if (!card) return;
        
        currentCardId = cardId;
        document.getElementById('cardTitle').value = card.title;
        document.getElementById('cardContent').innerHTML = card.content;
        document.getElementById('cardFolderSelect').value = card.folderId || '';
        
        document.querySelectorAll('.card-type-btn').forEach(btn => {
          btn.classList.remove('ring-2', 'ring-primary');
          if (btn.dataset.type === card.type) {
            btn.classList.add('ring-2', 'ring-primary');
          }
        });
      } else {
        currentCardId = null;
        document.getElementById('cardTitle').value = '';
        document.getElementById('cardContent').innerHTML = '';
        document.getElementById('cardFolderSelect').value = '';
        
        document.querySelectorAll('.card-type-btn').forEach(btn => {
          btn.classList.remove('ring-2', 'ring-primary');
        });
        document.querySelector('.card-type-btn[data-type="重点"]').classList.add('ring-2', 'ring-primary');
      }

      cardModal.classList.remove('hidden');
    }

    // 保存卡片
    function saveFocusCard() {
      const title = document.getElementById('cardTitle').value.trim();
      const content = document.getElementById('cardContent').innerHTML.trim();
      const typeBtn = document.querySelector('.card-type-btn.ring-2');
      const folderId = document.getElementById('cardFolderSelect').value;
      
      if (!title || !content || !typeBtn) {
        showNotification('请填写标题和内容，并选择卡片类型', 'info');
        return;
      }

      const type = typeBtn.dataset.type;
      const typeClasses = {
        '重点': 'bg-note-blue text-blue-800',
        '疑问': 'bg-note-yellow text-amber-800',
        '例题': 'bg-note-green text-green-800',
        '易错': 'bg-note-red text-red-800'
      };

      if (currentCardId) {
        const index = focusCards.findIndex(c => c.id === currentCardId);
        if (index !== -1) {
          focusCards[index] = {
            ...focusCards[index],
            title,
            content,
            type,
            typeClass: typeClasses[type],
            folderId: folderId,
            updatedAt: new Date().toISOString()
          };
        }
      } else {
        focusCards.push({
          id: generateUUID(),
          title,
          content,
          type,
          typeClass: typeClasses[type],
          folderId: folderId,
          fromDoc: currentDocId ? docs[currentDocId].title : null,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      }

      saveFocusCards();
      cardModal.classList.add('hidden');
      renderFocusCards();
      showNotification(currentCardId ? '重点卡片已更新' : '重点卡片已添加到复习库', 'success');
    }

    // 移动卡片到文件夹
    function moveCardToFolder() {
      if (!currentCardId) return;

      const selectedFolder = document.querySelector('#folderSelectList > div.ring-2');
      if (!selectedFolder) {
        showNotification('请选择目标文件夹', 'info');
        return;
      }

      const folderId = selectedFolder.dataset.id;
      const cardIndex = focusCards.findIndex(c => c.id === currentCardId);
      
      if (cardIndex !== -1) {
        focusCards[cardIndex].folderId = folderId;
        focusCards[cardIndex].updatedAt = new Date().toISOString();
        saveFocusCards();
        moveCardModal.classList.add('hidden');
        renderFocusCards();
        showNotification('卡片已移动到目标文件夹', 'success');
      }
    }

    // 渲染时间线
    function renderTimeline(timeline) {
      if (!timeline || timeline.length === 0) {
        timelineContainer.innerHTML = `
          <div class="text-gray-500 text-center text-sm py-4">
            点击"时间点"添加课堂关键节点
          </div>
        `;
        return;
      }

      const sorted = [...timeline].sort((a, b) => {
        const timeA = a.time.split(':').reduce((m, s) => m * 60 + parseInt(s), 0);
        const timeB = b.time.split(':').reduce((m, s) => m * 60 + parseInt(s), 0);
        return timeA - timeB;
      });

      let html = '';
      sorted.forEach((item, index) => {
        html += `
          <div class="timeline-item pb-2">
            <div class="font-medium text-purple-600">${item.time}</div>
            <div class="text-gray-700 mt-1">${item.content}</div>
            <button class="text-gray-400 hover:text-red-500 text-xs mt-1 delete-timeline" data-index="${index}">
              <i class="fa fa-times"></i> 删除
            </button>
          </div>
        `;
      });

      timelineContainer.innerHTML = html;

      document.querySelectorAll('.delete-timeline').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          const doc = docs[currentDocId];
          doc.timeline.splice(index, 1);
          saveDoc();
          renderTimeline(doc.timeline);
        });
      });
    }

    // 考研词汇标注
    function highlightPostgradWords() {
      removePostgradHighlights();

      const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
      let node;

      while ((node = walker.nextNode())) {
        if (node.parentNode.classList.contains('postgrad-high') || node.parentNode.classList.contains('postgrad-mid')) {
          continue;
        }

        let text = node.textContent;
        let lastIndex = 0;
        const fragment = document.createDocumentFragment();

        postGradWords.forEach(wordInfo => {
          const regex = new RegExp(`\\b${wordInfo.word}\\b`, 'gi');
          let match;

          while ((match = regex.exec(text)) !== null) {
            fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));

            const span = document.createElement('span');
            span.className = wordInfo.freq === '高频' ? 'postgrad-high' : 'postgrad-mid';
            span.title = `${wordInfo.freq}词：${wordInfo.pos} ${wordInfo.mean}`;
            span.textContent = match[0];
            fragment.appendChild(span);

            detectedWords.add(wordInfo.word.toLowerCase());
            lastIndex = regex.lastIndex;
          }
        });

        fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
        node.parentNode.replaceChild(fragment, node);
      }
    }

    // 移除考研词汇标注
    function removePostgradHighlights() {
      document.querySelectorAll('.postgrad-high, .postgrad-mid').forEach(span => {
        const parent = span.parentNode;
        while (span.firstChild) {
          parent.insertBefore(span.firstChild, span);
        }
        parent.removeChild(span);
      });
    }

    // 更新词汇统计
    function updateWordStats() {
      const highFreq = [];
      const midFreq = [];
      
      postGradWords.forEach(word => {
        if (detectedWords.has(word.word.toLowerCase())) {
          if (word.freq === '高频') highFreq.push(word);
          else midFreq.push(word);
        }
      });

      totalPostgradCount.textContent = detectedWords.size;
      highFreqCount.textContent = highFreq.length;
      midFreqCount.textContent = midFreq.length;
    }

    // 翻译文本（双接口备份）
    async function translateText(text) {
      try {
        // 优先查询考研词汇库
        const postgradWord = postgradWords.find(w => w.word.toLowerCase() === text.toLowerCase());
        if (postgradWord) {
          return {
            mean: postgradWord.pos + ' ' + postgradWord.mean,
            phonetic: '',
            isPostgrad: true,
            freq: postgradWord.freq,
            success: true
          };
        }

        // 尝试百度翻译API
        const response = await fetch(`https://fanyi.baidu.com/sug?kw=${encodeURIComponent(text)}`);
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
          const firstItem = data.data[0];
          return {
            mean: firstItem.v || firstItem.d || "无释义",
            phonetic: '',
            isPostgrad: false,
            success: true
          };
        }
      } catch (error) {
        console.log("百度翻译接口失败，尝试备用接口");
      }

      // 备用：有道翻译API
      try {
        const response = await fetch(`https://aidemo.youdao.com/trans?q=${encodeURIComponent(text)}&from=Auto&to=zh-CHS`);
        const data = await response.json();
        
        if (data.translation && data.translation.length > 0) {
          let phonetic = "";
          if (data.basic && data.basic.phonetic) {
            phonetic = `[${data.basic.phonetic}]`;
          }
          
          let mean = data.translation[0];
          if (data.basic && data.basic.explains) {
            mean = data.basic.explains.join('；');
          }
          
          return {
            mean: mean,
            phonetic: phonetic,
            isPostgrad: false,
            success: true
          };
        }
      } catch (error) {
        console.log("有道翻译接口失败");
      }

      // 所有接口失败
      return {
        mean: "翻译服务暂时不可用，请稍后再试",
        phonetic: "",
        isPostgrad: false,
        success: false
      };
    }

    // 句子翻译（双接口备份）
    async function translateSelectedSentence() {
      const selection = window.getSelection();
      const text = selection.toString().trim();
      if (!text) {
        showNotification('请先选中要翻译的英文句子', 'info');
        return;
      }

      showNotification('正在翻译...', 'info');
      
      // 尝试百度翻译
      try {
        const encodedText = encodeURIComponent(text);
        const response = await fetch(`https://fanyi.baidu.com/transapi?from=en&to=zh&query=${encodedText}`);
        const data = await response.json();
        
        if (data.data && data.data[0] && data.data[0].dst) {
          insertTranslation(data.data[0].dst);
          return;
        }
      } catch (error) {
        console.log("百度句子翻译失败，尝试备用接口");
      }

      // 备用：有道翻译
      try {
        const response = await fetch(`https://aidemo.youdao.com/trans?q=${encodeURIComponent(text)}&from=Auto&to=zh-CHS`);
        const data = await response.json();
        
        if (data.translation && data.translation.length > 0) {
          insertTranslation(data.translation[0]);
          return;
        }
      } catch (error) {
        console.log("有道句子翻译失败");
      }

      // 所有接口失败
      showNotification('翻译服务暂时不可用，请稍后再试', 'info');
    }

    // 插入翻译结果
    function insertTranslation(translation) {
      const selection = window.getSelection();
      const range = selection.getRangeAt(0);
      const div = document.createElement('div');
      div.className = 'translate-result';
      div.innerHTML = `<strong>翻译：</strong>${translation}`;
      range.collapse(false);
      range.insertNode(div);
      range.insertNode(document.createElement('br'));
      showNotification('翻译完成', 'success');
    }

    // 文字转语音功能 - 优化版
    function textToSpeech() {
      const selection = window.getSelection();
      const text = selection.toString().trim();
      
      if (!text) {
        showNotification('请先选中要朗读的内容', 'info');
        return;
      }
      
      // 停止任何正在进行的朗读
      if (currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
      }
      
      // 创建新的语音实例
      currentUtterance = new SpeechSynthesisUtterance(text);
      
      // 应用用户选择的语音
      const selectedVoiceURI = voiceSelect.value;
      if (selectedVoiceURI) {
        const selectedVoice = voices.find(voice => voice.voiceURI === selectedVoiceURI);
        if (selectedVoice) {
          currentUtterance.voice = selectedVoice;
        }
      } else {
        // 自动检测语言并选择合适的默认语音
        const isChinese = /[\u4e00-\u9fa5]/.test(text);
        currentUtterance.lang = isChinese ? 'zh-CN' : 'en-US';
        
        // 尝试找到更自然的语音
        const preferredVoice = voices.find(voice => 
          (isChinese && voice.lang.includes('zh')) || 
          (!isChinese && voice.lang.includes('en'))
        );
        
        if (preferredVoice) {
          currentUtterance.voice = preferredVoice;
        }
      }
      
      // 设置语音属性 - 更贴近真人
      currentUtterance.rate = speechRate; // 语速，用户可调节
      currentUtterance.pitch = 1.1; // 音调略高于默认，更自然
      currentUtterance.volume = 1; // 音量
      
      // 朗读结束时恢复按钮状态
      currentUtterance.onend = () => {
        textToSpeechBtn.classList.remove('hidden');
        stopSpeechBtn.classList.add('hidden');
        currentUtterance = null;
        showNotification('朗读已完成', 'info');
      };
      
      // 开始朗读
      speechSynthesis.speak(currentUtterance);
      
      // 更新按钮状态
      textToSpeechBtn.classList.add('hidden');
      stopSpeechBtn.classList.remove('hidden');
      showNotification('开始朗读...', 'info');
    }
    
    // 停止朗读
    function stopSpeech() {
      if (currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
      }
      
      // 恢复按钮状态
      textToSpeechBtn.classList.remove('hidden');
      stopSpeechBtn.classList.add('hidden');
      showNotification('已停止朗读', 'info');
    }

    // 导出数据
    function exportData() {
      const exportData = {
        docs: docs,
        focusCards: focusCards,
        folders: folders,
        settings: JSON.parse(localStorage.getItem('appSettings')),
        exportTime: new Date().toISOString()
      };
      const jsonData = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `复习笔记数据_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showNotification('数据导出成功，可分享给他人', 'success');
    }

    // 导入数据
    function importData(file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importData = JSON.parse(event.target.result);
          if (importData.docs && importData.focusCards) {
            if (confirm('确定要导入数据吗？现有笔记、卡片和文件夹将被覆盖')) {
              docs = importData.docs;
              focusCards = importData.focusCards;
              folders = importData.folders || [];
              
              // 如果有设置数据也一并导入
              if (importData.settings) {
                localStorage.setItem('appSettings', JSON.stringify(importData.settings));
                loadUserSettings();
              }
              
              saveDocs();
              saveFocusCards();
              saveFolders();
              renderDocsList();
              renderFolders();
              showNotification('数据导入成功', 'success');
            }
          } else {
            showNotification('导入失败，文件格式不正确', 'info');
          }
        } catch (error) {
          showNotification('导入失败，文件内容错误', 'info');
        }
      };
      reader.readAsText(file);
    }

    // 去除HTML标签
    function stripHtml(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || '';
    }

    // 绑定所有事件
    function bindEvents() {
      // 视图切换
      backToDocsBtn.addEventListener('click', showDocsList);
      focusCardsBtn.addEventListener('click', showFocusCards);
      backFromCardsBtn.addEventListener('click', () => {
        currentDocId ? showDocEditor() : showDocsList();
      });

      // 文档操作
      newDocBtn.addEventListener('click', createNewDoc);
      saveDocBtn.addEventListener('click', saveDoc);

      // 文档搜索
      searchDocs.addEventListener('input', debounce(() => {
        const keyword = searchDocs.value.toLowerCase();
        const filteredIds = Object.keys(docs).filter(id => {
          const doc = docs[id];
          return (doc.title && doc.title.toLowerCase().includes(keyword)) ||
                 (doc.content && stripHtml(doc.content).toLowerCase().includes(keyword));
        });

        if (filteredIds.length === 0) {
          docsList.innerHTML = `
            <div class="p-8 text-center text-gray-500">
              <i class="fa fa-search text-4xl mb-4 text-gray-300"></i>
              <p>没有找到匹配的文档</p>
            </div>
          `;
          return;
        }

        let html = '';
        filteredIds.forEach(id => {
          const doc = docs[id];
          const date = new Date(doc.updatedAt).toLocaleString();
          html += `
            <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer doc-item" data-id="${id}">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-medium text-gray-800">${doc.title || '无标题文档'}</h3>
                  <p class="text-sm text-gray-500 mt-1">最后编辑：${date}</p>
                </div>
                <button class="text-red-500 hover:text-red-700 delete-doc" data-id="${id}">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        });

        docsList.innerHTML = html;
      }, 300));

      // 卡片搜索和筛选
      searchCards.addEventListener('input', debounce(() => {
        const filter = document.querySelector('.note-tag[data-filter].ring-2')?.dataset.filter || 'all';
        renderFocusCards(filter, searchCards.value);
      }, 300));

      document.querySelectorAll('.note-tag[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.note-tag[data-filter]').forEach(b => {
            b.classList.remove('ring-2', 'ring-primary');
          });
          btn.classList.add('ring-2', 'ring-primary');
          renderFocusCards(btn.dataset.filter, searchCards.value);
        });
      });

      // 笔记标签
      document.querySelectorAll('.note-tag[data-tag]').forEach(btn => {
        btn.addEventListener('click', () => {
          addNoteTag(btn.dataset.tag);
        });
      });

      // 重点卡片
      addFocusCardBtn.addEventListener('click', createFocusCardFromSelection);
      document.getElementById('cancelCard').addEventListener('click', () => {
        cardModal.classList.add('hidden');
      });
      document.getElementById('confirmCard').addEventListener('click', saveFocusCard);
      
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.card-type-btn').forEach(b => {
            b.classList.remove('ring-2', 'ring-primary');
          });
          btn.classList.add('ring-2', 'ring-primary');
        });
      });

      // 时间线
      addTimelineBtn.addEventListener('click', () => {
        if (!currentDocId) return;
        document.getElementById('timelineTime').value = '';
        document.getElementById('timelineContent').value = '';
        timelineModal.classList.remove('hidden');
        document.getElementById('timelineTime').focus();
      });
      
      document.getElementById('cancelTimeline').addEventListener('click', () => {
        timelineModal.classList.add('hidden');
      });
      
      document.getElementById('confirmTimeline').addEventListener('click', () => {
        const time = document.getElementById('timelineTime').value.trim();
        const content = document.getElementById('timelineContent').value.trim();
        if (!time || !content) {
          showNotification('请填写时间和内容', 'info');
          return;
        }

        const doc = docs[currentDocId];
        if (!doc.timeline) doc.timeline = [];
        doc.timeline.push({ time, content });
        saveDoc();
        renderTimeline(doc.timeline);
        timelineModal.classList.add('hidden');
      });

      // 编辑器自动保存
      editor.addEventListener('input', debounce(() => {
        if (autoSaveToggle.checked) {
          saveDoc();
        }
        if (isPostGradHighlightEnabled) {
          highlightPostgradWords();
          updateWordStats();
        }
      }, 2000));
      docTitle.addEventListener('blur', () => {
        if (autoSaveToggle.checked) {
          saveDoc();
        }
      });

      // 考研词汇开关
      togglePostGradWords.addEventListener('click', () => {
        isPostGradHighlightEnabled = !isPostGradHighlightEnabled;
        autoHighlightToggle.checked = isPostGradHighlightEnabled;
        postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
        saveUserSettings();
      });

      // 翻译开关
      translateToggleBtn.addEventListener('click', () => {
        isTranslateEnabled = !isTranslateEnabled;
        autoTranslateToggle.checked = isTranslateEnabled;
        translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
        saveUserSettings();
      });

      // 单词/短语翻译
      editor.addEventListener('mouseup', debounce(async () => {
        if (!isTranslateEnabled) return;
        
        const selection = window.getSelection();
        const text = selection.toString().trim();
        if (!text) {
          translatePopup.style.display = 'none';
          return;
        }

        const transData = await translateText(text);
        
        document.getElementById('popupSource').textContent = text;
        document.getElementById('popupPhonetic').textContent = transData.phonetic;
        document.getElementById('popupExplains').textContent = transData.mean;
        document.getElementById('popupPostgradNote').textContent = transData.isPostgrad ? `考研${transData.freq}词` : '';
        document.getElementById('popupType').textContent = text.includes(' ') ? '短语翻译' : '单词翻译';
        
        const rect = selection.getRangeAt(0).getBoundingClientRect();
        const editorRect = editor.getBoundingClientRect();
        translatePopup.style.left = `${rect.left - editorRect.left + editor.scrollLeft}px`;
        translatePopup.style.top = `${rect.bottom - editorRect.top + editor.scrollTop + 10}px`;
        translatePopup.style.display = 'block';
      }, 300));

      // 一键翻译句子
      translateSentenceBtn.addEventListener('click', translateSelectedSentence);

      // 关闭翻译弹窗
      document.addEventListener('click', (e) => {
        if (!translatePopup.contains(e.target) && e.target !== editor) {
          translatePopup.style.display = 'none';
        }
      });

      // 文本格式化
      document.querySelectorAll('[data-command]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.execCommand(btn.dataset.command, false, null);
          editor.focus();
        });
      });

      // 文字转语音
      textToSpeechBtn.addEventListener('click', textToSpeech);
      stopSpeechBtn.addEventListener('click', stopSpeech);
      speechRateSlider.addEventListener('input', () => {
        speechRate = parseFloat(speechRateSlider.value);
        // 如果正在朗读，实时更新语速
        if (currentUtterance) {
          currentUtterance.rate = speechRate;
        }
        saveUserSettings();
      });

      // 导出数据
      exportDataBtn.addEventListener('click', exportData);

      // 导入数据
      importDataBtn.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
          showNotification('请导入JSON格式的文件', 'info');
          return;
        }

        importData(file);
        e.target.value = '';
      });

      // 文件夹相关事件
      addFolderBtn.addEventListener('click', () => {
        folderName.value = '';
        folderModal.classList.remove('hidden');
        folderName.focus();
      });

      cancelFolder.addEventListener('click', () => {
        folderModal.classList.add('hidden');
      });

      confirmFolder.addEventListener('click', createFolder);

      // 移动卡片相关事件
      cancelMoveCard.addEventListener('click', () => {
        moveCardModal.classList.add('hidden');
      });

      confirmMoveCard.addEventListener('click', moveCardToFolder);
      
      // 界面设置相关事件
      settingsBtn.addEventListener('click', () => {
        settingsPanel.classList.add('open');
      });
      
      closeSettingsBtn.addEventListener('click', () => {
        settingsPanel.classList.remove('open');
      });
      
      // 主题切换
      themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) {
          document.documentElement.classList.add('dark-mode');
        } else {
          document.documentElement.classList.remove('dark-mode');
        }
        saveUserSettings();
      });
      
      // 字体大小选择
      fontSizeOptions.forEach(option => {
        option.addEventListener('click', () => {
          fontSizeOptions.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          
          document.documentElement.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl');
          document.documentElement.classList.add(`font-size-${option.dataset.size}`);
          
          saveUserSettings();
        });
      });
      
      // 自动保存切换
      autoSaveToggle.addEventListener('change', saveUserSettings);
      autoTranslateToggle.addEventListener('change', () => {
        isTranslateEnabled = autoTranslateToggle.checked;
        translateStatus.textContent = `翻译：${isTranslateEnabled ? '开启（单词/句子）' : '关闭'}`;
        saveUserSettings();
      });
      autoHighlightToggle.addEventListener('change', () => {
        isPostGradHighlightEnabled = autoHighlightToggle.checked;
        postgradStatus.textContent = `自动标注：${isPostGradHighlightEnabled ? '开启' : '关闭'}`;
        saveUserSettings();
      });
    }

    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // 启动应用
    init();
  </script>
</body>
</html>
